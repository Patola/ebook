[#guia-maker-da-impressao-3d-tecnologiafff]
= A Tecnologia FFF
:imagesdir: imagens
:imagesoutdir: img

A tecnologia que chegou à popularização em nossos dias foi a patenteada por S. Scott Crump. Há vários motivos
para isso: é razoavelmente fácil construir uma máquina (hoje em dia, ainda mais com as receitas do projeto reprap);
e o material é barato e relativamente fácil de encontrar -- plástico está em todo o nosso dia-a-dia. Tê-lo em
forma de filamento enrolado em um carretel é questão apenas de o passar por uma máquina também barata chamada
de filamentadora ou extrusora. O processo de derretimento do plástico pode ser entendido com o seguinte diagrama:

[[explicacaofff]]
image::explicacaofff.png[explicacaofff,width=506,height=454,align="center"]

Este é o núcleo comum da tecnologia; no entanto, após a queda da patente da Stratasys em 2009, o mercado
mudou. As impressoras passaram disso:

[[fdmindustrialprereprap]]
image::fdmindustrialprereprap.png[fdmindustrialprereprap,width=316,height=292,align="center",title="Impressora FDM Fortus 900 da Stratasys (créditos: Stratasys.com)"]

para isso:

[[diversasimpressoras3d]]
image::diversasimpressoras3d.png[diversasimpressoras3d,width=1384,height=727,align="center",title="Diversas impressoras 3D nacionais e estrangeiras, de variados design, desde as cartesianas abertas e fechadas até deltas (ou deltabots), SCARA e polar"]

O que mudou, neste caso? E se mudou tanto, o que as impressoras da segunda ilustração têm em comum? Para
responder isso, vamos separar as impressoras 3D em suas partes componentes:

== Estrutura
É a parte mais visível, o que dá a forma a impressora. Ainda que possa haver
variações, de forma geral entram nas seguintes categorias principais:

.Enclausuramento
[width="100%",cols="^1s,^2m,2e",frame="topbot",options="header"]
|====
| Tipo		| Exemplo					| Descrição
| Aberta 	| image:image61.png[image,width=141,height=189,align="center"]	| É possível alcançar a peça impressa diretamente.
| Fechada	| image:image62.png[image,width=158,height=158,align="center"]	| A peça fica em uma câmara interna.
|====

.Material

* *MDF* (Medium Density Fibreboard, ou Painel de Fibra de Média Densidade):
Popular nas variantes de _Graber i3_ vendidas no Brasil, o MDF é um compósito baseado em madeira que se assemelha
a compensados, mas é menos resistente, mais liso e consistente e facilmente cortável em CNCs laser e mecânicas,
além de empenar menos. Também é eficaz em dissipar pequenas vibrações das estruturas. Por outro lado, absorve
umidade facilmente e não resiste muito a chamas (apesar de resistir a altas temperaturas). É fácil de usar para
montagens e o mais barato dentre as alternativas listadas, sendo encontrado nas repraps na variedade de 6mm de
espessura. Para se revestir ou pintar, deve-se antes usar um _primer_ baseado em óleo que não seja aerossol/spray.
* *Acrílico* (PMMA): Disputando em popularidade com o MDF como o material de escolha dos cortes de __reprap__,
tem em comum o fato de ser facilmente cortável em CNCs, aparência brilhante com cores vivas e esteticamente
agradável, rigidez considerável e limpeza fácil. O primeiro ponto negativo é que com a alta rigidez o material
é relativamente quebradiço e é especialmente propenso a rachaduras com fixação de parafusos. O segundo é que,
sendo um termoplástico, tem baixa resistência a altas temperaturas, tendo a temperatura de transição vítrea em
torno de 105°C. É mais caro que o MDF, com o mesmo corte deste material e na mesma espessura saindo cerca de 3 vezes
mais caro.
* **Alumínio**: Material resistente, não-ferromagnético (não é atraído por ímãs) e com cortes que
permanecem bastante retilíneos, é mais raramente encontrado em cortes de repraps e, quando encontrado, adaptado para
espessura mais fina (como 3mm) para economia em material. É mais usado em elementos usinados como perfis e blocos
aquecedores. Tem alto coeficiente de condução de calor, o que pode ser indesejável se tiver contato com altas
temperaturas.
** Aço: Usado em impressoras 3D de cunho mais industrial, geralmente de frame fechado e que precisam
aguentar altíssimas temperaturas, é encontrado na variedade inoxidável e escovado para resistir também a oxidação
e agentes do ambiente. Tem baixo coeficiente de condução de calor.
* *ACM* (Aluminium Composite Material): também
conhecido pelo seu nome comercial DIBOND®, se trata do termoplástico polietileno ensanduichado entre duas placas de
alumínio, juntando as propriedades desejáveis do metal com a do plástico. É um material bastante usado em placas
de sinalização e a utilização em impressoras 3D é bem representada pelas máquinas Ultimaker 2 e Ultimaker 3.

.Arranjo Mecânico e Cinemática

.Transformações de eixos.
[width="100%",cols="^1s,^2m,2e",frame="topbot",options="header"]
|====
| Tipo		| Exemplo								| Descrição
| Cartesiana	a| image:image54.jpeg[image,width=599,height=648,align="center"]			| [small]##Eixos X, Y e Z correspondem ao plano cartesiano.##
| Delta		a| image:image57.png[image,width=308,height=640,align="center"]				| [small]##X, Y e Z são transformadas trigonométricas das posições dos três pilares (colunas verticais).##
| CoreXY 	a| image:reprapxy-pequeno.jpg[reprapxypequeno,width=533,height=400,align="center"]	| [small]##X e Y são transformadas lineares de acordo com o padrão "CoreXY" de deslocamento. Por ser uma transformação relativamente simples de coordenadas, informalmente costuma ser tratada como cartesiana.##
| SCARA		a| image:scara.png[scara,width=601,height=710,align="center"]				| [small]##**S**elective **C**ompliance **A**rticulated **R**obot **A**rm, ou Braço Robótico Articulado de Conformidade Seletiva, é o nome dessa transformação de eixos comumente usada em máquinas industriais "pick and place" e de linha de montagem de veículos.##
| Polar		a| image:polartheta.png[polartheta,width=466,height=385,align="center"]			| [small]##Coordenadas polares, ou seja, baseadas em ângulos, são populares nos campos matemáticos, mas em impressoras 3D não são muito práticos, servindo mais como prova de conceito. Alguns modelos de impressora têm apenas um ou dois eixos polares, e os restantes cartesianos.##
|====

Apesar de separarmos as impressoras 3D de mercado nessas cinco categorias, a verdade é que existem tantos sistemas
diferentes e tão promissores que é impossível fazer justiça citando todos,
menos ainda os explicando. Ao invés disso, focalizaremos no que é mais usado hoje. O estilo __delta__, um sistema já antigo e usado em algumas máquinas
pick-and-place de indústrias de equipamentos pesados e fabricantes de circuitos impressos, ganhou tração no
ecossistema RepRap depois que Johan C. Rocholl, um funcionário alemão do Google, criou o design da impressora
intitulada de _Rostock_ em 2012, utilizando peças convencionais já usadas em impressora anteriores, como
rolamentos lineares LM8UU e barras lisas. Tendo um grande volume de impressão para a época (200 mm x 200 mm x
400 mm), a impressora ganhou vários redesenhos e variações, um deles do próprio Johan, chamado de
__Kossel__.

A Kossel abandonava as guias lineares e passava a usar extrusões de alumínio com _patins_ usinados,
peças mais caras e industriais porém com muito maior precisão, e também abandonava os cortes de MDF para adotar
apenas peças impressas. Ambos os designs guiaram o mercado de deltas, menos numeroso que o das cartesianas mas
crescendo a cada dia. Nem toda impressora delta usa postes fixos para guiar a impressão, alguns designs como o da
reprap _Gus Simpson_ usam de braços articulados.

O design dessas impressoras não permite mapear diretamente
uma posição do mecanismo para uma coordenada do objeto a ser impresso, mas é possível calcular a posição
do bico extrusor obtendo-se a coordenada de cada patim nas torres de sustentação -- torres chamadas de "A,
B e C" - e efetuar um cálculo matemático, baseado nas medidas da estrutura da impressora (como a altura das
torres, a mediana entre elas e outros), que resulta em coordenadas X, Y e Z "virtuais", por onde orienta-se o
extrusor a seguir como em uma impressora cartesiana comum. Esses cálculos são efetuados no mesmo microcontrolador
(ou microprocessador) que controla os motores da impressora, no momento da leitura do g-code que é sempre escrito
em coordenadas X,Y e Z.

Uma diferença notável das coordenadas virtuais X, Y e Z de uma impressora delta em relação a cartesianas é que
o ponto (0,0,0) do volume está no centro da impressora, com possibilidade de coordenadas negativas; em contraste,
nas cartesianas o ponto (0,0,0) situa-se no vértice abaixo, à esquerda e à frente, estando-se de frente para
a impressora.

Algumas das vantagens de impressoras delta sobre as cartesianas são:

* *Maior velocidade, especialmente no eixo Z* - Como impressoras delta não utilizam barras roscadas ou fusos e todos os pilares têm
correias com pinhões que traduzem o movimento de cada motor para um movimento bastante rápido na posição. Isso
resulta em velocidades de movimentação que podem chegar a 3 vezes o equivalente a impressoras 3D cartesianas de
construção equivalente. A velocidade muito maior no eixo Z em especial permite que a impressora use o "Z hop"
(ver capítulo de configurações de fatiamento) sem adicionar muito tempo à impressão.
* *Mesa fixa* -- como
todo o movimento do extrusor está nos pilares, não é necessário movimento adicional da mesa na impressão. Isso
dá às deltas uma boa vantagem em estabilidade de impressão especialmente para peças altas, finas e delicadas,
que poderiam sofrer perturbações elásticas pelo movimento da mesa.

Mas, claro, nem tudo são flores. Era
de se esperar, como qualquer assunto em engenharia, que as vantagens também vêm acompanhadas de respectivas
desvantagens:

* **Menos possibilidade de carga no effector**, até como consequências de os motores serem mais
rápidos, pois como em marchas de um carro, maior velocidade tem menos força. Isso implica em algumas restrições
de projeto para remover o máximo possível de peso do effector, como utilizar filamento guiado ao invés de extrusor
direto. Isso também minimiza a inércia da impressora, no entanto, dando-lhe boa precisão.
* *Baixa resolução de posicionamento, especialmente nos extremos* -- como as coordenadas X, Y e Z são calculadas, "virtuais"
através das posições dos braços, o espaçamento entre elas não apresenta a regularidade de coordenadas
reais, sendo muito menor (e portanto com maior resolução) perto da mediana das distâncias dos postes e maior
(e portanto com menor resolução) perto das "quinas" onde estão os postes.
* *Troca de volume horizontal por volume vertical* -- o fato de uma impressora delta ter somente os pilares como estruturas laterais dá a essas
impressoras a vantagem de ocuparem pequena área horizontal, cabendo facilmente em uma mesa ou móvel; entretanto,
esta mesma vantagem faz com que haja um espaço vazio não utilizado na parte de cima da impressora, o que faz com
que seja bastate alta. O espaço não é utilizado porque o volume útil da impressora não se traduz em um cubo,
nem mesmo em um cilindro, mas em um cilindro que nas coordenadas mais altas transforma em um cone, que é onde os
braços conseguirão alcançar. Alguns fabricantes utilizam este espaço para prender componentes, como a fonte,
o tracionador ou até o filamento.
* *Lentidão em algumas operações* -- as impressoras reprap são, em sua
maioria, baseadas em um microcontrolador open-source __Arduino Mega__, que embora tenha em seus 16 MHz velocidade
mais que suficiente para guiar os três eixos e temperaturas de uma impressão comum, não tem circuito dedicado
para operações com ponto flutuante - fazendo cada operação matemática de transformação de coordenadas
de forma não muito eficiente, por software. Isso torna-se visível quando a delta tem um display LCD, que com o compartilhamento
de tempo entre os cálculos no momento em que a impressora imprime, fica com respostas visivelmente lentas para
interação com o usuário. Isso é um problema que vem sendo resolvido naturalmente com a substituição do
Arduino Mega por controladores mais potentes.

[[deltasesimpson]]
image::deltasesimpson.png[deltasesimpson,width=594,height=291,align="center",title="Algumas delta robots do projeto reprap. 1: Kossel. 2: Rostock. 3: GUS Simpson. Créditos: reprap.org"]

.Os outros mecanismos
* *XY (Dualwire Gantry)*
+
O jeito mais intuitivo de pensar em um mecanismo que, em um plano, possa posicionar um
elemento em uma coordenada (X,Y) determinada é haver, assim com os dois eixos, dois mecanismos (motores) fixos,
independentes e perpendiculares. Qualquer um deles, ao girar, move uma correia, que movimenta o elemento em seu
eixo, guiado em torno de uma barra lisa; as correias e barras não se encontram e podem ser posicionadas uma
acima da outra com o suporte do elemento ocupando onde se cruzem. O nome significa algo como "pórtico com
dois cabos".

[[dualwiregantry]]
image::dualwiregantry.png[dualwiregantry,width=594,height=351,align="center",title=""Dualwire Gantry" da Ulticampy V2 (créditos: ulticampy.com)"]

* *CoreXY*
+
O sistema batizado
de _CoreXY_ tornou-se popular por um sítio web^3^ que o explica em pormenores e ensina como construí-lo e
controlá-lo. Basicamente é um sistema de eixos que permite controle fino dos eixos X e Y mas economizando em
peças e evitando o cruzamento de eixos rígidos que acontece no __Dualwire Gantry__. É um sistema robusto,
com cinemática paralela e motores fixos na estrutura, controle fácil e permitindo grandes velocidades de
movimentação, tendo sido adotado em várias reprap e impressoras 3D comerciais de estrutura fechada.

[[desenhocorexy]]
image::desenhocorexy.jpeg[desenhocorexy,width=531,height=406,align="center",title="Uma placa de alumínio com sistema CoreXY construído em guias para suportar grandes cargas. Créditos: corexy.com"]

Como no caso das deltas, as impressoras 3D com
CoreXY exigem que o firmware tenha conhecimento do sistema de eixos pois transformações de deslocamentos são
necessárias para o acionamento correto dos motores e a localização das coordenadas no espaço. O profissional
André Ruiz colaborou com esta obra com um diagrama elucidativo e bastante útil para aqueles que desejam construir
uma impressora deste tipo, a seguir:

[[corexyandreruiz]]
image::corexyandreruiz.png[corexyandreruiz,width=594,height=404,align="center",title="Regras para o arranjo de eixos de CoreXY, ilustração e texto criados por André Ruiz - andre.ruiz@gmail.com. A observação dele sobre inverter direções é que embora inverter o motor exija a rotação física deste em 180°, inverter a direção em que seu pinhão gira consiste de um expediente muito fácil de executar, que pode tanto ser feito conectando o motor ao contrário nos 4 pinos da placa quanto por um “flag” no firmware."]

* *Outras XY e variantes* +
Mais do que popularizar a cinemática do CoreXY, o sítio web de mesmo nome levantou a consciência que
sistemas de eixos e cinemáticas podem ser aperfeiçoados e otimizados para vários tipos de construções. Muitos
outros surgiram ou vieram à tona, alguns sendo variações do próprio CoreXY (__H.Bot__, __cantilevered CoreXY__,
__CoreXZ__, etc.). ^4^
* *Carro X estilo Mendel i2* +
Se por um lado os sistemas de cinemática paralela como
o _dualwire gantry_ e o _CoreXY_ representam a sofisticação de movimentação em impressoras 3D cartesianas,
por outro lado exigem uma estrutura bastante rígida e com muitos pontos de fixação para funcionar adequadamente,
tornando montagem e manutenção caras. A diretiva de economia do projeto reprap acabou levando a um arranjo mecânico
bem distinto; embora inicialmente usassem dualwire gantry no primeiro modelo (darwin / rapman), modelos distintos
de voluntários como a Prusa Mendel facilitaram enormemente o processo de peças e montagem com seu arranjo de
eixos, que se traduz em:
** Uma mesa móvel (eixo Y);
** Duas guias lineares paralelas na horizontal para o eixo X
(o chamado carro X);
** Eixo Z (vertical) representado por barras roscadas subindo e descendo o carro X, com guias
lineares paralelas às barras roscadas garantindo movimento retilíneo. Isso faz o eixo Z ser mais lento que X e Y,
o que é desprezível visto que é o eixo que menos se movimenta durante uma impressão;
** Dois motores para o eixo
Z, para evitar desnível e distribuir a força.
+
[[prusamendelcomcarrox]]
image::prusamendelcomcarrox.jpeg[prusamendelcomcarrox,width=570,height=660,align="center",title="Prusa Mendel, com carro X horizontal, dois motores no eixo Z e mesa móvel em Y (reprap.org)"]
+
* *Carro X estilo Prusa i3* +
Com a iteração 3 do design de Josef Prusa, duas alterações foram feitas no arranjo
mecânico e ficaram tão populares que muitas repraps copiaram:
** Os dois motores do eixo Z passaram da parte de
cima do quadro para a parte de baixo. Isso abaixou o ponto de massa da impressora 3D (visto que motores são pesados)
e a deixou mais estável. O ponto negativo disso é que barras roscadas desgastam menos com forças de tração
do que compressão, então no eixo Z perdeu-se um pouco na vida útil dessas vitaminas.
** O carro X teve suas
guias lineares (barras lisas) trocadas de paralelas no plano horizontal para paralelas no plano vertical. Isso
foi uma melhoria na estabilidade da impressora 3D porque o carro X se prende ao eixo Z, que é muito curto na
dimensão Y e portanto não dá tanta estabilidade ao carro; fazendo o carro ser mais longo no eixo Z se aproveita
da linearidade e estabilidade do arranjo de X com Z.
+
[[prusai3motoresbaixo]]
image::prusai3motoresbaixo.jpeg[prusai3motoresbaixo,width=531,height=630,align="center",title="Prusa i3, com motores abaixo e carro X vertical"]

Muitos outros arranjos mecânicos existem, é claro. Os citados aqui, entretanto, acomodam a grande maioria dos
casos das impressoras 3D FFF de mercado e dão uma boa noção da cinemática das impressoras.

.Movimentação da Mesa
A movimentação da mesa de impressão -- aquecida ou sem aquecimento -- é o complemento à movimentação
dos eixos. Alguns dos sistemas vistos resolvem parte do problema da localização do componente extrusor em um
espaço tridimensional; os arranjos CoreXY e Dualwire Gantry o situam em um plano horizontal; o carro X das prusas
se conjuga com um eixo Z lento para o posicionamento em um plano vertical; em cada um dos casos, só faltou a
análise do eixo remanescente.

* *Mesa fixa* +
Uma impressora 3D com mesa fixa à primeira vista parece ser o caso ideal, afinal, quem quer
uma peça sendo submetida a movimentos que tirem sua estabilidade enquanto é fabricada? Entretanto, isso
traz complicações, a maior delas é poder precisar de motores e um mecanismo que se movam para cima durante a
fabricação. Um conjunto desses é inevitavelmente pesado, e precisará não só de peças robustas como encaixes
precisos para subir em perfeito equilíbrio. Com o peso ascendente, outro problema que surge é o centro de massa
da impressora 3D sofrer deslocamento, e isso ser fonte de vibrações e imprecisões estruturais que afetam a
qualidade da peça e a sobrevida do mecanismo. +
A construção em delta consegue evitar dois desses problemas:
fixa os motores na base e permite que o centro de massa da impressora 3D se desloque relativamente menos, visto
que o conjunto de braços e _effector_ é, por construção, mais leve. No entanto, a altura extra exigida para
essa construção é uma nova fonte de vibrações. Pequenas folgas de encaixe são ampliadas pelo comprimento,
o torque das forças laterais torna-se significativo e fonte de vibrações e a estrutura passa a ter necessidade
de mais e mais reforços. Via de regra, se uma impressora 3D delta passa de 40cm de altura, suas estruturas --
que veremos em seguida -- devem ser trocadas de extrusões 1515 pra 2020 ou maiores. +
As estruturas com mesa
fixa, no entanto, apesar dessas dificuldades, estão entre as melhores para escalas grandes de impressão. Isso
porque os extrusores ou effectors serão ampliados em função da área, enquanto que o peso sustentado pela mesa
cresce mais rápido - de acordo com o volume. Se uma impressora 3D com volume de impressão 10 cm x 10 cm x 10
cm precisa sustentar um peso máximo de 1,04 kg de ABS, uma de volume de impressão 10 vezes maior de cada lado,
ou seja, 1m x 1m x 1m teria um extrusor 100 vezes mais pesado -- para um peso sobre a mesa _mil vezes_ maior
(1.040 kg).
* *Mesa com movimento linear horizontal* +
Usada nas _Prusa_ como eixo Y, o movimento horizontal,
como no eixo Z, é sustentado por guias lineares (barras lisas com rolamentos) mas movido por correias de um motor
para velocidade. Nas escalas em que as impressoras 3D com essa construção são usadas -- cerca de 200x200x200mm
de volume de construção, e 60 mm/s de velocidade máxima nos eixos horizontais -- o movimento de vaivém da
mesa não chega a apresentar artefatos notáveis no processo de impressão 3D. Mas em se aumentando a escala,
e principalmente a velocidade, a estabilidade da peça impressa gradualmente diminuirá. Aceleração e jerk, a
serem explicados na seção sobre firmware, terão grande influência na qualidade da peça neste caso.
* *Mesa com movimento linear vertical (cantilevered)* +
No caso em que a mesa tem movimento vertical (eixo Z), topamos
com um problema de engenharia e arquitetura chamado de _cantilever_ ou __estrutura em consola__. O problema,
que tem desdobramentos e complexidades que fogem ao escopo deste livro, consiste em conseguirmos dar estabilidade
estrutural e dimensional para uma estrutura planar horizontal sustentada por um suporte vertical. Estando a borda
a estrutura horizontal suficientemente distante do ponto de apoio vertical, o _torque_ desta estrutura começa
a ter influência, o coeficiente de elasticidade do material começa a poder apresentar deformações visíveis
e pequenas folgas nos encaixes dos eixos se traduzirão em distâncias discerníveis perto das bordas. Isso traz
uma série de requisitos para a construção das mesas: o suporte delas precisará ser de material o mais rígido
possível (com baixo módulo de Young - "grau de elasticidade"), bem equilibrado (geralmente exigindo pelo
menos duas cantoneiras para sustentação) e com encaixes precisos -- barras roscadas não podem ser usadas,
serão necessários fusos trapezoidas ou de esferas para tracionar este eixo.
* **Mesa com movimento planar ou tridimensional** +
Podendo ser considerada mais uma curiosidade que um caso prático, existem impressoras que usam
o elemento extrusor completamente fixo enquanto a mesa se move, ou aqueles em que o extrusor se move na vertical
enquanto a mesa se move na horizontal. Nesses casos o extrusor sustenta um peso relativamente grande para o
volume da impressora e a velocidade de impressão não é muito grande, não afetando portanto a estabilidade da
impressão. Isso pode acontecer, por exemplo, em impressoras 3D que tenham extrusor intercambiável, com extrusores
de pasta de chocolate e outras peças pesadas podendo ser encaixadas. Pela própria natureza, essas impressoras
3D têm estrutura aberta.

.Mais de 3 eixos

A idéia parece absurda de início -- só existem três dimensões, como se pode ter mais de 3 eixos? O arranjo,
mais usado em CNCs para tentar amenizar as restrições geométricas das técnicas subtrativas, não consiste
em realizar viagens fantásticas para a quarta ou quinta dimensão, e sim em inserir elementos de _rotação_
na estrutura -- no extrusor ou na mesa -- para que o plástico derretido possa ser depositado em ângulos
diferentes. Isso é importante por dois motivos:

* Diminui o "efeito escada" visto na vertical devido à resolução limitada (altura de camada) da impressora 3D,
permitindo a fabricação de estruturas tridimensionais suaves seguindo o contorno da forma, ao invés de aproximando
por camadas;
* Minimiza a necessidade de **suportes**, que como veremos adiante, são estruturas de sustentação
necessárias pelo fato de a construção sempre se dar "de baixo para cima" na peça. Se estiver construindo uma
miniatura de Cristo Redentor, você pode primeiro construir todo o corpo, girar a peça e então construir os braços.

Impressoras 3D FFF desse tipo ainda são experimentais e estão aparecendo tanto no mercado mais industrial quanto
no open-source. Na verdade, a construção mecânica de um aparato desses, ainda que seja um desafio considerável
de engenharia, é a parte mais simples. A parte mais complexa é o algoritmo de fatiamento -- traçar a trajetória
destes 5 eixos para ter a forma mais suave e harmônica possível.

[[reprap5eixos]]
image::reprap5eixos.jpeg[reprap5eixos,width=508,height=627,align="center",title="mpressora 3D Open-Source de 5 eixos; os dois eixos adicionais são os eixos de rotação da mesa. Créditos: Universidade de Oslo. Artigo original em http://www.3ders.org/articles/20150704-an-amazing-open-source-5-axis-3d-printer-built-by-university-of-oslo-master-student.html"]

== "Vitaminas" comuns da estrutura de uma impressora 3D

* *Parafusos e derivados* +
*Parafuso* é uma peça que transforma um movimento de rotação em torno de seu eixo
em um movimento de translação segundo esse eixo, servindo assim como um elemento de fixação. Uma *porca* é um
elemento de auxílio à fixação do parafuso, se moldando perfeitamente a ele para realizar a fixação. *Arruela*
ou *anilha* é um disco furado a ser usado em um parafuso como separador ou travamento. Sendo as estruturas
supostamente mais simples de uma impressora 3D, o universo dessas peças e seus relacionados é vasto e variado
e por infelicidade do acaso, os modelos utilizados em impressoras 3D são relativamente raros de se encontrar no
Brasil e quando encontrados, são em pequena variedade. A primeira dificuldade é que apesar de o país adotar
oficialmente o sistema internacional ou métrico, os parafusos métricos (com denominação iniciando por "M"
seguido do diâmetro do corpo em milímetros) são menos numerosos no mercado. Além disso, os parafusos de máquina
(ou seja, com a ponta cega) também são mais raros, especialmente das medidas mais frequentes nas impressoras 3D
domésticas ("M3" a "M5", ou de 3mm de diâmetro a 5mm de diâmetro), agravado por a maioria das receitas
de construção e impressoras comercializadas precisarem de tamanhos bem específicos de parafusos (variando de
6 a 60mm de comprimento). +
As especificações dos parafusos são geralmente dadas pelo modelo -- e às vezes
o material -- seguido da cabeça (formato e encaixe), o diâmetro e o comprimento, não necessariamente nessa
ordem. Assim, um "parafuso de máquina inox allen com cabeça chata M3x16" ou "parafuso auto-atarraxante de
fenda philips de cabeça panela M4x40 de bronze" são denominações comuns. Arruelas e porcas +
Apesar de não ser
do escopo deste livro entrar detalhadamente na logística e tipos dos parafusos, algumas colocações gerais são
úteis para o leitor saber como os escolher para construir sua impressora ou consertar ou aprimorar a sua atual:
** *Existem muitos tipos de sulcos.* Nas impressoras 3D, os três tipos mais usados são __fenda__, _philips_
e _allen_ (hexagonal). Existem ainda os parafusos sem sulco, os usados com chave de boca (cabeça hexagonal),
mas muito pouco usados nas impressoras 3D.
+
[[sulcosparafusos]]
image::sulcosparafusos.png[sulcosparafusos,width=642,height=346,align="center",title="À esquerda: parafuso-mosca sendo apertado em um acoplador de alumínio flexível que junta o pino do motor a uma barra roscada em uma impressora Graber i3. No meio: o canto de uma mesa de impressão com porca-borboleta, entre os clipes metálicos para fixação do vidro.. Outra porca se encontra em um parafuso em cima da mesa. À direita: padrões de sulcos comumente encontrados no mercado. (a) Fenda, (b) Chave Phillips ou Chave Estrela, (c) Pozidriv, (d) Torx, (e) Allen, (f) Robertson, (g) Tri-Wing, (h) Torq-Set, (i) Spanner. Fonte: wikipedia"]
+
** **O sulco não necessariamente define a cabeça**. Por exemplo, embora seja comum parafusos allen virem em cabeças
cilíndricas, isso não é sempre verdade. Cabeças cônicas em especial podem vir a trincar ou danificar certos
materiais que são feitas algumas impressoras, como acrílico ou MDF. Na dúvida, compre somente os de cabeças
cilíndricas.
** *Parafusos pretos* são assim por usarem um tipo de aço mais resistente a tração. Aconselhados
para encaixes que precisarão de bastante força de sustentação, mas desaconselhados para encaixes que podem
"espanar" ou danificar o material circundante, como o MDF. Os parafusos mais comuns nesse material são
os tipo __allen__.
** **Porcas auto-travantes (nyloc) podem ser bastante úteis**. Tais porcas são geralmente
hexagonais e com uma "entrada" onde há o sulco de encaixe e uma "saída" onde um anel de nylon exerce
a função de elemento de atrito para impedir que a porca continue deslizando em torno do parafuso. São muitas
vezes usadas como terminadores de parafusos tratores ou para fixar estruturas sujeitas a vibração, pela sua
capacidade de amortecimento.
** *Porcas-borboleta* têm "asas" ou "abas" que permitem rosqueamento com os
dedos em torno do parafuso. São usadas em peças de impressora que podem necessitar de ajuste constante, como a
fixação e nivelamento da mesa ou o aperto do filamento do extrusor.
** *Rebite roscado ou rebite de rosca* é
um tipo de porca especial mais longa e com uma "quina" que permite que seja usada como elemento de suporte de
peso, sendo por isso usado como se fosse uma _castanha_ nas barras roscadas.
** *Porcas quadradas* são difíceis
de encontrar no Brasil e são bastante utilizadas em alguns modelos de impressoras __reprap__, por se encaixar
perfeitamente em pequenos sulcos feitos por cortadoras a laser (facilitando as construções dos encaixes, como no
caso do corte da graber i3).
** **Parafusos-mosca, ou parafusos sem cabeça**, que geralmente têm sulcos _allen_
no próprio corpo, são comumente usados em pinhões de motores e acopladores de alumínio para fixar a peça em
um chanfro do pino e impedir o movimento de rotação relativa. A ausência da cabeça é justamente para que não
reste uma "saliência" na peça. Como são parafusos geralmente bem pequenos, quase sempre são feitos em aço
reforçado preto.
+
[[tiposparafusos]]
image::tiposparafusos.png[tiposparafusos,width=618,height=622,align="center",title="Alguns parafusos e porcas de mercado, em sentido horário: 1 - parafuso M3x16 de fenda de máquina com cabeça cônica; 2- M3x12 allen de máquina; 3 - M3x20 de máquina de fenda; 4 - porca M3; 5 - porca M3 quadrada, modelo 1, usada nos cortes da graber; 6 - porca M3 quadrada, modelo 2; 7 - porca M3 auto-travante/nyloc; 8 - parafuso allen de máquina M5x50; 9 - arruela M5; 10 - porca M5; 11 - parafuso sextavado M5x12; 12 - porca M8 auto-travante; 13 - porca M8; 14 - parafuso &quot;auto-atarraxante&quot;/de madeira  M2 com cabeça phillips; 15 - parafuso auto-atarraxante de madeira com cabeça phillips cônica; 16 - rebite de rosca M8; 17 - rebite de rosca M3; 18 - rebite de rosca M5. Nesta fotografia não há nenhum componente de unidades imperiais, somente métricas."]
+
* *Barras lisas* +
São elementos estruturais em que se assentam os eixos (X, Y e/ou Z) da impressora 3D. Geralmente
são conjugadas com _rolamentos lineares_ ou mesmo buchas cujo diâmetro interno concide com o diâmetro da barra;
deste modo, o rolamento linear ou a bucha se tornam um elemento livre para deslizar linearmente por todo o comprimento
da barra. É necessário que a barra seja reta com bastante precisão e sofra o mínimo possível de deformação;
geralmente são usadas barras de 8mm (nas impressoras de tamanho médio, como Prusa i3) até 12mm (nas maiores,
como a Sethi3D BB). É desejável que sejam barras "cromadas" pois o cromo dá resistência e diminui o
atrito da superfície (especialmente importanto se for uma bucha).
* *Polias e correias (GT2 e equivalentes)* +
São estruturas usadas em sistemas de engrenagens de transferência de força e energia cinética. As __**polias**__ são as peças giratórias, presas a um eixo geralmente de metal, e no caso das repraps quase sempre com sulcos para o encaixe das __**correias**__. As __**correias**__, por sua vez, são cintas de material flexível mas inextensível (não sofrem extensão elástica) presas às polias ou engrenagem por atritos ou sulcos. A polia de encaixe ou fricção transforma movimento rotacional para linear para a correia, e a correia transforma movimento linear para rotacional. As polias (e correias) lisas servem como rolamentos, não oferecendo resistência ou tração e tendo papel coadjuvante na movimentação. As correias e polias usadas em impressão 3D têm uma nomenclatura que reflete seu formato de dente ("perfil"), muitas vezes tendo também o espaçamento entre os dentes. Um exemplo é o perfil **Poly Chain GT2**(R), bastante popular, com 2mm de espaço por dente. Geralmente as GT2 de 6mm (de largura) são usadas nas impressoras 3D, com o GT5 sendo uma escolha frequente em modelos maiores. As correias usam fios de aço (chamados de "alma de aço") inseridos no material flexível para garantir a inextensibilidade.
* **Extrusões ou perfis de alumínio** +
Estruturas muito usadas para o arcabouço estrutural das impressoras 3D -- como os pilares de uma
delta ou as colunas de uma cartesiana -- devido à sua uniformidade dimensional, especialmente retidão precisa. A
"Extrusão" se refere ao processo de fabricação do material, em que o alumínio é extrudado por um orifício
de formato bem determinado; o nome "perfil" refere, por sua vez, à forma deste orifício. Uma forma bastante
utilizada de perfis de alumínio é o "**T-Slot**"^2^, nome que se refere ao formato invaginado em cada aresta do
quadrado de perfil da estrutura. Este formato é bastante útil pois permite a inserção de outros elementos que
ficarão firmados à peça, incluindo porcas (comuns ou especiais) que permitem fixar com bastante resistência
e estabilidade conectores e suportes. Perfis de alumínio são referidos por uma numeração técnica que diz,
em mm, o comprimento de cada aresta; assim, um perfil de alumínio T-slot 1515, usado na reprap Kossel Mini,
tem 15mm de cada lado com encaixe T-slot, um perfil de alumínio V-Slot 4060 tem 40mm em um lado e 60mm do lado
perpendicular a ele e os lados têm encaixe V-Slot (que é na verdade uma forma de T-Slot). Uma recomendação,
caso esteja usando este livro para decidir qual T-Slot usar, é usar o perfil *2020* pois é robusto, muito popular
e existem modificações das deltas que usam outros perfis para usá-lo no lugar. Além disso, é mais fácil
achar parafusos especializados em seus encaixes.
+
[[perfilaluminio]]
image::perfilaluminio.jpeg[perfilaluminio,width=604,height=353,align="center",title="Perfil de alumínio com &quot;T-Slot&quot;. Créditos: grabcad.com"]
+
* *Barras roscadas (parafusos infinitos)* +
São elementos estruturais por vezes usados como elementos imóveis
(como na estrutura da Prusa Mendel), por outras vezes usados como componentes giratórios que, através da
rotação de seus sulcos, fazem outra peça (uma porca ou "castanha") subir ou descer, transformando assim
o movimento rotatório de um pinhão de motor em movimento linear em uma direção. Barras roscadas não são
fabricadas no entanto com este objetivo e além do mais baixo aproveitamento energético do movimento do motor,
têm baixa precisão comparada ao mecanismo correto, o __fuso__.^1^ Seus filetes bem finos têm um tempo de vida
útil curto limitado pelo desgaste e sua fabricação geralmente não os faz ser completamente retos. No entanto,
são vendidos por metro e seu custo é baixíssimo. +
As barras roscadas são normalmente usadas no eixo Z
(o vertical) que é por isso o eixo mais lento; uma volta completa de 360°C corresponde a uma distância muito
pequena no comprimento da barra, e a uma distância bem maior quando o movimento é feito por correias nos outros
eixos. As barras roscadas mais comuns em impressoras 3D de baixo custo são a M5 (5mm de diâmetro) e M8 (8mm). +
A barra roscada é presa ao pinhão do motor por um elemento com alguma flexibilidade para amortecer folgas e
desvios de imprecisões mecânicas. Este elemento pode ser um _acoplador flexível de alumínio_ ou algum tubo
conector de material resistente, como nylon. +
A distância entre dois fios da rosca no comprimento da barra
é o __passo__, em inglês _pitch_ ou __lead__. Como as barras roscadas são na verdade um tipo de parafuso,
usam a mesma denominação deles -- como "M5" ou "M8" pra designar seu diâmetro.
* *Fusos de rosca* +
Diferentemente das barras roscadas, _fusos_ são elementos industriais especificamente criados para um elemento
deslizante em seu comprimento, transformando movimento rotativo do pinhão do motor em linear. Alguns motores
já vêm mesmo com o fuso fisicamente integrado a eles, como se fosse um pinhão, para evitar qualquer folga no
mecanismo (Figura 55). O fuso pode ser conectado por um acoplador de alumínio como no caso da barra roscada também. +
Fusos são definidos pelo elemento móvel que usam, a __castanha__. Quando usam uma peça deslizante simples,
geralmente de cobre ou poliacetal, são chamados simplesmente de fusos trapezoidais. Quando usam um elemento que
contêm esferas de aço interiores que concedem muito baixo grau de atrito ao movimento, são chamados de __fusos
de esferas recirculantes__. Devido ao seu custo, é raro encontrarmos impressoras 3D de baixo custo usando este
último tipo de fuso, embora o uso do fuso trapezoidal em impressoras 3D comerciais de baixo custo esteja ficando
bastante popular, pela melhoria visível na qualidade de impressão. +
Em relação a barras roscadas, fusos
apresentarão menor "resolução", isto é, uma volta completa do motor equivalerá a uma distância vertical
maior no fuso, visto que os ângulos da rosca são mais acentuados. Isso também significa que o desgaste será
menor e a velocidade maior. +
Outra diferença dos fusos em relação a barras roscadas é a quantidade de roscas
(espirais cavadas) que apresentam. Enquanto uma barra roscada apresenta sempre uma única rosca contínua, fusos
podem apresentar roscas independentes -- por exemplo, um fuso TR8:8 (8mm de diâmetro, passo de 8mm) pode ter
quatro roscas, geralmente discriminadas como quatro __entradas__. +
Embora fusos trapezoidais sejam normalmente
usados em diâmetros de 8mm ou maiores, o uso em 5mm ainda compensa sobre barras roscadas. A grande vantagem deles
é poderem ser simplesmente trocados na estrutura de uma _reprap_ comum sem alteração de outros componentes, e
uma simples reconfiguração do firmware para troca da resolução vertical. A melhora na qualidade de impressão,
especialmente no artefato chamado de __Z wobble__, é instantânea.
* **Rolamentos** +
Rolamentos ou rolimãs (__bearings__ em inglês) são dispositivos que permitem o movimento relativo controlado entre duas
ou mais partes, substituindo o atrito de deslizamento pelo atrito de rolamento, visto que tem elementos denominados
_corpos rolantes_ -- geralmente pequenas esferas de aço cromado -- que intermediam o contato entre o elemento
deslizante e a superfície de deslizamento. São elementos apropriados para alta rotação, alta precisão, baixo
torque e baixa vibração. Há dois tipos principais de rolamentos usados em impressoras 3D, classificados de
acordo com o movimento:
** *Lineares* +
O movimento se dá com o rolamento deslizando ao longo do comprimento do
elemento maior, em linha reta. Como os corpos rolantes têm contato direto com o elemento, o uso contínuo pode
causar desgaste, razão pela qual se deve usar nesse caso materiais bem resistentes como aço. Esses rolamentos
são geralmente utilizados em eixos de impressoras 3D cartesianas ou pilares laterais de impressoras 3D delta.
** *Radiais* +
O movimento se dá com o rolamento tendo dois anéis, o exterior deslizando em torno do anel interior,
com cada anel se prendendo a um elemento de deslizamento. São geralmente utilizados para conduzir a rotação de
uma correia de motor, elementos rotativos de engrenagens de extrusor ou como anteparos (idlers) à roda dentada
de tração do extrusor.
** *Outros tipos* +
Os que mais serão usados em mecanismos de impressoras 3D serão os
lineares e radiais, mas existem inúmeras outras configurações de rolamentos -- por exemplos, as juntas de esferas
para rotação esférica e as dobradiças para articulações. Também existem muitos outros tipos de rolamentos em
relação a outros aspectos da construção -- por exemplo, rolamentos que usam cilindros ao invés de esferas,
ou mesmo fluidos ou campos magnéticos.
* *Buchas* +
Buchas são peças de material deslizante -- geralmente
bronze ou cobre, mas com -- que cumprem o mesmo papel dos rolamentos lineares, deslizando um elemento ao longo do
comprimento de uma barra. Diferentemente do rolamento que usa corpos rolantes, a bucha depende tão-somente do baixo
atrito entre ele e o elemento deslizante, que deve ser cromado e bem lubrificado. A bucha tem um custo menor que o
rolamento, mas sua maior vantagem em relação a ele é a operação silenciosa. Por outro lado, buchas cujo encaixe
não seja perfeito emperram e não permitirão ao mecanismo funcionar, enquanto que o rolamento absorve as folgas.
+
[[barraserolamentos]]
image::barraserolamentos.jpeg[barraserolamentos,width=642,height=380,align="center",title="1 - Bucha de bronze; 2 - rolamentos lineares; 3 - barra lisa M8 (8mm); 4 - barra roscada M8; 5 - rolamentos radiais"]
+
As buchas de plástico no entanto costumam ser auto-lubrificantes, isto é, o próprio material, ao sofrer abrasão,
deposita um lubrificante sólido que a faz ter baixo atrito com o material em contato. A óbvia desvantagem é
que a abrasão acaba desgastando a peça, que acaba ganhando folga com o tempo. Buchas impressas em plásticos
de impressoras 3D também são usadas em algumas impressoras, mas geralmente têm pouca eficiência. A própria
IGUS, fabricante de buchas de plástico, vende filamentos de impressão 3D para tais propósitos (Iglidur I170 e
Iglidur I180).
+
[[buchasdrylin]]
image::buchasdrylin.png[buchasdrylin,width=642,height=365,align="center",title="Alguns tipos de buchas de plástico autolubrificante (Drylin/Poliacetal) da IGUS. Fonte: http://www.igus.com/wpck/3542/DryLin_R_Lineargleitlager?C=US"]
+
[[barraefusocomparados]]
image::barraefusocomparados.png[barraefusocomparados,width=642,height=362,align="center",title="Comparação entre fuso e barra roscada (créditos: forum.reprap.org)"]
+
* *Patins e trilhos* +
Patins e trilhos são outro modo de se ter _guias lineares_ que não usam as barras lisas
com rolamentos. *Patim* ou *carro* é o nome que se dá à peça que desliza, equivalente ao *rolamento linear*
que usamos nas barras lisas; e *trilhos* são extrusões de metal retas com um perfil de encaixe em que o patim
pode deslizar livremente. Patins podem, como os rolamentos, ter corpos rolantes nas partes em que tocam o perfil e
geralmente são vendidos juntamente com os trilhos, já encaixados, e submetidos a um processo chamado de *preload* ou
pré-carga, em que a possibilidade de folga diminui enormemente. Como têm uma usinagem mais complexa e controlada,
têm preços maiores que seus conjuntos equivalentes feitos com rolamentos e barras lisas. Impressoras com foco
mais industrial as preferem, assim como algumas reprap (como a Kossel). Outra vantagem dos trilhos é serem mais
leves.
* **Traxxas rod ends, u-joints, trolley heads, ball joints** -- essas peças, que não têm um único
nome em inglês nem nomenclatura consensual em português (apesar de o nome "juntas de esferas" ser aceitável),
são usadas em impressoras 3D estilo delta como conectores dos braços da delta ao "effector" e ao trilho ou
guia do poste. São peças também usadas por _hobbyistas_ de veículos de controle remoto, e são basicamente
articulações de rotação para fixação de um braço a um eixo (geralmente a rosca de um parafuso). Existem
alternativas a essas juntas feitas por esferas magnéticas deslizantes, mas ainda são pouco usadas.

== Malha aberta ou fechada?

A _Teoria de Controle_ dada a alunos de Engenharia Mecânica nos ensina que há dois tipos de sistemas de controle,
*malha aberta* e **malha fechada**.

[[malhaabertamalhafechada]]
image::malhaabertamalhafechada.png[malhaabertamalhafechada,width=642,height=348,align="center"]

* *Malha aberta* - é um sistema em que a saída (resultado) não exerce qualquer ação sobre o sinal de
controle, não sendo comparada com uma saída de referência esperada. Em outras palavras, é um sistema em que
o componente apenas exerce certas ações programadas, não verificando se elas aconteceram como previsto. Sua
máquina de lava roupa pode ser programada para ciclos de enxágue, lavagem e centrifugação, mas em cada um
desses ela estará apenas exercendo ações mecânicas, não medindo a roupa está realmente seca, sendo lavada
ou centrifugada.
* *Malha fechada* -- há um ou mais componentes no sistema para verificar (medir) a execução
da ação e realimentar o circuito com esta medida. Uma máquina de lavar roupa que usasse um sensor de umidade no
término da ação de secagem para medir o resultado é uma malha fechada. A malha fechada permite ações como a
correção -- se a roupa não está suficientemente seca, inicia-se novamente a secagem até se ter a saída esperada.

Conhecer o conceito de elementos de controle é essencial para entender a sua impressora 3D: não queremos um
motor que só gire pra um lado ou pra outro, queremos saber as coordenadas! Não queremos um componente que só
aqueça o máximo, queremos algo que aqueça e que, ao chegar na temperatura desejada, estabilize. Se a medição
falha e o componente aquece sem controle, teremos grande risco de incêndio e faíscas.

E é como elemento de medição que vamos entender o __endstop__. Em português o termo é "detector" ou
"sensor" de fim de curso, o que dá uma idéia para que serve. Para isso, devemos entender que os motores
usados para posicionar os eixos da impressora 3D são eles mesmos malhas abertas: um comando é enviado para o
motor girar para a frente, ou para trás, ou para permanecer parado. Ele não "sabe" quanto já girou, não
tem informação de posicionamento. O quanto ele gira a cada comando é pré-determinado, então se contarmos
cada comando enviado, poderemos ter essa informação se tivermos a referência inicial. Em um sistema de eixos,
a referência inicial terá a coordenada zero.

O endstop faz esse papel da referência. Funciona do seguinte modo: o endstop é uma "chave" que pode estar
na posição ligada ou desligada. Com um elemento encostado ao endstop, está ligada. Com o elemento distante,
desligada. O motor girando para o sentido "negativo" traz o elemento mais perto do endstop, até encostar
e ligar a chave -- e o controlador imediatamente pára o motor, pois ele não pode ter coordenada negativa;
o motor girando para o sentido positivo distancia o elemento da chave.

[[motorchaveendstop]]
image::motorchaveendstop.png[motorchaveendstop,width=642,height=307,align="center"]

Obviamente, algumas variáveis são importantes aqui. A primeira observação a se notar é que se o motor está
se movendo na direção do endstop, há contato e ele precisa parar, esse tempo de reação entre o contato e
a parada tem que ser mínimo. Geralmente isso não é um problema: mesmo um fraco microcontrolador _Arduino_
consegue executar 16 milhões de instruções por segundo, e o tempo entre detecção do sinal e parada do motor
não dura mais que algumas dezenas de instruções, portanto considerado desprezível.

Outros parâmetros seguem o mesmo padrão; um componente que servirá como endstop tem sua vida útil mensurada
em quantas vezes pode ser acionado e este número para quase todas as tecnologias está na casa de centenas de
milhares de vezes ou até milhões. Como são acionados uma ou duas vezes apenas em uma impressão 3D que pode
demorar horas, não nos preocupamos com a longevidade do componente.

Os três parâmetros críticos de endstops na construção de uma impressora 3D são: distância de acionamento,
precisão e repetibilidade. Tais valores definirão os tipos que podemos encontrar na estrutura de uma impressora.

* **Distância de acionamento**: simplesmente a distância a que o elemento medido (geralmente o extrusor, mas
pode ser outra peça da impressora) está do endstop. Pode ser zero caso o endstop exija contato para fechar
circuito. Geralmente dado em milímetros.
* **Precisão**: um número que diz a resolução da medição gerada,
ou o número de dígitos usados pra expressar o valor. Note o leitor que existe diferença entre _precisão_ e
__acurácia__, mas isto foge do nosso escopo de tratamento; veja bibliografia nas notas para leitura posterior^5^. Se
um endstop tem precisão de 0,01mm, significa que ele pode medir distâncias em múltiplos desse valor, tais como
0,15mm ou 0,27mm, mas não 0,123mm.
* **Repetibilidade**: variação em medidas tomadas nas mesmas condições,
com os mesmos itens, em sequência. Uma repetibilidade de 0,04mm significa que a medida pode variar, digamos,
de 0,08mm até 0,12mm para uma distância real de 0,1mm, mas não sairá deste intervalo.
* *Tipos principais de endstops* +
Os endstops podem ser circuitos _energizados_ ou __não-energizados__. Circuitos
energizados são aqueles que requerem uma tensão positiva -- geralmente 5V -- e um dreno para ativar o
componente, e devolvem em outro fio a resposta. Precisam de três fios. Os não-energizados somente precisam do
sinal, deixando o circuito aberto ou fechado de acordo com o contato, devolvendo portanto dois estados possíveis
(o sinal ou alta impedância) e ocupando apenas dois fios. Os microcontroladores e microcomputadores usados para
controle de impressoras 3D geralmente aceitam ambos os tipos. Dos que listamos, somente os mecânicos podem
ser não-energizados. Endstops são usados em mais do que apenas o limite dos eixos, são importantes para o
autonivelamento de mesa que será tratado mais adiante.
** **Mecânicos**: são os mais simples, precisando
geralmente de apenas dois fios para fechar ou abrir o circuito. São acionados por contato de uma simples chave
mecânica com mola e têm repetibilidade e precisão média pra alta -- em números, geralmente 0,01mm de precisão
e 0,1mm de repetibilidade, embora isso possa variar bastante de acordo com o fabricante.
** **Ópticos**: estão
entre os mais precisos, tendo também boa repetibilidade nas mesmas condições, mas são muito afetados por
fatores externos como mudanças da superfície ou da iluminação. Não funcionam bem com superfície refletoras
ou transparentes.
** **De efeito hall (magnéticos)**: são sensores de dois componentes, um deles magnéticos e
funcionam com o efeito de transdução de tensão em resposta a um campo magnético, de nome Efeito Hall. Como são
dois componentes geralmente pré-calibrados de fábrica e testados com rigor, apresentam precisão e repetibilidade
alta com estruturas bem isoladas mas podem sofrer perturbações de componentes eletrônicos muito próximos. A
precisão pode ser comprometida com o aquecimento por mudança brusca nas propriedades magnéticas, portanto
é melhor ser usado frio quando para autonivelamento de mesa.
** **Indutivos**: podem ter a precisão bem alta
(0,005mm) mas repetibilidade relativamente baixa (0,05mm), piorando bastante de acordo com a montagem na estrutura
e o material usado. Funcionam com o efeito de indução gerado pela proximidade de um metal, preferivelmente um
metal ferrocondutor -- funcionam bem com aço, têm sensibilidade menor para alumínio. Assim como os sensores
de efeito hall, têm melhor precisão se usados frios.
** **Capacitivos**: são sensores de montagem fácil que
podem detectar virtualmente qualquer material a pequenas distâncias, mas têm como desvantagem baixa precisão e
repetibilidade.

Esta lista não é exaustiva. Existem diversas tecnologias que podem ser usadas para calcular
distâncias, como de costume faz parte da _mentalidade reprap_ entender que se trabalha com um espaço aberto
de possibilidades e que a popularização traz dispositivos antes desconhecidos para os holofotes. Detectores de
distância ultrassônicos ou detectores de pressão poderiam em tese ser utilizados. Projetos inovadores surgem
a cada dia, como o sensor motorizado de pressão BLTouch, submetido a financiamento coletivo.

[[sensorbltouch]]
image::sensorbltouch.png[sensorbltouch,width=642,height=321,align="center",title="Sensor BLTouch para autonivelamento de mesa em sua página do indiegogo. Fonte: https://www.indiegogo.com/projects/bltouch-auto-bed-leveling-sensor-for-3d-printers#/"]

É importante perceber que embora teoricamente você pudesse se beneficiar de endstops sendo colocados nos dois
extremos de um eixo -- um representando a coordenada zero (mínimo) e outro representando a coordenada máxima
- poucas impressoras usam os dois, normalmente escolhendo apenas os mínimos ou máximos. Nas cartesianas,
os mínimos são quase universais, mas nas deltas, pela própria construção, se usam endstops máximos.

Note-se que o uso de um endstop ajuda no controle de uma malha, mas não torna os circuitos de uma impressora
3D doméstica uma malha fechada; há muitas partes "abertas" do circuito, como o máximo dos eixos nas
cartesianas. E como será visto na parte sobre motores, uma malha fechada propriamente dita usaria _servo motores_
ao invés de motores de passo.

E vimos o uso dos endstops nos eixos, mas não é só para isso que servem; eles também são usados no assim
chamado "autonivelamento de mesa", que será mencionado na parte sobre as plataformas usadas em impressoras 3D.

Por fim, uma excelente mostra das diferenças entre os vários tipos de sensores para endstop foi
feita pelo vlogger Thomas Sanladerer, caso o leitor saiba inglês é um vídeo bastante recomendado:
https://www.youtube.com/watch?v=il9bNWn66BY[_https://www.youtube.com/watch?v=il9bNWn66BY_]

[NOTE]
.Notas:
====
. http://www.protoparadigm.com/news-updates/accuracy-vs-precision-and-threaded-rod-vs-leadscrews-in-3d-printers/[_http://www.protoparadigm.com/news-updates/accuracy-vs-precision-and-threaded-rod-vs-leadscrews-in-3d-printers/_]
. http://www.meccanismocomplesso.org/en/tslot-framing-openbeam-makerbeam-micromax/[_http://www.meccanismocomplesso.org/en/tslot-framing-openbeam-makerbeam-micromax/_]
. http://www.corexy.com/[_http://www.corexy.com_]
. Ainda que fuja ao escopo deste livro elaborar na questão da cinemática das impressoras, o site
_reprap.org_ oferece ótimo material de estudo em inglês, a julgar pela sua própria entrada sobre _CoreXY_
(http://reprap.org/wiki/CoreXY[_http://reprap.org/wiki/CoreXY_]), pela sua lista de _arranjos mecânicos_
(http://reprap.org/wiki/Category:Mechanical_arrangement[_http://reprap.org/wiki/Category:Mechanical_arrangement_])
ou pelos links acadêmicos de referência que cita
(http://www.mesj.ukim.edu.mk/sites/default/files/Mech-Eng-25-1-2006_0.pdf[_http://www.mesj.ukim.edu.mk/sites/default/files/Mech-Eng-25-1-2006_0.pdf_]
- __Parallel Kinematics Machine Tools: History, Present. Future__)
. http://paladintechworks.com/index.php/home/blog/12-tech/14-understanding-the-terms-precision-repeatability-and-accuracy-in-the-cnc-world[_http://paladintechworks.com/index.php/home/blog/12-tech/14-understanding-the-terms-precision-repeatability-and-accuracy-in-the-cnc-world_]
====

== Extrusor
O extrusor é o conjunto que puxa (traciona) o filamento plástico e o
derrete. Essas duas funções são realizadas por partes diferentes do extrusor: uma, o tracionador ou cold end
("extremidade fria"), é a que tem um motor e engrenagem dentada que dá a força e a velocidade para o
filamento ser alimentado na segunda parte, que é chamada de hot end ou hotend ("extremidade quente").^1^

[[estruturaextrusorfreecad]]
image::estruturaextrusorfreecad.png[estruturaextrusorfreecad,width=618,height=395,align="center",title="Estrutura de um cold end / tracionador engrenado típico. Neste o filamento (em vermelho) entra por cima e sai para o hotend por baixo. Algums modelos bem mais caros têm, ao invés da polia de tensão, outro pinhão de filamento com dentes, como o tracionador do extrusor flexion, de https://flexionextruder.com/."]

O tracionador e o hotend não necessariamente estarão
juntos ou mesmo próximos. A primeira distinção é justamente essa:

[width="100%",cols="^s,^m,e",frame="topbot",options="header"]
|====
| Tipo | Exemplo | Descrição
| Direct / Monolítico a| image:image81.jpeg[image,width=190,height=190,align="center"] | Tracionador e hotend acoplados
| Bowden / Filamento guiado a| image:image82.png[image,width=215,height=185,align="center"] | tracionador e hotend separados
|====

Em impressoras 3d estilo __delta__, no hotend, você tem ainda a estrutura que une os braços chamada de effector:

[[fotoeffector]]
image::fotoeffector.png[fotoeffector,width=642,height=498,align="center",title="Effector da Impressora 3D delta &quot;Kossel&quot; (peça azul)"]

O bowden, também chamado de configuração com filamento guiado, tem o tracionador geramente fixado na carcaça e
vai usar um tubo de baixo grau de atrito para unir as duas peças e preservar a tração do filamento sendo empurrado
pelo motor. Este tubo, quase sempre de PTFE (teflon), pode no entanto dificultar ou impossibilitar alguns tipos de
uso de filamento, em especial filamentos flexíveis, em que a _histerese elástica_ faz o filamento se comprimir
e expandir com atrasos dentro do tubo, chegando ao hotend com tração pequena ou irregular e levando a travadas
ou entupimentos na impressão.

No entanto, o uso de bowden também traz algumas vantagens. Quase sempre o motor é um dos itens mais pesados do
extrusor e removê-lo da parte móvel faz a impressão ter muito menos inércia pra combater e portanto possibilita
velocidades maiores sem perda de qualidade. Também traz vantagens em deixar a parte livre do filamento fixa,
evitando artefatos de pequenos deslocamentos laterais durante a impressão. E por fim, para impressoras 3D que
usem câmaras aquecidas, deixar um componente sensível como o motor fora da zona de aquecimento diminui chance
de defeitos e permite maior economia na construção.

Os hotends para uso com bowden vêm com um encaixe diferente dos de direct drive. Usam uma rosca de 8mm para o encaixe
de um "conector de engate rápido", também chamado de "conector pneumático" ou "push-fit connector".

Mas essa não é a única variação possível do extrusor nas impressoras 3D de baixo custo. Tanto o tracionador
quanto o hotend também têm seus tipos. Comecemos pelo tracionador, que tem sua classificação dependendo de
como a engrenagem dentada que tem contato com o filamento recebe força do motor:

[width="100%",cols="^1s,^1m,2e",frame="topbot",options="header"]
|====
| Tipo | Exemplo | Descrição
| Engrenado ou _Geared_ a| image:image84.jpeg[image,width=206,height=154,align="center"] | Funciona com a tração transferida por engrenagens
| __Direct Drive__ a| image:image85.jpeg[image,width=203,height=152,align="center"] | O pinhão traciona diretamente o filamento
|====

Um extrusor _engrenado_ tem uma "redução" no movimento, isto é, com o sistema de engrenagens, ele passa
a ter que dar mais voltas para tracionar um mesmo comprimento de filamento; no entanto, com essa redução de
velocidade ele consegue mais força do que se entrasse em contato por um pinhão colocado diretamente no pino do
motor. Essa é a diferença entre os dois: o engrenado consegue mais força e tem a velocidade máxima a que pode
chegar menor que do direct drive.

Note ainda que o tracionador engrenado geralmente usa um parafuso modificado preso à engrenagem para tracionar
o filamento. Esse parafuso é chamado de __parafuso trator__, com a cabeça hexagonal conectada à engrenagem
maior. Tanto o _pinhão_ do motor quanto o parafuso trator podem ter _sulcos_ (fendas cilíndricas com os dentes de
tração circulando o filamento de forma radial) ou _canaletas_ (fendas retas e mais largas com os dentes paralelos
e retos), conforme a Figura <<parafusotratorepinhao>>.

[[parafusotratorepinhao, XX]]
image::image86.jpeg[parafusotratorepinhao,width=642,height=365,title="1. Parafuso trator com sulco; 2. Parafuso trator com canaleta; 3. Pinhão (MK7) com sulco; 4. Pinhão completamente canaletado; 5. Pinhão (MK8) com sulco."]

Os hotends se dividem, por sua vez, em:

[width="100%",cols="^1s,^1m,2e",frame="topbot",options="header"]
|====
| Tipo | Exemplo | Descrição
| PEEK + metal a| image:image87.jpeg[image,width=212,height=157,align="center"] | Plástico resistente a calor e isolante térmico.
| Metal com PTFE interno a| image:image88.jpeg[image,width=211,height=157,align="center"] | O hotend é quase inteiramente de metal, mas tem um pequeno tubo interno de PTFE para o filamento.
| Todo de metal (all-metal) a|  image:image89.png[image,width=212,height=163,align="center"] | O hotend é de metal, sem o tubo de PTFE.
|====

Os hotends do primeiro tipo -- usando um plástico chamado PEEK (polyether ether ketone, poliéter-éter-cetona)
-- foram os usados no começo do projeto RepRap e hoje quase não se os encontra mais. Eles têm o revestimento de
PEEK, um tubo interno de metal e um pedaço de tubo de PTFE interno ao tubo de metal por onde o filamento escorrega
até a zona de aquecimento no bloco aquecedor. Tanto o PEEK quanto o PTFE são isolantes, portanto o calor gerado
no bloco aquecedor não percorre as vias internas ou externas do hotend e isso dá segurança à peça. A grande
desvantagem é a baixa faixa de trabalho térmica: um hotend desses pode ser mantido no máximo a cerca de 250°C,
temperatura acima da qual o PTFE e o PEEK começam a degradar.

Uma melhoria no design dos hotends que permitia maior faixa de temperatura, e portanto maior variedade de materiais
para derretimento, veio logo com os hotends de metal. Como os metais são bons condutores térmicos, entretanto,
tornaram-se necessárias duas mudanças na geometria: colocar _aletas de dissipação_ para que o calor não suba
pelo _pescoço dissipador_ e na transição do _bloco aquecedor_ para o pescoço, colocar uma peça estreita de
aço inoxidável (um metal que não tem alta taxa de condutividade térmica) que é chamada de __heatbreak__, ou
__barreira de calor__. Um hotend desses aguenta bem temperaturas até os 260°C e pode chegar a cerca de 280°C
dependendo de onde termina o PTFE.

Ainda que o PTFE interno ao hotend ("PTFE liner") fique geralmente acima do heatbreak e não muito próximo
do bloco aquecedor, há as limitações de temperatura do material. Alguns fabricantes entretanto quiseram ampliar
ainda mais a faixa de trabalho do hotend e começaram a fabricar hotends __all-metal__, ou todo de metal, em que o
baixo atrito do PTFE que permite ao filamento deslizar sem resistência até a zona de aquecimento é substituído
por um polimento especial no metal que faz com que ele tenha baixo coeficiente de atrito. Não tão baixo quanto
o PTFE, entretanto, e uma dura verdade é que embora os hotends todos de metal possam trabalhar em temperaturas
que superam os 500°C se o componente medidor de temperatura as suportar, o maior atrito gera maior chance de
entupimentos, especialmente com plásticos que têm maior aderência como PLA ou PETG.

Um hotend all-metal de mercado com um "termistor" comum (componente medidor de temperatura mais usado por
repraps) trabalha bem até uns 300°C, propício para filamentos de maior ponto de fusão como policarbonato,
poliacetal e alguns nylons.

[[partesdeumhotend]]
image::partesdeumhotend.jpeg[partesdeumhotend,width=642,height=526,align="center",title="Componentes de hotend. Dois hotends all-metal; o de baixo é um chinês genérico, o de cima uma réplica nacional do hotend open-source Volcano da e3d, com o tubo de PTFE do bowden (que não é o PTFE interno/liner). Foto: do autor"]

.Revestimento do bloco aquecedor

[[hotendsocks]]
image::hotendsocks.jpeg[hotendsocks,width=642,height=363,align="center",title="&quot;Meia&quot; de silicone da e3d para o hotend. Créditos: e3d-online.com"]

O revestimento de bloco aquecedor (termo em inglês: "hotend silicone socks", ou meias de silicone
para hotend) é uma invenção da empresa E3D que ajuda consideravelmente na eficiência do aquecimento
e isolamento do hotend e, sendo um item barato e descartável, até na limpeza. É feito de silicone
resistente a altas temperaturas (até 500°C). É possível usar a própria impressora 3D para fazer
moldes impressos e silicone de molde de alta temperatura para a partir do molde criar uma réplica para o
seu hotend; o primeiro molde desses foi disponibilizado pelo usuário _thefrog_ no sítio thingiverse em
http://www.thingiverse.com/thing:1432346[_http://www.thingiverse.com/thing:1432346_].

[[colaparasocks]]
image::colaparasocks.png[colaparasocks,width=642,height=367,align="center",title="Existem vários outros designs de molde pra "silicone socks" no thingiverse. E cola de silicone de alta temperatura, encontrável em lojas de construção, pode ser usada neles. Foto do molde e meia por André Ruiz, design em http://thingiverse.com/thing:1655134"]

.Dissipação

Uma outra característica importante dos hotends é se têm dissipação _passiva_ ou __ativa__. Dissipação
passiva é o calor ser dissipado naturalmente pela geometria do hotend, sem necessidade de interferência externa
-- como pelas aletas, por exemplo. Dissipação ativa é usar uma peça auxiliar, geralmente uma ventoinha,
para auxiliar a expulsão de calor do pescoço dissipador e impedir que a zona de aquecimento suba muito.

[[hotende3dcomventoinha]]
image::hotende3dcomventoinha.png[hotende3dcomventoinha,width=559,height=660,align="center",title="Hotend E3D all-metal v6 com ventoinha acoplada por acrílico azul no pescoço dissipador, para refrigeração ativa. Embora o acrílico comece a amolecer em 105°C, é esperado que ele nunca chegue a essa temperatura por causa da própria refrigeração ativa."]

A refrigeração ativa é especialmente importante para materiais com alto calor específico (como o PLA, que
tem 2060 J/Kg°C a 190°C), pois eles demoram mais para dissipar o calor e este tende portanto a subir mais pelo
pescoço dissipador. Quando o calor sobe, aumenta o comprimento da zona de derretimento e, estando no estado
líquido, o filamento vai perdendo a propriedade de funcionar como "êmbolo de si mesmo", com a parte mais
sólida deixando de empurrar a parte mais liquefeita. Hotends sem dissipação ativa portanto tendem a entupir bem
mais frequentemente que os que a têm. Ela é, portanto, recomendada para todos os casos e estar sempre ligada,
inclusive por a ligação ser fácil e gastar muito pouca energia.

.Resfriamento forçado do material

Do mesmo modo que o pescoço dissipador, o material extrudado^2^ do bico pode necessitar de ajuda para sair do
estado líquido para o sólido, o que também é importante para os mesmos materiais com alto calor específico
do parágrafo anterior. O PLA é um bom exemplo, se você extrudar um filete de ABS e um filete de PLA, verá
pelo movimento menos dúctil que o de ABS torna-se sólido bem mais rapidamente, quase imediatamente ao sair
do nozzle, enquanto o PLA sai líquido e ainda sucumbe um pouco após tocar a mesa. Já é possível imaginar a
diferença deste comportamento para as peças impressas: as de PLA tenderão a adquirir um aspecto mais caído,
mais "derretido", por acomodação do filamento ainda não totalmente solidificado.

[[comventoinhaesemventoinha]]
image::comventoinhaesemventoinha.png[comventoinhaesemventoinha,width=642,height=454,align="center",title="Esq.: impressão em PLA feita sem ventoinha. Dir.: Impressão feita com ventoinha. Créditos: Tech2C - https://www.youtube.com/watch?v=7LVu3Ir10UQ"]

Por outro lado, como veremos mais à frente com o ABS, há materiais que você não quer que esfriem mais rápido
pois sofrem efeitos de empenamento ("warp") e rachaduras. Como lidar com isso? A solução mais frequente
é usar mais uma ventoinha extra, com a diferença que esta _não pode_ estar ligada o tempo todo. Portanto, ao
invés de simplesmente ser ligada junto com a impressora 3D, esta ventoinha deve ser ligada e desligada sob demanda
durante a impressão, o que significa que ela tem que ser microcontrolada, ou comandada pelo mesmo software que
rege o processo de impressão. Esta ventoinha é chamada de _ventoinha do bico_ (nozzle fan), em contraste com
ventoinha do pescoço dissipador.

[[hotendcomduasventoinhas]]
image::hotendcomduasventoinhas.jpeg[hotendcomduasventoinhas,width=642,height=553,align="center",title="Hotend com ventoinha do pescoço dissipador e ventoinha do bico. Créditos: delta steel 3d printer blog - http://deltasteel3dprinter.blogspot.com.br/"]

[NOTE]
.Notas:
====
. Há uma grande variação de uso na nomenclatura, o que é esperado em um mercado de massa sem padrões
industriais impostos. Algumas pessoas e empresas usam "extrusora" ao invés de "extrusor"; outras usarm
"extrusor" do modo como definimos "tracionador". Em analogia com impressoras "2D", alguns fabricantes
chamam o extrusor ou o cold end de "cabeça" ou "cabeçote", diluindo o conceito. Outros chamam o hotend de
"bico", criando uma ambiguidade desnecessária com a pequena extremidade da peça, o "nozzle". Um extrusor
estilo "bowden" é algo consensual, mas existe uma grande ambiguidade de uso entre extrusores "direct"
ou "direct drive". Seria um exercício de futilidade e arrogância tentar convencer outros a adotar a nossa
nomenclatura, mas escolhemos uma que minimiza ambiguidades e é relativamente popular. Fique de olho em armadilhas
de interpretação, em especial ao fato de que sempre que quisermos tratar do "nozzle" chamaremos de "bico",
e à peça que derrete o filamento chamamos "hotend".
. Sim, apesar dos termos "extrusão" e "extrusor", o verbo é "extrudar". Idiossincrasias de
nossa língua!
====

.Extrusores duplos, triplos, múltiplos

*Cores versus materiais* -- Uma das críticas que mais se faz à impressão 3D em geral, e à FFF em geral, é a
dificuldade ou falta de _cores_ _diferentes_ para se colocar em um objeto ao imprimi-lo. Ora, o próprio nome da
técnica remete a isto: estamos tão acostumados a _impressão_ (em papel) estar associada a documentos coloridos,
a informação, a aparência que nos esquecemos que estamos tratando de outro escopo de atuação. Particularmente,
enquanto uma impressão em papel quase sempre traz _apenas informação_ -- sem características funcionais
imediatas, como no caso de um origami no papel para ser dobrado em uma forma -, a impressão 3D terá, em seu
mais amplo escopo, objetos que têm utilidade em sua forma, sua geometria. Uma peça mecânica, um encaixe de
equipamento, um utilitário doméstico. Lógico que não é limitado a isto: se você imprime uma estatueta ou um
boneco, você vai querer passar também a aparência da superfície. No entanto, com uma impressora 3D comum de
mercado você terá apenas um bico extrusor de plástico usando um único filamento monocromático, e terá que
recorrer a acabamentos manuais como alisamento e pintura para colocar aquela informação extra em sua superfície,
como cores, reflexividade, contornos, etc.

Embora tratemos de acabamento manual neste documento, e toda técnica de impressão 3D -- inclusive, e principalmente,
as industriais -- tenha estágios complexos de acabamento, toda a idéia da impressão 3D é __deixar a máquina
fazer o serviço__. Se nos resignamos a ter sempre uma etapa "artesã" no processo, acabamos por limitar a
penetração da impressão 3D na fabricação industrial "do mundo real". Portanto, é imperativo que sempre
procuremos automatizar ao máximo esta etapa.

Portanto, se se fazem necessárias cores na peça final, elas têm que ser tratadas. No entanto, cores _ainda_
são uma analogia imperfeita com a impressão em papel. No papel, você não está preocupado com a elasticidade
ou dureza do desenho que imprime; você quer passar algo abstrato que pode corresponder a algo físico mundo real,
mas não precisa ter suas propriedades. E se precisar, encontra muitas limitações -- por exemplo, é quase
impossível você imprimir, em papel, uma área __espelhada__. A reflexividade seria uma propriedade útil, mas
é tão difícil de obter que poucos se dão ao trabalho de potencializá-la.

É necesse contexto que deve ser entendida a ainda atual resistência dos métodos de impressão 3D a incorporar
cores; não é que não é possível, o incentivo é que ainda é relativamente baixo, dada a utilidade derivada
da forma e não informação.

Por outro lado, a analogia serve também no sentido inverso: se em impressoras de papel as propriedades físicas
da tinta não são tão importantes, nas impressoras 3D elas são essenciais. Faz toda a diferença se você usa
um material rígido ou flexível, opaco ou transparente, brilhante ou fosco. Portanto, _também é limitante_
você pensar em impressões 3D "a cores" -- e deve ter percebido que esta expressão foi evitada até agora. Até
mesmo quando se pensa apenas na informação que uma peça colorida deve passar, o material, mais que a cor,
interessa: uma estatueta de santo com túnica será muito mais convincente se a túnica, ao invés de brilhar com a
luz, oferecer uma superfície com aspecto fosco e granulado. Os olhos do mesmo santo, por outro lado, terão muito
mais vida se ao invés de superfície opaca e sem vida tiverem alguma transparência e brilho. E se quisermos tocar
a estatueta, senti-la? Uma túnica que realmente parecesse tecido seria muito mais realista -- e valorizada --
que uma forma rígida que nem mesmo se flexiona com o toque.

Quando voltamos à necessidade de utilidade da forma, então, o material usado se torna ainda mais importante. Com
impressoras 3D FFF, hoje em dia, graças ao projeto RepRap e sua massificação da indústria, temos disponíveis
todo tipo de materiais com propriedades diferentes -- dezenas, provavelmente centenas e novos surgindo a
cada dia de acordo com a criatividade dos pequenos empreendedores. Materiais rígidos, flexíveis, condutores,
isolantes, fosforescentes, translúcidos, transparentes, metálicos, moldáveis, dissolvíveis, biodegradáveis,
compostáveis... Até mesmo comestíveis se você levar em conta as modificações nos extrusores de impressoras
FFF para incorporar uma seringa que extrusa material como chocolate ou massa de macarrão!

A solução em impressoras FFF para enriquecer a gama de cores nas impressões, portanto, expandem muito mais
nossos horizontes que apenas permitir informações extras na superfície do objeto. Poderemos criar designs
criativos e úteis, como uma articulação que tenha partes em filamento flexível e partes rígidas, fundidas uma
na outra sem necessitar de encaixe (imagine isto sendo usado em próteses); podemos criar uma peça opaca mas com
cobertura transparente; podemos usar dois filamentos com propriedades físicas bem diferentes para poder remover
um deles depois. Na seção sobre fatiamento, aprenderemos sobre as estruturas de suporte, que são estruturas
de sustentação para partes pendentes a serem removidas depois da impressão. Fabricar estas estruturas com um
material dissolvível em um solvente que não afete o outro material faz com que fique muito fácil "limpar"
a peça com um simples banho de imersão naquele solvente.

Dito isto, vamos então examinar a solução tradicionalmente usada em impressoras FFF para resolver o problema
de limitação de co... -- não! Limitação de material.

*Vários extrusores, lado a lado.* É essa a solução. É simples: todos os circuitos e estrutura que você tinha
para um extrusor, você multiplica. Um motor tracionador para cada novo extrusor, um termistor para cada um deles,
um cartucho aquecedor, um hotend... E muitas complicações e problemas:

* **Todos os bicos precisam estar perfeitamente alinhados** -- se um bico estiver mais baixo que os outros, ou
este bico arranha na mesa ou os outros extrudam a alturas maiores, fazendo a impressão falhar ou o bico mais
baixo bater no material ao se mover o extrusor. Alguns fabricantes de impressoras 3D adotam um sofisticado
circuito de movimentação que retraem os outros hotends enquanto um está sendo usado; mas além de ser uma
solução bastante encarecedora, ainda não resolve o problema de os outros bicos estarem em nível diferente
de altura da mesa quando não estão retraídos.
* *Insere novos pontos de falha* -- se antes sua impressão
falharia se seu hotend entupisse, agora a impressão falha se o hotend 1 entupir ou se o hotend 2 entupir. Suas
chances de problema aumentam enormemente, ainda mais pela interferência de um extrusor no outro -- você tem
por exemplo que configurar a distância exata de um bico ao outro, com precisão de centésimos de milímetros,
para que a impressão fique boa.
* *Você perde área de impressão* -- olhe para a Figura 66:
o que você percebe na peça do extrusor múltiplo? Ela é grande, até desajeitada, ocupando muito espaço e,
para a mesma carcaça, deixando de permitir que o bico alcance certas coordenadas, diminuindo a área útil.
* *Você perde velocidade do extrusor* -- ser uma impressora 3D FFF não significa que os extrusores têm que se
mover; você pode construir uma impressora em que o extrusor fique mecanicamente fixo e somente a mesa precisasse
se mover. Mas este design tem seus próprios problemas, e a quase totalidade das impressoras de mercado usa um
extrusor móvel. E se o extrusor se move, ele tem inércia, tanto maior quanto for sua massa, o que significa que
mais força é necessária para acelerá-lo para a mesma velocidade. Portanto, colocar vários extrusores que se
movem em conjunto tenderá a deixar a impressão mais lenta. Novamente, existem alguns designs experimentais que
tentam escapar disso, como fazer extrusores "semi-independentes" que se destacam do conjunto quando não estão
sendo usados. Mas é uma solução _bastante_ encarecedora e com muitos desafios técnicos.
* *Você ainda está restrito a usar só um extrusor por vez* -- pense no processo de impressão de uma forma que use dois materiais:
se o bico está, no eixo X, a exatamente 3cm do bico 2, qual é a chance que, naquela forma, um ponto do material 1
esteja exatamente a 3cm à direita do material 2? Muito baixa, e certamente não valerá para todas as coordenadas
daquela camada. Assim sendo, não é possível criar uma trajetória boa de extrusão em que os dois extrusores
fiquem trabalhando ao mesmo tempo. As impressoras portanto usam um único extrusor por vez -- e isso na verdade cria
mais desafios: enquanto um extrusor está ativo, o outro pode estar com plástico liquefeito ainda que "vaza"
sobre a peça ou a mesa (fenômeno conhecido como __oozing__). Se o extrusor inativo se mantiver em temperatura
alta, além do oozing, o material pode sofrer também carbonização ou degradação pelo tempo prolongado de
exposição a alta temperatura, e entupir o hotend. Por outro lado, no mesmo extrusor inativo, se o plástico se
ressolidificar completamente dentro do tubo do hotend, é grande a chance de entupimento. Um jeito de mitigar o
problema é deixar o hotend inativo em uma temperatura alta intermediária, em que ele está em estado pastoso.
* *Você não consegue misturar materiais/cores* -- todo esse trabalho e reveses, por fim, para adicionar apenas
um material ou cor à peça, sem permitir um degradê ou mistura finamente controlado que poderia pintar um rosto
convincente, as sombras de uma escultura, as diferentes partes do corpo. Como você controla apenas um extrusor
por vez, com filamentos diferentes que se solidificam ao sair, você não consegue ter mistura entre eles, embora
possa "fundi-los" imprimindo um sobre o outro. Este último problema, aliás, acabou levando ao design seguinte:
extrusores misturados e combinadores.

[[extrusorduploetriplo]]
image::extrusorduploetriplo.png[extrusorduploetriplo,width=994,height=384,align="center",title="Esquerda: Extrusor duplo direct para prusa i3. Direita: Extrusor triplo de bowden para prusa mendel. Ambos de aliexpress.com"]

É interessante ainda notar que existem alguns designs de extrusores
múltiplos que tentam resolver esses problemas de variadas formas, uma delas sendo extrusores independentes
(em eixos próprios e intercruzados) ou semi-independentes (compartilhando um eixo, ou "destacáveis" para
uma posição de descanso enquanto não são usados). E apesar de patentes da Stratasys, pra variar, bloqueando
certos caminhos de utilização via sua subsidiária Makerbot, com a __US8512024 B2 -- Multi-extruder__, já
existem soluções comerciais, e, melhor ainda, open-source aparecendo, como a BCN3D Sigma. Seus repositórios
de eletrônica, firmware e até fatiador (Cura) especialmente modificado pra tratar com essa cinemática estão
em https://github.com/BCN3D[_https://github.com/BCN3D_].

[[bcn3dsigma]]
image::bcn3dsigma.png[bcn3dsigma,width=582,height=510,title="A Impressora 3D Open-Source BCN3D Sigma, com dois extrusores independentes. Fonte: https://www.bcn3dtechnologies.com/en/3d-printer/bcn3d-sigma/",align="center"]

Além dos extrusores independentes, existem duas outras modalidades que têm se mostrado bastante viáveis e
ganhado suporte nos fatiadores e firmwares, que são os extrusores _combinadores_ e __misturadores__.

.Extrusores combinadores e misturadores

O uso de extrusores múltiplos em impressoras 3D FFF até há pouco tempo era de relativa raridade, restrito a
máquinas bastante caras em relação à média. Foi uma área que demorou a amadurecer, e não só no __hardware__:
os softwares que fazem a preparação da impressão e os formatos de arquivo só estão maduros nos tempos atuais e
ainda há um atraso tecnológico por exemplo na modelagem tridimensional que faça peças propícias a impressão
por múltiplos extrusores. Embora com "truques" se possa contornar isso, até hoje a maioria dos modeladores
não oferece suporte de exportação aos arquivos de impressão 3D com extrusores múltiplos -- 3MF e AMF --
ficando restritos a exportar no formato de malha simples sem material "STL", inventado na década de 80.

Em situação de suporte ainda mais precária encontram-se os designs inovadores de extrusores que _combinam_
ou _misturam_ materiais diferentes para impressão. Para entender melhor, vamos diferenciá-los:

* *Extrusor combinador* é aquele em que um único hotend é alimentado por um canal em Y que reúne dois (ou mais)
filamentos diferentes, no entanto com __um filamento por vez__. A cada momento em que um ou outro filamento for
utilizado, o outro deve ser completamente removido (retraído) da área em comum, pois estão no estado sólido e
não se misturariam. As vantagens desse design são a economia -- o canal em Y para os dois filamentos pode até ser
impresso em plástico (como no caso do extrusor "Flux Capacitor"^1^ ou no kit quádruplo da prusa^2^) ou injetado
("Prometheus System"^3^) - e a simplicidade de operação: para o preparador de impressão, o extrusor combinador
é apenas um extrusor múltiplo com distância zero entre "os bicos" em que a cada vez que ele tiver que fazer a
operação de troca de material, tem que fazer um movimento de retração do filamento grande. Qualquer software que
suporta extrusão múltipla aceitará sem reservas o extrusor combinador. Alguns problemas são aliviados ou resolvidos
por se usar esse tipo de extrusor, como um leve alívio no peso por usar um único hotend e não ter o problema de
desnível de bicos. Ainda acontecerá certo _oozing_ e ainda, ao se mudar de um filamento para outro, o material
derretido remanescente no bico fará com que a impressão apresente um "degradê" do material. Adicionalmente,
pela própria geometria dos dispositivos combinadores, quase sempre eles são exclusivos para __bowden__.
* *Extrusor misturador* é aquele em que a junção dos canais de filamento, ao invés de ocorrer na parte fria,
ocorre em uma câmara de aquecimento conjunta no hotend. Este tipo de extrusor permite mistura real de materiais
ou cores, com tracionamento simultâneo possível para todos os filamentos alimentados. A potência necessária
para aquecer a câmara conjunta será bem maior, assim como o tamanho da parte em metal. Como ainda temos um único
bico e várias entradas, este extrusor pode ser usado com a exata mesma configuração que o extrusor combinador:
extruda-se um único filamento e para trocar para o outro retrai-se completamente o atual da câmara comum. No
entanto, a vantagem -- e dificuldade - estará em se poder utilizar versões mais novas e experimentais tanto
dos firmwares que rodam na impressora 3D quanto dos preparadores de impressão e modelos 3D utilizados para
que tenham a informação de mistura de materiais e o controle dessa mistura. Note-se que materiais diferentes
apresentam propriedades de derretimento e até de combinação diferentes, e esse controle de mistura portanto
será bem grosseiro e propenso a artefatos se os materiais não forem extremamente específicos e controlados
para a tarefa. Mesmo assim, softwares como os firmwares _Marlin_ e _Repetier_ _Firmware_ nas suas versões mais
novas já implementam até os comandos para misturas subtrativas de cores CMY(K), como nas impressoras de jato de
tinta. Um plugin de pós-processamento para o fatiador Cura 15.04 que faz a mistura de acordo com algumas receitas
consta do thingiverse: http://www.thingiverse.com/thing:1664880[_http://www.thingiverse.com/thing:1664880_]

[[fluxcapacitor1]]
image::fluxcapacitor1.png[fluxcapacitor1,width=462,height=400,align="center",title="Flux Capacitor - peça combinadora em bowden para um hotend - https://www.thingiverse.com/thing:301982 (Immagina e Crea)",align="center"]

[[cyclopsediamond]]
image::cyclopsediamond.png[cyclopsediamond,width=908,height=450,align="center",title="Esquerda: hotend misturador duplo estilo e3d cyclops (aliexpress.com), direita: hotend misturador triplo estilo reprap.me Diamond (aliexpress.com)"]

.Enfim, o bico
Chegamos ao extremo do assunto -- o bico. É onde termina o hotend, e você já deve estar se perguntando que material
é esse, de tom amarelo, meio dourado, com que ele geralmente é feito. É __latão__, uma liga não-ferromagnética de metal
feita de cobre e zinco com baixo coeficiente de atrito, alta condutividade térmica e alta durabilidade. Certas ligas
de latão são dopadas com chumbo (cerca de 2%) o que leva a objeções com adequabilidade para contato com alimentos.

Nem sempre o bico é feito de latão, especialmente agora que novos materiais abrasivos (como ABS com fibra de
carbono) estão começando a ser usados em impressoras 3D convencionais. A empresa e3d fez história com seu
estudo^4^ sobre a corrosão que tais filamentos causam em bicos de latão convencionais e usou dele para promover
a venda do seu bico de aço inoxidável, muito mais propício para essas impressões (ao mesmo tempo que é em
tese adequado para contato com comida).

[[e3dlataoeaco]]
image::e3dlataoeaco.jpeg[e3dlataoeaco,width=642,height=547,align="center"]

Apesar de aço não ter a condutividade térmica tão alta quanto latão (o que poderia, em teoria, aumentar a
probabilidade de entupimentos), materiais avançados para impressoras 3D FFF realmente estão começando a surgir,
inclusive com metais misturados, e para certos usos até mesmo o aço pode se mostrar insuficiente. Uma campanha
de financiamento coletivo no _kickstarter_ financiou com sucesso a fabricação de um bico feito de tungstênio^5^,
o metal mais duro conhecido!

[[screenshottungsten]]
image::screenshottungsten.png[screenshottungsten,width=642,height=441,align="center"]

Ainda que não haja um padrão obrigatório de medidas de bicos, a grande maioria dos bicos "genéricos"
usa uma rosca M6 (6mm de diâmetro) para se conectar ao bloco aquecedor de alumínio (Flashforge, Wanhao i3 e
algumas outras usam M7) e tem algo entre 10 e 20mm de comprimento. Bicos grandes são indesejáveis: podem não
estar aquecidos o suficientes quando o plástico está sendo extrudado e acabar contribuindo para um resfriamento
prematuro, evidenciado por um filete de material "enroscando" na saída.

A medida de saída do orifício de um bico tem pouca variação. As impressoras 3D estilo Makerbot costumam sair
com 0,35mm de diâmetro, as repraps com 0,4mm de diâmetro. A medida desse furo é um equilíbrio entre a pressão
interna necessária para tracionar o filamento e o diâmetro máximo desejável do filete de material; diminuir o
orifício para 0,2mm dobra a pressão interna necessária e aumenta a chance de entupimentos, aumentar para 0,8mm
divide pela metade a pressão mas também necessitará de um bloco e cartucho aquecedores com maior capacidade
de entrega de energia térmica -- maior potência. O hotend _volcano_ da e3d, que aparece na Figura 14, tem um
bloco aquecedor maior e por default vem com bicos de orifícios maiores (0,6 a 0,8mm) exatamente por este motivo.

[NOTE]
.Notas:
====
. https://3dprintingindustry.com/news/prometheus-system-kickstarter-95071/[_https://3dprintingindustry.com/news/prometheus-system-kickstarter-95071/_]
. http://prusaprinters.org/original-prusa-i3-mk2-multi-material-upgrade-release/[_http://prusaprinters.org/original-prusa-i3-mk2-multi-material-upgrade-release/_]
. https://immaginaecrea.wordpress.com/2014/04/17/il-flusso-canalizzatore-stampa-3d-a-piu-colori-singolo-ugello/[_https://immaginaecrea.wordpress.com/2014/04/17/il-flusso-canalizzatore-stampa-3d-a-piu-colori-singolo-ugello/_]
. http://e3d-online.com/is-carbon-killing-your-nozzle[_http://e3d-online.com/is-carbon-killing-your-nozzle_]
. https://www.kickstarter.com/projects/dddmaterial/3d-printer-tungsten-premium-nozzle-reloaded[_https://www.kickstarter.com/projects/dddmaterial/3d-printer-tungsten-premium-nozzle-reloaded_]
====

== Ventoinhas (fans)

As ventoinhas são componentes importantes de uma impressora 3D e não são usadas somente no extrusor; podem servir
também para resfriar a CPU da impressora ou como exaustor dos vapores de plástico em impressoras 3D fechadas ou
até como homogeinizador do ar quente em equipamentos com câmara aquecida.

Os tipos de ventoinhas usados em impressoras 3D apresentam pontos em comum com as usadas em PCs. São basicamente
motores sem escova (__brushless motors__) equipados com pás para gerar um fluxo de ar. As mais simples têm apenas
dois fios (terra e Vcc) e um circuito interno básico que gera as formas de onda para girar as pás. As com três
fios geralmente usam o terceiro para informar a velocidade do rotor ao controlador e se houver um quarto fio ele
serve para controlar a velocidade através de PWM (explicada mais adiante na parte sobre motores) -- o que não
é geralmente necessário pois a variação do Vcc já costuma ter esse efeito.

As medidas mais usadas de ventoinhas são 30mm e 40mm, esta medida sendo da aresta lateral da ventoinha e não
da diagonal. Note que este medida não tem nada a ver com a corrente (energia) consumida pela ventoinha nem pela
vazão de ar, esses dados sendo independentes e variando com o modelo e fabricante. Infelizmente são poucos que
dizem a vazão de seus modelos -- dada geralmente em **cfm**, cubic feet per minutes ou pés cúbicos por segundo;
valores bons seriam por volta de 4 cfm para 30mm e 8 cfm para 40mm. As de 40mm são usadas em componentes mais
genéricos como o microcontrolador e as de 30mm, por seu tamanho mais compacto, em extrusores -- uma tendência
que tem aumentado à medida em que eles se tornam mais compactos. No caso de ventoinhas para câmaras, os tamanhos
mais usados estão entre 80 e 120mm.

Em quase todos os casos, a tensão requerida pela ventoinha acompanha a da fonte de energia da impressora por
conveniência e simplicidade -- uma impressora com fonte de 12V usará ventoinhas de 12V. Exceções acontecem
quando há ventoinhas usadas em série (e.g. uma fonte de 24V energizando duas ventoinhas de 12V) ou a ventoinha
é de um modelo especial de alta vazão ou eficiência (e aí se envolve um conversor de tensão -- por exemplo,
de 12V para 5V).

As ventoinhas mais baratas usam um _mancal_ (bucha) lubrificado em contato com o eixo do rotor e têm vida média
estimada em cerca de 30.000 horas a 40°C e costumam indicar estar no final de sua vida útil por aumentar bastante
o ruído, dado que o lubrificante interno acaba secando. A instalação horizontal deste tipo de ventoinha diminui
sua vida útil por fazer o lubrificante se concentrar emum dos lados do eixo. As mais sofisticadas e caras usam
rolamentos de esferas, algo que lhes garante uma vida útil maior -- cerca de 50.000 horas a 40°C, e não sofrem
de limitações de instalação horizontal. Existem ainda tipos bem mais sofisticados de ventoinhas, com mais
rolamentos, com rolamentos de rifle, rolamentos magnéticos, cerâmicos ou até rolamentos de fluido dinâmico,
que saem do escopo do tratado aqui por virtualmente não serem usadas em impressoras 3D de mercado.

*Funis ou dutos de ventoinha e ventoinhas radiais* -- em determinado momento o leitor pode se tocar que deixar
uma ventoinha de bico virada na ‘direção geral’ da impressão pode não ser a estratégia mais eficaz, visto
que o ponto a ser refrigerado, o plástico saindo do bico, é bem circunscrito; um jeito muito mais eficiente seria
concentrar o fluxo de ar neste ponto, papel que alguns elementos conhecidos como _funis_ ou _dutos de ventoinhas_
tentam fazer (como o da figura 65). No entanto, a dinâmica de fluidos não é algo tão direto assim
e a turbulência interna ao duto é tão grande que efetivamente reduz e muito a eficiência de resfriamento de
uma ventoinha afunilada, pois o vento chega extremamente amortecido ao bico. Para ventoinha de bico, existe um
elemento com eficiência muito maior, que é a ventoinha _radial_ ou __centrífuga__, tratadas em inglês como
"blowfans" ou "blowers". Para a construção de impressoras 3D, a desvantagem dessa ventoinha é seu
tamanho e preço: as variedades encontradas são mais caras que as comuns e geralmente de 40 ou 50mm de lado,
sendo praticamente impossível encontrar uma de 30mm.

[[fotoblowfan1]]
image::fotoblowfan1.png[fotoblowfan1,width=546,height=570,align="center"]

[NOTE]
.Notas:
====
. http://www.nmbtc.com/pdf/engineering/fans_ball_vs_sleeve.pdf[_http://www.nmbtc.com/pdf/engineering/fans_ball_vs_sleeve.pdf_]
====

== Elementos para aferição da temperatura

Como foi citado quando os endstops foram descritos, é importante haver elementos de mensuração da resposta
aos comandos enviados para a impressora e, assim como aferição do posicionamento é importante, aferição da
temperatura dos componentes aquecidos também é; em uma impressora 3D FFF, ao menos o hotend será aquecido,
opcionais sendo a mesa ou a câmara onde é construído o objeto.

O elemento aferidor, cumprindo a função de __termômetro__, tem vários nomes dependendo da tecnologia que o
embasa. Numa lista não-exaustiva, os principais tipos são:

* **Termorresistor**, *RTD,* *termômetro de resistência* ou *resistor térmico* caso seja um componente passivo
cuja resistência aumente com a temperatura; por esse mesmo motivo também são chamados "**termistores PTC**",
onde PTC vem de Positive Temperature Coefficient, ou Coeficiente de Temperatura Positivo em inglês. Um termorresistor
particularmente eficaz e barato usado em algumas repraps é o _PT100_ (às vezes confundido com termopar). No entanto,
devido à baixa sensibilidade do microcontrolador a esses tipos de circuitos, eles necessitam de amplificação
do sinal (circuito externo) para oferecerem mensurações úteis.
* **Termistores NTC**, às vezes chamados
simplesmente de *termistores* sem qualificativos adicionais, são o tipo mais comum em impressoras 3D domésticas
pela simplicidade de uso e preço, e são componentes passivos cuja resistência diminui com a temperatura. Como
têm maior variação (exponencial) com a temperatura que RTDs, não precisam de amplificação. Um termistor
NTC bem popular em repraps é o EPCOS 100K, sendo vendido a preços muito baixos e aguentando temperaturas até
perto de 300°C. Ultrapassando esta temperatura é virtualmente impossível encontrar termistores NTC no mercado,
excetuando o caso muito específico do termistor do "Pico Hotend", um item exclusivo (ou seja, até o momento
não existem réplicas genéricas) feito com tecnologia de ponta.
* *Termopares* são dispositivos elétricos
formados de dois diferentes condutores (geralmente metais) formando uma _junta elétrica_ e produzindo a partir
dela _tensão elétrica_ que pode ser medida por circuito especializado. Na maioria das impressoras 3D de baixo
custo, termopares não podem ser ligados diretamente ao microcontrolador, necessitando de circuito adicional de
amplificação e compensação da junta que eleva bastante o custo, tamanho e dificuldade de integração. Por
outro lado, termopares são mais diversos que termistores, sendo mais fácil achar aqueles cuja faixa de temperatura
exceda os 300°C (útil para materiais mais avançados).

Cada um desses elementos tem seus proponentes e detratores, com alegações envolvendo preço, disponibilidade,
precisão e faixa de uso. Mas na prática o uso de um ou outro faz pouca diferença, pesando mais quando se ultrapassa
a faixa de 300°C, necessária para alguns materiais "difíceis" ou "industriais" como policarbonato, alguns
nylons, PEEK e PEI, que têm migrado do mundo industrial para o doméstico com a sofisticação das impressoras
3D de baixo custo.

== *Mesa (Plataforma de Impressão)*

Numa impressora 3D FFF, a plataforma de impressão de uma impressora 3D é a parte do equipamento que sustentará
a peça enquanto está sendo produzida. Além da sustentação, a mesa deve dar ainda suficiente estabilidade e
previsibilidade para o mecanismo envolvido (por exemplo, não deve introduzir ou repassar vibrações, nem permitir
que a peça se volte) e até ajudar na manutenção térmica (caso das mesas aquecidas). A mesa pode ainda ser parte
do mecanismo generalizado de aferição das dimensões, como no caso do autonivelamento. Pode ainda ser rígida ou
flexível dependendo da estratégia em relação ao material, móvel ou estática dependendo do arranjo dos eixos,
de metal, polímero ou outros materiais de acordo com as afinidades químicas. Apesar de o caso mais simples ser
de impressoras sem aquecimento, o default aqui analisado será a mesa _aquecida_ visto que se pode inferir o uso
das mesas sem aquecimento a partir delas.

.Mesa aquecida

Vamos começar por algo que nem sempre é reconhecido: a mesa _aquecida_ é um artefato da estratégia de barateamento
do projeto RepRap. Antes dele, as impressoras FDM não usavam mesas aquecidas; com construção industrial e peças
caras, as impressoras 3D da Stratasys fazem sua impressão dentro de uma câmara fechada com a temperatura elevada
e constante, com isolamento sofisticado para os componentes sensíveis ao calor. E para que serve essa câmara
aquecida? Como veremos com mais detalhes na seção sobre materiais, alguns materiais como ABS e policarbonato
necessitam esfriar o mais lenta e uniformemente possível pra não se soltarem da plataforma nem terem rachaduras
e deformações. Dado um volume pequeno de impressão, entretanto, se apenas a plataforma de impressão tiver
aquecimento e a peça não estiver muito exposta, o efeito é aproximadamente o mesmo de uma câmara.

Embora virtualmente todos os materiais usados em impressão FFF se beneficiem de um resfriamento mais lento e
uniforme, em alguns deles, como PLA e PETG, o efeito é pequeno o suficiente para poder ser ignorado; algumas
impressoras 3D do mercado abdicam de aquecimento da mesa para conseguir barateamento máximo das peças, menor
gasto de energia (já que o circuito de aquecimento da mesa é o mais dispendioso de uma impressora 3D) ou ainda
controle mais restrito dos materiais usados. A Impressora 3D brasileira _Stella_ (derivada da reprap __Smartrap__)
é um exemplo bem conhecido do barateamento das peças e a Makerbot Replicator 2, feita apenas para PLA, é um
bom exemplo do controle restrito.

O mercado também começa a ver suas primeiras impressoras 3D de baixo custo com câmara aquecida. Embora a Stratasys
faça _patent fencing_ da técnica com a patente US-6722872-B1, a patente registrada nos EUA, válida até 2020,
cobre apenas câmaras com motores externos a ela e com barreiras flexíveis.

.Modelos de Mesa Aquecida

Não há um só modelo de mesa aquecida. Há vários tipos e é bom entender essas diferenças, que podem inclusive
afetar a qualidade das peças. Fatores de importância na construção de uma mesa são a condutividade térmica,
a uniformidade da temperatura em toda sua área (especialmente para materiais propensos a __warp__, como ABS),
facilidade de montagem, eficiência de operação. A lista a seguir não é exaustiva:

* *Mesa com resistências* -- foram as primeiras a surgir. Resistências simples são elementos aquecedores fáceis de
construir; a construção consiste de uma mesa geralmente de metal com blocos de resistência igualmente espaçados
colados abaixo. Os blocos fazem a mesa ser grossa na construção e o fato de serem "ilhas" de calor torna
a temperatura da mesa não-uniforme. Dependendo do metal, a mesa pode apresentar empenamento.
* *Mesa de PCB resistiva (MK1, MK2)* -- Josef Průša inventou a primeira versão de mesa resistiva em "PCB" (Printed
Circuit Board), isto é, uma placa de circuito grande com uma trilha que faz o papel de uma longa resistência
em serpentina em toda a área. Deste modo se consegue uma boa uniformidade do aquecimento e o material da placa
(fibra de vidro usada para circuitos) é bastante fino, permitindo fácil montagem. Há também espaço para leds
estilo "SMD" que dão status se a placa está recebendo corrente ou não. Outra versão, MK2 / MK2A -- não
sucessora, mas alternativa - melhora o design tendo uma reentrância para o alojamento da cabeça do termistor
e também aumenta a área disponível para soldar os contatos. Há uma versão chamada de MK2B que tem pinagens
diferentes oferecendo resistências diferentes, de modo que a mesa possa ser usada com fontes de 12V ou 24V. Um
dos maiores problemas do circuito impresso é a tendência a empenar.
* *Mesa de alumínio resistivo (MK3)* -- a
próxima versão da mesa trocou o circuito impresso pelo alumínio (com a mesma trilha resistiva), que é um metal
com alta condutividade térmica; assim a uniformidade de temperatura da mesa fica ainda mais alta. No entanto,
há que se considerar uma desvantagem na segurança que é o fato de o alumínio ser metal e portanto condutor de
eletricidade, e trilhas descobertas ou excesso de alimentação terem potencial maior de gerar faíscas, curtos e
acidentes do que a fibra de vidro isolante.
* *Mesa de metal com manta aquecida de silicone* -- uma solução que
traz maior isolamento da alimentação do que a mesa de alumíno resistivo é a mesa de metal (geralmente aço inox
ou alumínio) com uma manta de silicone colada. A manta de silicone é uma forma de resistência aquecedora segura,
bem isolada e de grande variedade de formas, tamanhos e tensões suportadas. Não é tão fina como uma trilha de
circuito, entretanto, e o volume e peso, ainda que não exagerados, podem ser um ônus em mesas móveis, sendo
mais recomendadas para mesas aquecidas estáticas ou de movimentação em Z.
* *Mesa de metal com resistência impressa em película de poliimida (kapton)* -- solução semelhante à de manta de silicone, com a vantagem de
a película usada ser extremamente fina. Infelizmente, os preços das películas sobem estratosfericamente para
áreas maiores que 10cm x 10cm, tornando-se superiores aos das próprias mesas com resistências embutidas.
* *Mesa de alumínio acoplada a mesa resistiva* -- consistindo de uma solução "Maker" para medidas de mesa
não-convencionais, consiste de usar uma baratíssima mesa aquecida resistiva como a MK2 e colar em uma placa maior
de alumínio (digamos, de 250x250mm para uma MK2B de 214x214mm) usando um adesivo térmico como a fita dupla-face
de transferência térmica 467MP da 3M.
* **Mesa aquecida (qualquer tipo) com isolante térmico** -- uma ajuda que
costuma impedir que a mesa perca energia por baixo é colar uma placa de isolante térmico na parte de baixo dela,
que não está em contato com a peça. Um dos materiais mais baratos e fáceis de utilizar para esse fim é placa
adesiva de cortiça, encontrável em lojas de ferragens ou materiais de construção.  1.  [[vidro-da-mesa]] ===
Vidro da Mesa

As impressoras 3D da Stratasys nunca usaram vidro e as primeiras impressoras 3D reprap também não. Hoje em dia,
entretanto, o uso de uma placa de vidro removível acima da mesa é tão generalizado que pode ser difícil encontrar
uma que não o use. Algumas fabricantes dispensam o vídro para disponibilizar uma superfície de material próprio
que o substitui.

O uso de uma placa de vidro sobre a mesa tem as seguintes utilidades:

* **Nivela a superfície**. Vidro é um dos materiais com usinagem retilínea mais facilitada, mais do que
metais e PCB que são os materiais usados na mesa. Prender um vidro a elas não só faz com que a impressão
tenha uma superfície mais uniforme, como as "corrige" prevenindo empenamentos e deformações.
* **Evita stress mecânico nas peças da impressora**. Uma impressão 3D finalizada raramente se solta espontaneamente da
mesa; ela pode oferecer resistência ao destaque, que pode ser inclusive danoso às peças da impressora se exigir
muita força. Ter uma superfície facilmente removível, para que a peça possa ser destacada em local apropriado,
ajuda muito na vida útil da máquina.
* **É um material resistente a muitos produtos químicos**. Como é comum
usar métodos de aderência de superfície, o vidro é um material excelente para isso, sendo resistente à grande
maioria dos solventes.
* **É um material com ótima tolerância para plásticos e colas**. A superfície lisa e
a polaridade das moléculas do vidro facilita que a impressão adira à superfície, ao mesmo tempo que dificulta
que essa aderência seja muito forte. E também é um material que aceita com muita facilidade ser revestido com
colas ou fitas que ajudem a aderência.
* **É um material barato e descartável**. Vidraçarias comuns fazem
o serviço de cortar placas retangulares de vidro de quaisquer tamanho por baixo preço. Deste modo, mesmo que
a placa de vidro eventualmente sofra danos pelo manuseamento incorreto ou excesso de pressão mecânica, ela é
facilmente substituível, e costuma ficar bem dentro do orçamento de um profissional de impressão 3D algumas
placas de vidro de reserva para essas eventualidades.
* **Como é removível e barato, permite a substituição imediata e poupa tempo**. Terminou a impressão e precisa
começar outra? Remova o vidro com a peça, coloque  novo vidro e inicie a nova impressão imediatamente. Enquanto
a segunda impressão prossegue, usa-se o tempo para remover a primeira do vidro.

No entanto, nem tudo são vantagens. Usar um vidro sobre a mesa aquecida tem seus próprios reveses:

* **Vidro tem baixa condutividade térmica**. A condutividade térmica do vidro é muito baixa -- 0,8 W/mK, para
efeito de comparação a do alumínio é 204 W/mk -- e isso tem um efeito dramático nas mesas aquecidas. Com as
potências e tamanhos típicos de impressoras 3D modernas, um vidro de 3mm de espessura pode abaixar a temperatura
por uns 15°C. Por causa disso, é sugerido o uso de vidros de baixa espessura, 2 ou 3mm são suficientes para um
bom equilíbrio entre resistência e eficiência térmica.
* *Vidro é um material denso* (2500 kg/m^3^) e portanto
para os modelos de impressoras 3D que usam mesas móveis, seu peso será um ônus para a movimentação. O motor
que movimenta a mesa tem que ser escolhido já levando em conta o peso adicional da mesa na inércia de trabalho.
* *Vidro é cortante quando quebrado* e portanto há perigo em se manuseá-lo.

Se entende, portanto, que alguns fabricantes tentem substituí-los por placas de outros materiais ou até evitá-lo
completamente. Mas é bastante difícil encontrar um material tão prontamente disponível e com propriedades
desejáveis quanto o vidro. Note-se que alguns profissionais costumam mandar cortar placas de vidros reforçados,
como vidro de __borossilicato__, _temperado_ ou __sitall__, mas isso aumenta bastante o custo e costuma não valer
o acréscimo visto que um vidro comum corretamente manuseado não tende a quebrar. Alternativamente algumas pessoas
utilizam espelhos ao invés de vidros, a fina camada de prata reflexiva ajuda um pouco na condutividade térmica
e tem apelo estético para fotografias, também ajudando a aferir visualmente a distância do hotend pra mesa.

.Aderência à mesa

Durante o processo de impressão, é essencial que a peça impressa fique o mais imóvel possível na superfície
plana da mesa. Qualquer balanço imperceptível para os olhos, qualquer deslocamento por mínimo que seja terá
resultados visíveis no acabamento da peça, isso quando não arruína a impressão. Além disso, boa aderência
é indispensável quando se usa mesa aquecida pra se contrapor aos efeitos do _warp_ nos plásticos mais propensos
a isso, como ABS e policarbonato, mantendo as quinas da peça uniformes sem levantar.

Para as técnicas de aderência, ter uma peça destacável como o vidro torna-se ainda mais importante. Pode-se
aplicar um produto químico que, finda a impressão, será simplesmente lavado do vidro, assim como outras impurezas
e resíduos do processo.

Note-se a curiosidade que esse é provavelmente o item mais explorado pela comunidade de __Makers__, curiosos e
interessados por impressão 3D, que aproveita a disponibilidade moderna de produtos industrializados com todo tipo
de composição química para utilizar suas propriedades de aderência e compatibilidade.

Um auxiliar de aderência ideal deve ter as seguintes propriedades:

* **Ter aplicação fácil**, já que cada passo extra no fluxo de trabalho conta negativamente.
* **Ter remoção fácil**, no sentido de não haver muito trabalho de removê-lo, ou a seus resíduos.
* **Ter preço acessível**, especialmente porque será um consumível;
* **Ter compatibilidade com o material de impressão**, pois alguns métodos têm compatibilidade com certos plásticos e não outros;
* **Ter repetibilidade**, ou poderser usado mais de uma vez;
No caso de mesa __aquecida__:
* **Ter poder de aderência constante ou crescente com a temperatura**, pois como a mesa estará aquecida durante a impressão e esfriará ao seu término, compostos cuja aderência se degrada com o aumento de temperatura não serão muito úteis. Existem aqueles cuja aderência
aumenta quanto mais se aumenta a temperatura, esfriando ao terminar com uma diferença tão grande que a peça se
solta espontaneamento com um estalido.
* **Ter resistência ao aquecimento**, pois não adianta um líquido que
evapore ou uma fita que se degrade ou perca a cola quando a mesa se aquece.

Como a aderência é uma "questão em aberto" na Impressão 3D com muitos indivíduos propondo novos meios a cada dia,
é impossível fazer justiça a todos eles ou mesmo listá-los abrangentemente. A abordagem deste livro consiste
somente de listar os métodos e técnicas mais usados no presente momento, advertindo o leitor que isso pode mudar
rapidamente com o advento ou popularização de novas soluções. Como foi dito na introdução, alguns dos métodos
mostrados aqui serão exemplos gritantes de __exaptação__.

Note o leitor, ainda, que embora os métodos de aderência sejam uma _contingência_ eficiente contra o warp _nas
primeiras camadas_ da impressão, eles não são uma __solução__.^1^ Além disso, tais métodos não anulam a
importância de outros fatores na aderência, como *uma primeira camada bem esmagada* (hotend bem próximo à mesa)
como veremos na parte de fatiamento.

Os métodos de aderência se enquadram em três categorias:

* *Fitas*: São colocadas sobre a mesa ou o vidro usualmente por toda sua área, com as tiras em paralelo
sem que uma passe sobre a outra para não causar desnível na superfície. Costumam durar um número pequeno
de impressões, começando a rasgar ou descolar da superfície com o uso. Geralmente os rolos de fita estarão
disponíveis em variedades de 12, 24 e 48mm de largura, com as mais largas (48mm) sendo recomendadas.
** *Fita kapton* -- método muito popular quando do início das impressoras 3D domésticas, *Kapton* é marca registrada de
uma fita colante do material **poliimida**, que aguenta altas temperaturas (500°C) sem deteriorar e sem perder a
aderência. A fita com sua cor característica dourado translúcido tem boa compatibilidade molecular com plásticos
e a aderência pode ser aumentada com colas ou tornando sua superfície lisa mais irregular com massagem com palha
de aço. Tem aderência média e funciona melhor quando aplicada diretamente em uma mesa de alumínio do que
no vidro. Um ponto baixo do kapton é a sua __dificuldade de aplicação__, visto que é uma fita que rasga com
facilidade e que precisa ser aplicada com bastante jeito na superfície para não deixar bolhas. Por outro lado,
tem repetibilidade alta, podem ser usada muitas vezes seguidas até a próxima aplicação. A fita também é usada
em vários componentes de impressora 3D devido à sua resistência à temperatura, como para ajudar a fixação
dos termistores na mesa e hotend. +
Um substituto eficiente da fita kapton que tem basicamente a mesma dinâmica
de aplicação, mas maior aderência quando aquecida, maior resistência a rasgos e ainda maior facilidade de
aplicação sem bolhas é a **fita PET**, infelizmente um insumo quase impossível de se achar no Brasil.
** *Fita azul de pintor / fita crepe azul* -- esta fita, vendida no Brasil principalmente pela 3M (modelo 2090), é
uma fita crepe com adesivo mais forte que a comum e uma *cobertura de acrílico* que tem grande compatibilidade
química com a maioria dos plásticos, e aderência a eles que aumenta com a temperatura. Tem repetibilidade
baixa pra média, com peças grandes favorecendo que a fita descole e rasgue.
* *Superfícies adesivas*: São folhas de materiais especiais cortados na mesma medida que a mesa ou vidro da impressora 3D e
colados sobre elas. Funcionam como materiais adesivos especiais e duráveis cuja aderência aumenta com a temperatura. No
Brasil não são técnicas muito usadas porque geralmente os materiais são caros (muitas vezes tendo que ser importados);
a variedade nacional de tamanhos de mesa de impressora 3D também dificulta um pouco o uso, ainda que um modelo
maior possa ser cortado.
** *PEI (polieterimida)* -- folha de material translúcido nas cores âmbar ou azul com
alta afinidade com plásticos e alta durabilidade. Curiosamente, é também a base da família de filamentos de
alta temperatura da Stratasys, criados pela Sabic e chamados de "Ultem".
** *BuildTak, PrintBite, Fleks3d e semelhantes* -- marcas comerciais que usam a mesma idéia: uma folha flexível
de material plástico adesivo que é grudada na mesa e tem alta afinidade com ABS e PLA, com a aderência aumentando
com a temperatura. Têm dois tipos principais: as que são realmente lâminas flexíveis e finas (BuildTak. PrintBite)
ou grossas e não tão flexíveis (Fleks3D). As primeiras geralmente são coladas na mesa até desgastarem, as segundas são
encaixadas e preparadas para serem removidas e até "flexionadas" ligeiramente para soltarem as peças.
** *Polaseal* -- este plástico é adquirido em papelarias e é o popular "plástico de plastificação". Ele é cortado,
colocado sobre o vidro e aquecido até grudar, para então servir de superfície adesiva para impressões.
* *Colas, sprays e líquidos*: Pode estranhar à primeira vista saber que _colas_ são usadas para fixação
de peças impressas em uma plataforma já que geralmente a palavra é associada à soldagem permanente de uma
parte em outra, mas colas temporárias fazem mais parte do dia-a-dia do que geralmente se admite: papeizinhos de
__post-it__, fita crepe e fita para pintura são alguns dos exemplos.  +
Note-se que as colas podem ser usadas em
combinação com as fitas, gastando-se um pouco mais para unir as vantagens de um método ao outro.
** **Cola PVAc (cola branca escolar)^2^**: é usada majoritariamente com PLA, plástico que já tem maior aderência ao vidro por
natureza. Apesar de ser uma **cola fraca**, sua grande vantagem é a facilidade de remoção, deixando resíduos
mínimos e laváveis. É aplicada gotejando sobre o vidro e espalhando.
** **Cola Bastão com PVP**: as colas em
bastão escolares costumam vir em duas variedades, as baseadas em glicerina e as com um composto listado como PVP --
polivinilpirrolidona ou polivinilpirrolideno -- que contém as propriedades desejadas para um auxiliar de aderência,
especialmente a aderência aumentada a altas temperaturas. A aplicação é bem fácil e deixa praticamente zero
resíduos. A aderência é fraca quando fria e média quando quente. Usada geralmente com PLA e ABS. Curiosidade:
álcool em gel também tem PVP k120, uma variedade especialmente adesiva, portanto usado por alguns como auxiliar
de aderência.
** **Cola de PVC**: essa cola na verdade é o plástico PVC diluído em solvente. É um produto
fácil de achar com __aderência média pra alta__ e __aplicação fácil__. Deixa entretanto muitos resíduos ao
final da impressão e não é tão simples de remover. Usa-se principalmente com ABS, por sua força de aderência.
** **Spray de cabelo**: idéia advinda da criatividade dos usuários, mostra bem o conceito de "exaptação"
(adaptar algo para uma finalidade diferente da que foi concebido). Funciona bem, tem __aplicação fácil__ com
__aderência média__ e deixa praticamente zero resíduo. Muitas marcas brasileiras funcionam bem para este
propósito, duas reconhecidas pelo público são Karina e Fixit. Um revés do spray de cabelo é que a aplicação
dele direto na mesa pode atingir partes que devam ficar lubrificadas e sem atrito, como as barras lisas dos
eixos. Por isso se recomenda aplicar no vidro destacado da mesa. Usa-se com ABS e PLA.
** **Gelatina sem sabor**: Consta como idéia brasileira documentada no projeto reprap ("Jello Solution"), com uma parte
de gelatina para 10 partes de água com gotas de própolis para impedir crescimento de bactérias; espalha-se com um algodão
no vidro e tem aderência média, usável com ABS e PLA.
** **"Suco de ABS**": este é o nome informal dado ao
ABS dissolvido em acetona pura. Se sua impressão deixou restos, você pode aproveitá-los dissolvendo em acetona
(não serve a de farmácia/supermercado) na proporção de 1 g de ABS pra cada 10ml de acetona; este composto é
aplicado na mesa que é aquecida, fazendo a acetona evaporar e criando uma camada muito fina de plástico ABS
grudado ao vidro. Este método tem __aderência média__ mas deixa resíduos -- que felizmente são **fáceis 0de remover**.
Não é um método popular no Brasil devido à dificuldade de adquirir a acetona pura - em lojas
de laboratório, com permissão da polícia federal e limite mensal de 2l. Só funciona com ABS, sua aplicação
pode atrapalhar a impressão com outros plásticos.
* **Produtos Profissionais para impressoras 3D**: O mercado
brasileiro já entendeu que as impressoras 3D estão em expansão e precisam de insumos próprios. Por isso,
indivíduos e empreendimentos inovadores criaram e estão criando soluções que ajudam no fluxo de trabalho
e entre estas, estão as soluções para aprimorar a aderência.
** *Spray de aderência (Cliever)*: É um
produto profissional vendido em frascos de spray de 100ml com aplicação fácil, resíduo virtualmente zero e
alta aderência, sendo esta sua principal vantagem e seu único problema: a aderência é tão alta que pode ser
bastante difícil remover a peça no final, necessitando de submersão em água com detergente para diluição e
arriscando a arrancar "lascas" do vidro. Recomendado para todos os materiais, não só PLA e ABS mas também os
difíceis como policarbonato e nylons.
** *A.Bond (líquido adesivo)*: Mais econômico que o Spray da Cliever
e disponível por vários fornecedores, utiliza PVP em sua composição e vem em frascos de 50 ou 100ml, com
aplicação fácil, resíduo virtualmente zero e aderência baixa em temperatura ambiente e alta com temperaturas
acima de 80°C. A aderência menor em temperaturas baixas ajuda bastante a remoção de peças no final, tornando
seu uso praticamente indolor, e com o líquido sendo também facilmente dissolvível em água caso a remoção
não seja imediata. O produto A.Bond funciona muito bem tanto para ABS quanto PLA, PETG e Tritan, mas não parece
funcionar bem para alguns plásticos menos usados, como policarbonato e PEAD.

[[metodosdeaderencia1]]
image::metodosdeaderencia1.png[metodosdeaderencia1,width=642,height=238,align="center"]

O leitor se sentirá confuso: com tantas opções, qual usar? É impossível receitar qualquer um desses métodos
sem cometer injustiça com os outros, e o fato de todo serem usados com seus proponentes apaixonados significa que
pelo menos alguns indivíduos encontraram o equilíbrio de uso neles. Mas como um ponto de partida, é possível
citar quatro casos de uso distintos e uma sugestão particular para cada um deles:

* **Somente PLA, sem mesa aquecida**: Neste caso de uso, o usuário da impressora 3D usa apenas o material PLA,
com ou sem mesa aquecida. Este caso inicial é o mais fácil de tratar porque o PLA tem propriedades quase ideais
para fixação: alta aderência entre camadas, alta aderência com o vidro e baixo "warp" (deformação com
resfriamento). Neste caso a *cola PVAc* resolve muito bem o problema: aplicação fácil, pouco resíduo e baixa
aderência. Como o PLA tem alta aderência, há maior probabilidade de haver aderência em excesso do que em falta,
e se a peça grudar com muita força, basta um banho de água morna com uma gota de detergente para dissolver a
camada de cola e soltar a peça. Outros métodos que podem ser usados de maneira quase idêntica: cola em bastão
e fita azul.
* **PLA e ABS, ou majoritariamente ABS, e peças pequenas (< 5cm)**: Neste caso de uso, uma solução
econômica seria o spray de cabelo direto no vidro. Fácil e direta.
* **PLA e ABS, ou majoritariamente ABS, e peças de qualquer tamanho**: Neste caso de uso, o A.Bond no vidro seria uma opção indicada, por suas características
de economia, facilidade de aplicação e de remoção.
* **PLA, ABS, materiais exóticos e peças muito delicadas**: Sendo este o caso de uso do autor, será dada certa
_licença poética_ para uma opinião mais subjetiva sobre
o melhor método, lembrando sempre ao leitor que a resposta para um indivíduo não é automaticamente aplicável
a outros, tanto pela disponibilidade de materiais quanto pelos modelos de impressora, fluxo de trabalho e outras
variáveis que interferirão. Com isto fora do caminho, detalhamos o uso: o autor usa impressoras 3D como máquinas
de desenvolvimento e experimentação, com porcentagem relativamente baixa de materiais "comuns" - uso de
ABS e PLA estimado em menos de 50% das impressões. Muitos dos materiais obtidos pelo autor são experimentais
inéditos criados em alguma parte do mundo, ou mesmo mandado extrudar sob encomenda para experimentação. Nisso se
incluem metais pulverizados misturados em plástico, fibra de carbono, poliacetal, polietileno de alta densidade,
10 variedades diferentes de filamentos flexíveis, imitação de madeira e muitos outros. As experiências e testes
com adesivos já renderam desde impressões que sequer conseguem que o plástico fique parado na mesa quanto as
que se soldaram com tanta força ao vidro que resultaram em vidros estilhaçados na tentativa de remoção, tanto
quanto lascas desprendidas em muitos casos. Adicione-se o fato que muitas vezes são feitas peças com geometria
experimental ou rebuscada e extremamente delicada, em que **qualquer pressão mecânica pode despedaçá-la**,
em materiais que podem ser *10 vezes mais caros* que os comuns de mercado. Portanto, o __espectro de uso__ aqui é
desproporcionalmente largo, e foi procurada uma solução universal que não necessitasse de muita experimentação
ou tentativas. +
A solução encontrada tirou vantagem de uma propriedade dos tipo de métodos descritos: as *colas*
podem ser usadas com **as fitas**. A estratégia-base, portanto, é usar a **fita azul de pintor**, e as *diversas
colas conforme a necessidade:
* **Fita azul pura**: para PLA, peças pequenas de ABS e filamentos fáceis e
de alta aderência, como flexíveis ou PETG.
** **Fita azul com spray da cliever**: para quase todo o resto,
especialmente os materiais difíceis como policarbonato e nylon. Para ABS pode-se aplicar A.Bond.
** **Fita azul com cola PVAc**: ainda que seja uma cola fraca, a dissolução fácil dela e a grande afinidade com alguns tipos
de materiais dá à cola branca uma série de vantagens; ela interage bem com materiais que têm afinidade com
a celulose, como o PEAD e poliacetal; ela também dá uma aderência sutilmente aumentada a peças que se julga
anteriormente serem mais difíceis no caso de PLA e pequenas de ABS. +
Este workflow tem a vantagem de funcionar
quase sempre. É fácil saber qual dos três casos usar e é praticamente impossível errar por menos, sendo mais
frequente que a peça fique muito aderida ao vidro. O autor já deixa um recipiente com formato próximo ao da
mesa com água morna e uma gota de detergente preparados. A água morna (~35°C) é usada porque essa temperatura
facilita a ação de solvente; a gota de detergente para romper a tensão superficial da água e permitir que ela
adentre pelos poros da fita. Quando a fita absorve a água ela não somente tem sua cola diluída, mas também se
expande; e com a expansão, contribui para o destacamento da peça. Com isso a peça **nunca é submetida a tensão mecânica**,
não terá cantos forçados por instrumentos, e se desprende graciosamente da superfície, junto com
a fita.^3^ +
Outras vantagens da fita azul reconhecidas pelo autor: uniformiza a planicidade do vidro, compensando
pequenos riscos, saliências ou até mesmo buracos de lascas; deixa uma superfície opaca e de cor saturada na mesa,
possibilitando o uso de câmera térmica (que não funciona bem com metais e superfícies reflexivas ou transparentes) e
o uso de endstops ópticos, e ainda dando uma aparência mais colorida, agradável e facilmente distinguível pra visualizações
remotas por câmera e confecção de fotos e vídeos educativos ou promocionais.

[NOTE]
.Notas:
====
. Isso é uma questão bastante delicada, pois certos indivíduos parecem enxergar a contração do plástico
no resfriamento __como algo evitável__, e __não é__. Em cada temperatura e pressão específica, o plástico,
assim como outros materiais, tende a ocupar um determinada volume, e qualquer desvio deste volume gerará forças
que saem facilmente da faixa tratável quando há diferenças significativas de temperatura pelo material. Neste
caso, a base da peça pode até permanecer firmemente aderida à superfície, mas o plástico logo acima sofrerá
warp e se destacará entre as camadas, no que se apelido de "delaminação"; nos casos extremos, as forças
de contração conjugadas com a alta aderência podem inclusive quebrar o vidro. Portanto, a _solução_ para o
warp e delaminação não é o "adesivo perfeito", e sim uma câmara ou componente aquecido que permita ir
resfriando a peça vagarosa e uniformemente, impedindo grandes diferenças de volume de deformá-la.
. Embora a "cola de PVAc" seja mais tratada de "cola de PVA", utilizamos a expressão menos ambígua
para nos referir ao __Acetato de Polivinila__, pois um outro composto que também tem utilidade no meio de impressão
3D usa a mesma sigla, mas é um álcool: __Álcool de Polivinila__. É utilizado como matéria-prima para filamento
dissolvível em água.
. Sempre que se menciona o destacamento da peça por submersão em água, lembre o leitor que diferenças
grandes de temperatura tendem a deformar a peça, portanto não é bom colocá-la ainda "morna" na água. O
ideal é aguardar um tempo para esfriar.
====

.Autonivelamento de Mesa (Bed Auto Leveling ou BAL)

Uma das maiores preocupações para se conseguir uma boa qualidade de impressão é começar com o pé direito. Em
termos mais técnicos, é se preocupar com a primeira camada: é a etapa mais importante de toda a impressão,
pois se o plástico depositado estiver bem rente, terá boa aderência -- se for rente demais, pode entupir o
hotend ou até arranhar o vidro; se a mesa estiver mal nivelada, um canto da peça estará mais "levantado" que
outro. Os processos industriais de construção de impressoras 3D não conseguem garantir precisão de peças de
forma que uma mesa fique perfeitamente nivelada com o plano formado pelos eixos X e Y; esse nivelamento, portanto,
acaba sendo feito na fixação da mesa por ajuste de parafusos de fixação, e quase sempre acaba tendo um desvio
imperceptível a olho nu, ou adquirindo tal desvio com o uso continuado da impressora 3D.

Normalmente esse desvio, ou inclinação relativa, da mesa, permanece dentro de intervalos bem pequenos -- digamos,
uma diferença de 0,2mm entre um canto e outro da mesa na distância ao carro X -- mas ainda suficientes para
prejudicar ou até arruinar uma impressão. A tarefa de renivelamento não é difícil, mas é laboriosa, repetitiva
e enfadonha. O tipo de tarefa que uma máquina faz melhor que um humano. Daí surgiu a idéia no **nivelamento
automático de mesa**.

O nivelamento automático estende a utilidade do **endstop**; por que não utilizar um endstop adicional no _hotend_
antes de ele começar a impressão? Um que ative quando o bico encostar na mesa, repetindo esta operação em
vários pontos pra se inferir a inclinação em relação aos eixos.

Este é o princípio básico do autonivelamento: medir, a partir do hotend, a inclinação da mesa. Se a mesa for
considerada um plano perfeito (apenas inclinado), três pontos no espaço tridimensional definem um único plano
passando por eles, então três medidas de Z em coordenadas (X,Y) bem espaçadas serão suficientes. Um número
maior de medidas ajuda a diminuir imprecisões, mas raramente se usa mais que 6.

Uma vez que se tenha a medida da inclinação deste plano, o _firmware_ -- o software que roda no microcontrolador
que controla a impressora -- passa a fazer transformações geométricas para cada coordenada passada para ele,
compensando a inclinação. "Recebi o comando para ir para o ponto (10,10,5) no espaço, mas dada a inclinação da
mesa, este ponto está na verdade em (10,11,4), então é para esta coordenada que vou me mover." Como estes pontos
serão, dada a inclinação pequena, bastante próximos, a impressão ocorre compensada sem problemas ou distorções.

[[autonivelamentoendstop1]]
image::autonivelamentoendstop1.png[autonivelamentoendstop1,width=622,height=500,align="center",title="Autonivelamento de mesa, com um endstop mecânico retrátil encostando na mesa visivelmente inclinada para medir a distância vertical. Créditos: Alex Borro, vídeo completo em https://www.youtube.com/watch?v=3IKMeOYz-1Q"]

Não que não haja desafios e novos problemas criados pelo autonivelamento. Pelo contrário, já nos deparamos com
um, que é a necessidade de dois componentes novos para a impressora: um endstop mecânico para medir a distância
até a mesa e um motor (do tipo servo motor) que levanta e abaixa este endstop -- imagine que se o endstop ficar
sempre abaixado, e abaixo do nível do endstop, ele baterá na mesa na primeira camada, sem contar na própria
peça durante a impressão; a impressão só deverá portanto abaixar o endstop durante a etapa de aferição do
nivelamento da mesa. Ou se integra a chave mecânica ao hotend, de modo que o hotend abaixa até encostar na mesa
e em seu suporte há uma chave com mola, que ativa com um leve levantar do hotend; essa abordagem funciona mas
tem a chance de entortar o bico de latão.

Não pára por aí. O endstop e o servo ocupam espaço que pode diminuir a área de impressão; o servo motor que
levanta e abaixa o endstop tem uma repetibilidade baixa, o que afeta enormemente a inclinação mensurada -- e
faz com que alguns abandonem o endstop mecânico, de contato, para utilizar um de distância para que não precise
ficar abaixo do nível do hotend, como um óptico, indutivo ou capacitivo. E nesse caso novos requisitos surgem em
relação ao material da mesa -- abriu-se uma caixa de Pandora, com fabricantes diferentes oferecendo soluções
diferentes, e muitas receitas diferentes para adaptar impressoras reprap feitas em casa para o autonivelamento.

Uma nota adicional sobre o autonivelamento é que as correções de coordenadas exigirão que a cada camada, diversos
movimentos adicionais no eixo Z sejam realizados, ao invés de um único movimento de subida a cada camada. Para
impressoras 3D que utilizam barras roscadas, que têm grande desgaste com o movimento vertical, isto é um ônus bem
grande, diminuindo bastante a vida útil destas peças. Este também é um campo fértil para soluções criativas;
um exemplo notável é a estratégia da impressora brasileira Sethi S3 que, uma vez medido o desnível da mesa,
usa deslocamentos fixos aos motores para ajustar um novo plano e compensar esse desnível.

== Motores

Mencionamos muitos elementos que envolvem motores: eixos, malhas abertas e fechadas, extrusores e até mesa,
e só agora chegamos a eles. Há uma razão para isso. A parte da engenharia que trata desses dispositivos é,
como muitos dos tópicos que envolvem impressão 3D, assunto espinhoso para resumir em um único livro. Motores
de todos os tipos e tamanhos estão em toda parte na sociedade moderna e é uma tarefa presunçosa e irrealizável
conseguir resumir tudo em poucas páginas.

Por outro lado, não faltam motivos para se precisar conhecer um mínimo sobre eles, no caso de impressão 3D. É
preciso saber como e quando eles costumam falhar; o que significa a nomenclatura, que tipos são usados, como os
_drivers_ funcionam, e como acontecem as famosas __perdas de passo__. Se uma reprap está sendo montada a partir
de sucata, é preciso saber que tipos e especificações de motores são apropriados para construí-la. Se uma
impressora 3D anuncia usar _servos_ no lugar de motores de passo, é preciso saber quais as vantagens e como funcionam.

Vamos começar então __bem pelo começo__, quase pelo óbvio. Os motores que vamos tratar aqui são motores
elétricos, ou seja, que transformam energia eletromagnética em energia mecânica. É a mesma energia eletromagnética
que age em ímãs. Um ímã permanente comum de mercado, como os de neodímio, tem uma extremidade onde fica seu
"pólo norte magnético" e a outra onde fica o "pólo sul" (não marcados como tal). Se você pega dois
ímãs de pólos iguais de frente e tenta juntá-los, sentirá que eles se repelem. Se virar um dos ímãs de modo
que seu pólo sul fique virado para o norte do outro, eles se atrairão.

[[imasatracaorepulsao]]
image::imasatracaorepulsao.png[imasatracaorepulsao,width=473,height=437,align="center",title="Atração e repulsão básicas entre forças eletromagnéticas. Pólos iguais se repelem, pólos diferentes se atraem. As linhas de força são bem mais complexas que isso, simplificamos para compreensão."]

Tratamos nesse caso dos ímãs permanentes, mas podemos utilizar de uma conformação de materiais tais que ao
passar uma corrente elétrica em determinado sentido, a indução criada pela corrente cria um eletroímã, um
ímã que pode ser ligado, desligado e até invertido se a corrente elétrica for colocada no sentido inverso. Os
eletroímãs geralmente são feito com uma bobina de fio de cobre em volta de um material ferroso e um exemplo
bem simples é um prego com fio enrolado ligado a uma bateria.

[[eletroimasimples]]
image::eletroimasimples.png[eletroimasimples,width=480,height=315,align="center",title="Um eletroímã simples, com pólos norte e sul. Desligado da bateria, o prego com fio de cobre deixa de se comportar como ímã."]

*DC* ou **AC**: Repare que a bateria da ilustração é uma fonte de _corrente contínua_ ou _DC_ (do inglês
"direct current"), isto é, o prego permanece imantado com uma corrente que não varia (ainda que somente em
condições ideais -- na prática, a corrente vai diminuindo à medida que a carga da bateria se esgota). Se ao
invés de ligarmos a uma bateria ligássemos a uma fonte de _corrente alternada_ ou _AC_ (do inglês "alternating
current"), como a tomada de sua casa, o comportamento seria bem distinto, com a bobina acumulando algo chamado
de "indutância" e o prego mudando de orientação magnética várias vezes por segundo. A fonte de corrente
alternada basicamente liga e desliga (ou inverte) a corrente várias vezes por segundo, e se colocarmos isso em
um gráfico em relação ao tempo, teremos uma _forma de onda_ recorrente.

[[ondasformasdecorrente]]
image::ondasformasdecorrente.png[ondasformasdecorrente,width=642,height=298,align="center",title="Duas formas de onda possíveis para correntes elétricas alternadas (AC). A primeira liga e desliga a corrente de 1 Ampére (eixo Y) a cada um segundo e meio (eixo X), é uma onda quadrada. A segunda levanta e abaixa a corrente continuamente de +1 Ampére até -1 Ampére periodicamente em uma 'senóide', 6 vezes a cada 0,1 segundo, equivalendo a uma corrente típica de tomada doméstica (que alterna 60 vezes por segundo, ou 60Hz)."]

Numa impressora 3D, a alimentação dos componentes é quase universalmente **DC**, obtida através de uma fonte
de tensão cujos detalhes veremos na seção de alimentação, e que transforma a corrente alternada da tomada em
corrente contínua. Em princípio, para os motores, a corrente alternada seria melhor porque o truque para fazer
motores girarem sempre gira em torno de alternar a corrente em bobinas, e quando há conversão para corrente
contínua pela fonte há uma perda envolvida. Mas na prática, por questões de controle e complexidade dessa
alternância nos motores, a conversão é obrigatória.

**Existem muitos tipos de motores**. Os mais simples são os motores DC *com escova* (__brushed__), não usado
em impressoras 3D. A escova é um elemento ligado à bobina giratória que entra em contato com a alimentação e
conduz corrente quando isso acontece. Esse contato pode produzir faíscas e como ocorre muitas vezes por segundo,
acaba levando ao desgaste das partes. Por outro lado, esses motores têm uma construção simples e barata, e só
necessitam de dois fios (sinal e terra) para funcionar.

[[diagramamotorescovas]]
image::diagramamotorescovas.png[diagramamotorescovas,width=642,height=443,align="center",title="O diagrama de um motor com escovas. Neste motor, o estator são os fios de energia, a escova e o ímã permanente em volta; o rotor são as bobinas e o comutador. O leitor deve considerar isto como uma curiosidade: útil para projetos 'maker', não para impressão 3D."]

Todos os motores que trataremos são *sem escova* (__brushless__). A escova é a peça condutora de eletricidade
que faz o contato intermitente durante o giro do rotor. Nos motores sem escova, as bobinas serão elementos fixos no
corpo do motor, parte do *estator* (parte estática do motor); a parte móvel, o **rotor**, terá um ímã permanente
ligado a um rolamento, que girará de acordo com as polaridades dadas às bobinas. O movimento deve acontecer sem
contato. Sabendo disso, vamos bolar um motor simples. Antes, é preciso diferenciar um pouco mais: ao invés de
criarmos apenas um __*motor DC sem escova*__, vamos criar um __*motor de passo*__, e começamos assim: Se pusermos
apenas uma bobina ou duas bobinas em 180°, o ímã poderia ir tanto no sentido horário quanto anti-horário para
se alinhar com elas. Vamos usar quatro (seria possível usar três, mas o controle ficaria mais complexo). Vamos
supor ainda que neste caso, vamos deixar as bobinas sempre energizadas com corrente, seja direta, seja invertida.

[[bobinas41bobinas23]]
image::bobinas41bobinas23.png[bobinas41bobinas23,width=642,height=384,align="center",title="Colocamos as quatro bobinas em torno do ímã permanente e as ligamos com dois pólos norte (bobinas 4,1) e dois pólos sul (bobinas 2,3) consecutivos virados para o centro. As atrações e repulsões assim configuradas só permitem que o ímã (o rotor) gire em uma direção: 90 graus em sentido anti-horário. Assim que completa o giro, o ímã encontra uma situação de equilíbrio e não se move mais. Este movimento é um *passo* de motor. A geometria deste motor de passo simples faz com que cada passo ande 90 graus."]

O motor simples da ilustração exemplifica bem o que se passa nos motores de mercado; a diferença é que os
últimos são bem mais complexos. Um NEMA17 comum de reprap tem este ângulo de passo de 1,8 graus, o que quer
dizer que ele tem o equivalente a 200 dessas bobinas em torno do rotor. Também comum é um torque de retenção
de 4 kgf.cm, uma grandeza que representa a resistência que o motor terá para sair desta posição de "repouso".

Da posição em que está, o motor da ilustração pode continuar girando no sentido anti-horário se fizermos o
seguinte: invertemos _somente_ as bobinas 4 e 2. Veja o que acontece.

[[bobinas90grausdepois]]
image::bobinas90grausdepois.png[bobinas90grausdepois,width=642,height=273,title="O rotor continua se movendo no sentido horário e estaciona 90 graus (um passo) depois."]

O padrão no entanto muda com esta configuração: se invertemos as bobinas 1 e 3, o motor dará um passo no sentido
__horário__, ou seja, voltará um passo. Para continuarmos girando no sentido anti-horário, precisamos inverter
as 4 bobinas.

[[bobinasmaisumpassoantihorario]]
image::bobinasmaisumpassoantihorario.png[bobinasmaisumpassoantihorario,width=642,height=317,align="center",title="Mais um passo em sentido anti-horário. Já dá pra imaginar qual seja o passo seguinte, inverter as bobinas 2 e 4. Fica como exercício para o leitor visualizar. Após isso, novamente inverter as 4 bobinas para chegar à configuração inicial (completando 360 graus)."]

No final desse exercício, o leitor pode estar pensando: por que deixar todas as bobinas ligadas em algum sentido? É
possível, para qualquer motor, ter as bobinas desligadas. A finalidade foi mostrar que podemos controlar os
elementos dois a dois: perceba que as bobinas *1* e *3* estão _sempre_ invertidas uma com a outra, assim como a *2*
e **4**. Isto é na verdade um princípio de construção dos motores: bobinas alternadas são conectadas de modo
que liguem ou desliguem ao mesmo tempo, constituindo uma **fase**. No nosso motor temos duas fases diferentes:
1 + 3, e 2 + 4. A estratégia que usamos de deixar as bobinas sempre energizadas para cada passo se chama _*modo
de excitação de duas fases*_ e é caracterizada por torque melhorado. Em motores com mais bobinas, as fases se
intercalam: 6 bobinas, e temos 1 + 3 + 5 formando uma fase, 2 + 4 + 6 formando outra (figura 78a). Do mesmo modo,
com 8 bobinas teremos 1+3+5+7 e 2+4+6+8 (figura 78b)

[[bobinasmaisbobinas]]
image::bobinasmaisbobinas.png[bobinasmaisbobinas,width=642,height=342,align="center",title="Motores com mais bobinas, sempre intercaladas e com duas fases - aqui mostradas em cores diferentes para melhor entendimento. O rotor central tem sua construção magnética omitida neste momento para simplicidade, pois nesses casos não são usados dois semicírculos."]

**Polaridade**: considerando um motor de duas fases, a fiação que liga as bobinas costuma ser arranjada de dois
jeitos distintos nos motores de passo: nos motores **bipolares**, uma fase corresponde a exatamente um fio de
cobre percorrendo e interligando todas as bobinas. Nos motores **unipolares**, o centro da fase tem um fio extra
de modo que a comutação é facilitada -- uma metade por vez. Para o mesmo número de fases, portanto, um motor
unipolar tem mais fios que um bipolar, ainda que algumas vezes os fios centrais das fases sejam conectados em um
fio único. O diagrama extremamente simplificado a seguir pode ajudar a entender melhor:

[[diagramafiacaomotores]]
image::diagramafiacaomotores.png[diagramafiacaomotores,width=642,height=320,align="center",title="Diagrama para entender a fiação dos motores (que passa por dentro do motor, mas é mostrado 'por fora' para entendimento). Todos os motores ilustrados têm duas fases (bifásicos). As cores indicadas na ilustração são cores comuns nos fios de motores de mercado, mas não são padronizadas ou universais. Pode-se ainda ter uma configuração não mostrada no diagrama, um 'motor universal' com quatro fios, em que cada uma de 4 bobinas é acionável isoladamente."]

Apesar de o motor bipolar ter uma construção mais "simples" (menos fios), gerar passos nele é mais
complicado. Você pode ter a corrente em *ambos* os sentidos no fio, positivo e negativo (daí o **bi**polar),
enquanto que o motor **uni**polar só é energizado em *um* sentido em cada metade de fase. Isso torna o controle
do motor unipolar _mais simples_ e o do bipolar _mais complexo_ do ponto de vista de elementos de circuito e
programação do microcontrolador.

[[fotomotordesmontado]]
image::fotomotordesmontado.jpeg[fotomotordesmontado,width=642,height=645,align="center",title="Um motor NEMA17 usado em impressoras 3D de mercado aberto, com duas fiações com convenções de cores diferentes: uma preta, vermelha, azul e verde e uma vermelha, amarela, cinza e azul. Perceba que o conector do motor da foto tem 6 pinos, e o cabo que sai dele só tem 4 fios. É porque o motor pode funcionar tanto como motor bipolar quanto como unipolar. Se fosse usado em modo unipolar, o cabo apresentaria 5 ou 6 fios conforme o diagrama anterior. Note outros elementos da construção do motor, como o rotor magnético e as bobinas no estator. Falaremos deles mais à frente."]

Se ainda assim for difícil para que o leitor abstraia o movimento, existem excelentes recursos na internet com
animações detalhadas do que acontece. Alguns exemplos são recomendados:

* Não falamos muito dos motores DC sem escova ("BLDC" - Brushless DC), mas o modo como eles funcionam pode
ser visto em https://www.youtube.com/watch?v=bCEiOnuODac[_https://www.youtube.com/watch?v=bCEiOnuODac_]
do canal "Learn Engineering", em inglês. O BLDC é bastante semelhante ao motor de passo
mas tem como diretiva maximizar o torque e deixá-lo o mais suave possível, sem as paradas do
primeiro -- precisão de posicionamento não é necessária. Diferentemente dos motores de passo,
que costumam usar uma ou duas fases, os BLDCs tipicamente têm três fases.
* O blog brasileiro
_fazedores_ tem algumas GIFs animadas com um motor de passo de acionamento simples (uma fase por vez):
http://blog.fazedores.com/serie-motores-introducao-ao-motor-de-passo/[_http://blog.fazedores.com/serie-motores-introducao-ao-motor-de-passo/_]
* Uma demonstração experimental de motores de passo "caseiros" semelhantes aos diagramas ilustrados aqui,
em português: https://www.youtube.com/watch?v=dS7tI75JczY[_https://www.youtube.com/watch?v=dS7tI75JczY_]
* Uma das
grandes aplicações da impressão 3D é na área educacional, e indivíduos criativos fizeram um motor de passo com
frames impressos em 3D e leds mostrando quais partes estão energizadas. O projeto, com alguns vídeos fáceis de
entender e já com muitas derivações, aparece no thingiverse com o título "3D Printed Stepper Motor v1.1":
http://www.thingiverse.com/thing:986260[_http://www.thingiverse.com/thing:986260_]

[[motordepassoimpressoem3d]]
image::motordepassoimpressoem3d.png[motordepassoimpressoem3d,width=642,height=501,align="center",title="Fica até difícil __não entender__: o 'motor de passo impresso em 3D' mostra quais bobinas são energizadas em cada momento pra que não haja nenhuma dúvida para o aluno."]

=== Micropassos

Nosso motor imaginário tem um posicionamento bastante grosseiro -- cada vez que andamos, é um quarto de
círculo. Acontece que, pelo controle que temos dele, é possível dar um "jeitinho" de ganhar divisões novas
de ângulo puxando o motor "para os dois lados" ao mesmo tempo. Imaginemos que no caso da ilustração anterior
queiramos só andar 45°, ao invés de 90°. Tudo o que precisamos fazer é, ao invés de inverter as 4 bobinas,
inverter só a 2 e 4.

[[bobinasmicropassos45graus]]
image::bobinasmicropassos45graus.png[bobinasmicropassos45graus,width=642,height=317,align="center",title="Começamos a girar no sentido anti-horário, mas o equilíbrio de forças está no meio do caminho. Ao invés de completarmos 90°, conseguimos posicionar o rotor em 45°; para completar 90⁰ bastará inverter 1 e 3."]

Esta estratégia é conhecida como *meio-passo* (__half-step__) e sua extrapolação para maiores divisões se
batizou de *micropassos* (__microsteps__). Alcançamos 45° porque as forças de atração são iguais; mas se
mexermos com a intensidade da corrente que passa em cada conjunto de fios, conseguiremos um ângulo ainda menor. Se
colocarmos *100%* da corrente nas bobinas *1* e *3* e *41,42%* da corrente nas bobinas *2* e **4**, conseguiremos
uma atração que resulta em um ângulo de ¾ de 90° (67,5°) em relação à 4.

[[bobinasumquartodepasso]]
image::bobinasumquartodepasso.png[bobinasumquartodepasso,width=642,height=273,align="center",title="Conseguimos avançar apenas 1/4 de passo mexendo na intensidade das correntes para as bobinas."]

Não se preocupe muito com os números para chegar a esses ângulos, o importante é o princípio; mas para
informação, foi usado cálculo de seno e cosseno para chegar aos valores. Se estivermos no caso típico de dirigir
o motor com vários pulsos para uma posição, o gráfico da corrente relativa ao tempo mostrará a aproximação
quadriculada de uma senóide.

[[graficocorrenteabmicrostep]]
image::graficocorrenteabmicrostep.png[graficocorrenteabmicrostep,width=517,height=323,align="center",title="Gráfico da corrente de saída nos dois pares de fios (A e B) para micropassos do 'datasheet' de um DRV8825, que consegue até 32 subdivisões de passo."]

Outras proporções de correntes podem nos levar a divisões ainda menores: 1/8, 1/16, 1/32 e em alguns casos
é possível chegar a 1/256 de divisão de passo! __Perceba no entanto que o torque quando se usa micropasso é
menor do que com passo inteiro, menos carga poderá ser movida__. Os componentes que realizam esse controle são
especializados e têm um nome próprio:

=== Drivers de motores de passos

O controle do motor de passo é uma tarefa tão específica que exige um componente específico. Apesar de a maioria
dos microcontroladores terem capacidade para realizar esta tarefa, tê-la separada em um componente específico
para cada motor tem uma série de vantagens:

* **Abstrai o controle dos motores**, simplificando. O microcontrolador não precisa saber se o motor está
usando passo ou micropasso nem fazer os cálculos pra isso, só precisa enviar pulsos. E cada motor tem seu
próprio driver.
* *Coloca proteções adicionais* de circuitos, minimizando as chances de correntes inversas,
sobretensões, picos de corrente, principalmente na alternância de correntes, incluindo uma "__Ponte H__"
(um arranjo eletrônico especializado para comutações rápidas sem corrente de retorno).
* **Ajusta correntes e tensões como necessário**. O driver é um dos poucos componentes de impressora 3D realmente adaptativo por
natureza: ele recebe uma variada gama de tensões e consegue abstraí-la para seu funcionamento. Um dos mais
baratos disponíveis no mercado é o __Allegro A4988__, que aceita de 8 a 35V de entrada, funcionando portanto com
praticamente todas as tensões utilizadas em circuitos de impressoras 3D. Para o motor, o driver funciona como uma
fonte de corrente na forma de enviar o sinal necessário para que ele se mova; é a corrente, e não a tensão, a
grandeza que determina o torque que o motor exerce. Os motores de mercado diferem em que corrente máxima recebem,
ficando geralmente de 1A a 2,5A, e essa corrente máxima é configurável no driver -- por exemplo, no caso
do A4988, fazemos isso mecanicamente, através de um diminuto potenciômetro na peça.
* **Separa fisicamente** o controle do motor do resto da placa, isolando um dos mais frequentes pontos de falha. Se o driver queimar, pode
simplesmente ser trocado: o resto da placa não sofre danos. Torna-se mais fácil ainda nas placas (como a RAMPS)
que têm drivers encaixáveis ao invés de soldados. Nesse caso os drivers ainda representam economia ao não
preencher os slots vagos e poder escolher o driver mais econômico para o modelo de seu motor. Na seção sobre
RAMPS falamos mais sobre esses drivers.

Assim como no caso dos motores de passo, os micropassos podem parecer meio abstratos a princípio, e nesse caso
ver animações pode passar melhor o que está acontecendo. Recomendamos essas referências:

* https://www.youtube.com/watch?v=TWMai3oirnM[_https://www.youtube.com/watch?v=TWMai3oirnM_]
-- em inglês, usa um motor de passo bipolar para ilustrar o movimento.
* https://www.youtube.com/watch?v=Yt96gdpxV2g[_https://www.youtube.com/watch?v=Yt96gdpxV2g_] -- em português,
explica os micropassos.

=== Modos de Decaimento

A presença de bobinas faz os motores serem o que chamamos de __cargas indutivas__. São cargas que usam o fenômeno
eletromagnético da indução para gerar trabalho, e uma característica marcante destas cargas é armazenar energia
em um _campo de indução_ enquanto alimentadas; com a alimentação subitamente cortada, o campo magnético entra
em colapso rapidamente, e isso causa um pulso de alta tensão entre os terminais desconectados, com o potencial de
queimar componentes. É a principal razão para nunca se desconectar um motor em funcionamento -- o arco-voltaico
resultante tem grandes chances de estragar a eletrônica.

Para mitigar o risco de descargas internas prejudiciais, os drivers nunca interrompem as correntes subitamente;
ao invés disso, fazem com que _decaiam_ de modo controlado. Existem três modos de decaimento usados:

* *Decaimento Rápido* (__fast decay mode__): neste modo, a corrente na carga indutiva é rapidamente reduzida
a zero. Isso é feito desligando criteriosamente transistores do circuito numa sequência que drene a corrente
em até cerca de 200 nanossegundos. A contrapartida desse modo é que o rotor não é simplesmente parado no
lugar: ele é "desengrenado" e leva um tempo para parar. Em outras palavras: a corrente zera rapidamente,
o motor pára lentamente. Correntes mudando rapidamente geram maior interferência eletromagnética e ruído,
o uso deste modo é responsável por um motor "barulhento".
* *Decaimento Lento* (__slow decay mode__):
neste modo, uma metade da Ponte H é escolhida e desligada. Isso tem o efeito de criar um loop resistivo em
que a corrente é lentamente drenada. Por outro lado, tal loop cria uma "freagem" no motor que faz com que
pare bruscamente na posição em que está (ocasionando maior precisão de posicionamento). O quão rápido a
corrente pára depende das características técnicas dos transistores (FETs) usados no circuito, em particular
seus "RDSon". Em outras palavras: a corrente zera lentamente, o motor pára rapidamente. Este modo também tem
de forma geral melhor torque que o decaimento rápido. Em contrapartida, não funciona bem em maiores velocidades,
visto que cada pulso é seguido de uma parada brusca.
* *Decaimento Misto* (__mixed decay mode__): Procura unir
o melhor dos modos de decaimento rápido e lento, geralmente começando com o decaimento rápido e trocando para
o decaimento lento em certa proporção do pulso. Diferentes drivers oferecem diferentes opções para esse modo;
por exemplo, os DRV8825 têm uma proporção fixa, os DRV8811 permitem configurar as porcentagens de cada modo.

Os modos de decaimento dos drivers são um fator importante de otimização dos motores e de controle do ruído,
mas são um tema bastante complexo de engenharia elétrica e seu detalhamento fora do escopo deste livro. Como
temas de engenharia, qualquer livro sobre motores trata deste tópico; mas também existem boas fontes na internet
tratando especificamente sobre isso. A seguir (em inglês):

* Uma explicação sobre os modos de decaimento: https://ebldc.com/?p=86[_https://ebldc.com/?p=86_]
* Como diminuir o ruído no seu driver: http://ebldc.com/?p=187[_http://ebldc.com/?p=187_]
* Um exemplo aprofundado de análise de problemas de drivers, com a solução:
http://www.engineerination.com/2015/02/drv8825-missing-steps.html?m=1[_http://www.engineerination.com/2015/02/drv8825-missing-steps.html?m=1_]

=== PWM, ou: você estava sendo enganado!

__Caro leitor, nós mentimos__. Até agora, tratamos de correntes e tensões como grandezas perfeitamente controladas
em intensidade pelos circuitos. Isso não é inteiramente verdade e pra explicar por quê, vamos apresentar o PWM (__Pulse
Width Modulation__), ou __Modulação de Largura de Pulso__. Este é um conceito importante que vai se aplicar
a muitos componentes de uma impressora 3D e é usado extensivamente em diversos tipos de aparelhos eletrônicos,
principalmente os que trabalham com temperatura, carga e movimento.

Na situação "ideal" imaginada, temos total controle sobre a corrente, tensão ou potência que queremos que um
componente eletrônico produza. Se pedimos uma corrente de 0,7812465272 Ampéres, teremos uma corrente exatamente
com este valor. Se queremos ao longo do tempo que a tensão siga a curva de uma senóide, podemos fazer isso com
precisão. Se precisamos de uma potência que siga uma curva arbitrária ao longo do tempo, o ajuste será perfeito.

[[graficocurvaarbitrariapotencia]]
image::graficocurvaarbitrariapotencia.png[graficocurvaarbitrariapotencia,width=478,height=285,align="center",title="Uma curva arbitrária de potência que queremos entregar ao longo do tempo, com subidas e descidas suaves."]

E isso tudo, é claro, só existirá em contos de fadas tecnológicos. Na vida real, há custos e aproximações
e em impressoras de baixo custo como as repraps, um conjunto limitado de dispositivos eletrônicos a usar. O
primeiro a se pensar para fazer controle da potência aplicada seria um __reostato__, ou seu equivalente contínuo
__potenciômetro__, que varia a potência como em um controle de chuveiro usando de resistência variável. Má idéia:
a potência não utilizada é perdida em calor. Outro elemento interessante seria um DAC, ou _Digital-Analog Converter_
(Conversor Analógico-Digital). Este circuito toma como entrada um número binário (cada dígito sendo uma tensão,
ligada ou desligada) e gera uma saída da intensidade desejada. Neste caso teremos um número de saída dependentes
do número de bits da entrada que usamos; se temos 8 bits, teremos 256 saídas possíveis (2^8^); se temos 16 bits,
teremos 65.536 saídas possíveis (2^16^).

[[graficocurvapotenciadac]]
image::graficocurvapotenciadac.png[graficocurvapotenciadac,width=478,height=329,align="center",title="A nossa curva de potência desejada quando entregue por um DAC - Conversor Analógico-Digital - de 3 bits (8 intensidades de potência possíveis). Na prática, DACs baratos de mercado costumam ter entre 10 e 12 bits (1024 a 4096 intensidades discretas)."]

Entretanto, ainda que DACs não sejam caros isoladamente, uma impressora 3D tem vários dispositivos a serem
controlados e os microcontroladores baratos como o Arduino Mega não vêm com tais elementos. Se houver uma
solução mais à mão, que inclusive possa usar sinais digitais, é melhor. Essa solução existe e é o PWM.^1^

Nos sinais digitais, temos apenas "zeros" e "uns" à nossa disposição, desligado e ligado. Em um cabo de
tensão, por exemplo, só podemos passar 0 V ou 5 V, e nada no meio. Por outro lado, temos controle fino do tempo
do sinal: podemos ligar e desligar em intervalos de 62,5 nanossegundos em um mero circuito de 16 MHz. A estratégia
é, portanto, trocar a resolução vertical (carga) pela resolução horizontal (tempo); divide-se o sinal em um
conjunto de "pulsos", de digamos 1ms, e nesse milissegundo o tempo que o sinal ficar ligado equivalerá à
intensidade. Um "pulso" que fique 80% do milissegundo em 5V e os 20% restante em 0V equivalerá a 80% de 5V,
ou seja, 4V.

Na nomenclatura convencional, teremos:

* *Ciclo* ou **período**: o tempo de cada pulso; por exemplo, 1 millissegundo.
* **Frequência**: quantos ciclos
por cada unidade de tempo. É o inverso do ciclo; se temos um ciclo de 1 milissegundo (0,001 segundo), a frequência
é 1 ÷ 0,001, ou 1000 ciclos por segundo. "Ciclos por segundo" são Hertz (Hz), a unidade de frequência.  *
*Duty Cycle* ou **Taxa de Ciclo**: para um determinado ciclo, a porcentagem de tempo em que o pulso está ativo;
por exemplo, no nosso pulso equivalente a 4V, o duty cycle é 80%.

Em muitos casos, e no caso específico das impressoras 3D de mercado, o PWM não usa um único pino para mandar o
pulso; tem também um pino de _sinal_ ou _direção_ (positiva ou negativa). Não ficaríamos restritos a 5V ou 0V;
teríamos também -5V.

[[graficocurvatraduzidaprapwm]]
image::graficocurvatraduzidaprapwm.png[graficocurvatraduzidaprapwm,width=478,height=329,align="center",title="A nossa curva quando traduzida para PWM. Perceba como a duração de cada pulso no eixo do tempo corresponde à altura da onda. Nesse caso temos um PWM direcional, pois não nos limitamos a zero e um: também mandamos pulsos negativos."]

*Mas se o sinal é diferente, o resultado também não será diferente?* Ou, já que estamos enviando um sinal _muito
diferente_ do que iríamos mandar, o dispositivo no final desse circuito não vai fazer algo também diferente
do que desejávamos? Para a maior parte dos casos, não. No caso dos motores, tanto a inércia quanto a carga
indutiva (que resiste a mudanças bruscas de corrente) faz com que o resultado seja virtualmente idêntico. Em um
LED, o PWM faz o brilho oscilar tão rápido que o olho humano o percebe como um degradê de intensidade. Em um
componente de aquecimento, a temperatura muda tão vagarosamente que os sinais digitais têm o mesmo efeito dos
analógicos. E alguns circuitos ainda têm um componente/filtro de suavização ou atenuação de sinal -- como
um simples capacitor -- que ao ser colocado no circuito, transforma o PWM no sinal analógico equivalente.

Na "vida real", além da implementação simplificada em circuitos digitais, o PWM tem outras vantagens:

* **Eficiência**: O PWM apresenta muito pouca perda de potência, geralmente ficando acima dos 90% de aproveitamento
da energia^3^. Pelo mesmo motivo, aquece muito menos e roda mais frio que outros circuitos.
* **Maior imunidade ao ruído**. Como o sinal é digital, apenas ligado ou desligado, é muito menos provável que uma interferência
o amplifique ou atenue o suficiente para tirar deste estado.

Por outro lado, ele também tem desvantagens a serem consideradas. A maior delas é **gerar mais ruído
eletromagnético**. Mudanças bruscas de sinal causam esse efeito, o que pode pedir por maior blindagem contra
ruídos no equipamento. Desvantagens menores são efeitos colaterais da escolha de frequência do PWM, como acerto
de fase ou geração de ruído sonoro, que dependerão do circuito.^3^

Nas impressoras 3D, o PWM é gerado de diversas formas. No firmware, geralmente "soft PWM" (PWM controlado
por software) de baixa frequência (7 Hz) é usado para os elementos térmicos (mesa e extrusor) e PWM nativo do
microcontrolador para a ventoinha. No caso dos motores, o firmware envia um instrução "mova um passo" para
o driver, que o transforma em PWMs adequados para o motor. Geralmente a frequência desses PWMs é por volta de
30 KHz (como no driver DRV8825), com o driver A4988 tendo ela variável e apenas o tamanho do pulso fixo^4^. Com
a frequência abaixo de 20 KHz, isso pode resultar em sons audíveis.

Muito do que foi dito aqui foi simplificado para melhor compreensão, tenha o leitor em conta que PWM é um assunto
vasto na engenharia elétrica e existe em diversos "sabores", incluindo formas de onda diversas da quadrada
(como a triangular e senoidal) e com modulações diferentes. O leitor curioso é incentivado a pesquisar mais
sobre isso em livros de engenharia elétrica ou mesmo na internet.^5^

[NOTE]
.Notas:
====
. Curiosamente, a função C++ `analogWrite()` do Arduino é um nome equivocado; o Arduino não envia um sinal
analógico e sim um PWM controlado por hardware.
. Um estudo da perda térmica em PWM pode ser visto em uma página do projeto reprap:
_http://reprap.org/wiki/Gen7_Research#Heat_vs._PWM_Frequency_
. http://hydraraptor.blogspot.com.br/2012/04/stepstuck.html[_http://hydraraptor.blogspot.com.br/2012/04/stepstuck.html_]
. O A4988 não utiliza, estritamente falando, PWM, mas uma técnica bastante semelhante com o nome
de PPM, Pulse Position Modulation, __modulação por posição de pulso__. No caso do PPM o pulso é
sempre do mesmo tamanho, mas a posição em que ocorre dentro da janela do período é o que determina
a "intensidade". Existem outras variações de PWM como o PWC (Pulse Width Coding, descrito na página 5 de
http://www.atmel.com/Images/Atmel-8014-Using-Timer-Capture-to-Measure-PWM-Duty-Cycle_ApplicationNote_AVR135.pdf[_http://www.atmel.com/Images/Atmel-8014-Using-Timer-Capture-to-Measure-PWM-Duty-Cycle_ApplicationNote_AVR135.pdf_]),
PCM, PAM, PPM (esses em
http://www.electronicshub.org/modulation-and-different-types-of-modulation/[_http://www.electronicshub.org/modulation-and-different-types-of-modulation/_])
. Podemos sugerir o excelente texto de Newton C. Braga, disponível no seu site no endereço
http://www.newtoncbraga.com.br/index.php/robotica/5169-mec071a[_http://www.newtoncbraga.com.br/index.php/robotica/5169-mec071a_]
====

=== Motores do Mundo Real

E como tudo que tem uma descrição teórica simplificada, os motores que utilizamos em nossas impressoras 3D são
mais complicados, frutos de décadas de progresso no campo. Mas não _*muito*_ mais complicados: os princípios
básicos permanecem os mesmos, e pra entendermos o que têm, primeiro precisamos falar dos _tipos_ de motores de
passos que são mais frequentes.

* *Motor de ímã permanente* (Ou Motor "PM", de Permanent Magnet) -- é o motor que ilustramos em nossos
gráficos até agora, com um rotor composto por um ímã permanente no centro. É o mais simples de entender e por
isso foi o escolhido para apresentarmos os conceitos.
* *Motor de Relutância Variável* -- diferentemente dos
motores que vimos até agora que trabalham com atração e repulsão eletromagnética, os motores de __relutância
variável__, usando __solenóides__, trabalham com outro tipo de grandeza eletromagnética, _linhas de fluxo_ que
capturam o caminho de __menor relutância__: o motor (que é um núcleo de ferro com extremidades não-magnéticas)
e estator se alinham de modo que a relutância magnética é mínima, através da força magnetomotriz. Os termos
representam palavras-chave de pesquisa para o leitor, visto que tratar deste assunto sairia muito do escopo do
livro^1^. São baratos e usados em motores pequenos como em mesas de microposicionamento.

[[bobinasmotorderelutanciavariavel]]
image::bobinasmotorderelutanciavariavel.png[bobinasmotorderelutanciavariavel,width=451,height=310,align="center",title="Um motor de relutância variável."]

* *Motores Híbridos* -- são esses os usados nas impressoras 3D "reais", e se aproveitam das duas
estratégias. Ao invés de usarem somente atração eletromagnética, usam o efeito de caminho de menor relutância,
se valendo de imantação permanente axial ao invés de radial, isto é, temos dois cilindros dentados, um imantado
positivo e outro imantado negativo, como na foto e diagrama a seguir.

[[fotomotorhibridocomdiagrama]]
image::fotomotorhibridocomdiagrama.png[fotomotorhibridocomdiagrama,width=642,height=375,align="center",title="Um motor híbrido bipolar NEMA17 de reprap desmontado e seu diagrama, visto de frente, e com uma fase (A) ativada. Perceba que os dois cilindros dentados têm os dentes intercalados, de modo que uma bobina que atraia um pólo repele o outro -- deste modo, há maior aproveitamento e controle da rotação."]

Motores híbridos usam a mesma estratégia para passos e micropassos que o motor simplificado que ilustramos. Para
uma visão animada da polarização e movimento com detalhes desses motores, recomendamos a referência de internet
https://www.youtube.com/watch?v=t-3VnLadIbc[_https://www.youtube.com/watch?v=t-3VnLadIbc_] - "How the Stepper
motors are made and how they operate -- Part 2".

[NOTE]
.Notas:
====
. Uma referência boa sobre solenóides pode ser vista no excelente sítio de Newton Braga:
http://www.newtoncbraga.com.br/index.php/como-funciona/3890-mec095[_http://www.newtoncbraga.com.br/index.php/como-funciona/3890-mec095_].
. Uma apresentação falando sobre relutância magnética, a
relação com solenóides e força magnetomotriz pode ser achada em
https://docente.ifrn.edu.br/odailsoncavalcante/disciplinas/maquinas-eletricas-e-acionamentos/revisao-de-eletromagnetismo[_https://docente.ifrn.edu.br/odailsoncavalcante/disciplinas/maquinas-eletricas-e-acionamentos/revisao-de-eletromagnetismo_].
====

=== Servo Motores

Quando aprendemos endstops, vimos que o posicionamento dos motores na impressora 3D é implementado como uma __*malha
aberta*__, isto é, como um circuito cujo resultado nunca é medido e comparado com o esperado. Assim, quando enviamos
um comando "mova o extrusor 10 mm para a esquerda" e realizamos uma ação de bloqueio, como segurar o pinhão
do motor para que o motor não gire, o sistema simplesmente se perde: ele registra a informação que o extrusor se
moveu 10mm para a esquerda, ignorante do fato de isto ter sido impedido. Essa é a chamada __*perda de passo*__,
um dos maiores problemas enfrentados nas impressoras 3D. Os endstops representam uma mitigação deste problema:
executando-se o procedimento de _homing_ novamente, o microcontrolador da impressora volta a ter referência;
mas isso não é consolo nenhum se a impressora 3D perder passos no meio de uma impressão e extrusar plástico
nas coordenadas erradas (ou em volume insuficiente, se perde passos no tracionador do filamento).

O **servo motor**, ou simplesmente __servo__, é a solução mais sofisticada (e mais cara) para este problema. É
definido como __um dispositivo que produz movimento em resposta a um comando e então regula a velocidade e direção
deste movimento em resposta à realimentação__. Traduzindo em miúdos, é um **motor em malha fechada**, que
continuamente verifica se está se movimentando como deveria e, em caso negativo, toma ações corretivas.

Servos não são desconhecidos no universo _Maker_ -- pelo contrário, em suas encarnações mais baratas, são
bastante populares. Aparecem ubiquamente nos aeromodelos, nas impressoras 3D para subir e baixar sensores de
nivelamento de mesa, e nos projetos impressos de máquinas simples.

[[servomotoressg90]]
image::servomotoressg90.png[servomotoressg90,width=411,height=491,align="center",title="SG90, um dos servos de baixo custo mais populares do mercado, junto a três braços distintos que são encaixáves no pinhão. Tem 1,8 kgf.cm de torque em 5V e pesa apenas 9g. Devido ao fato de ser translúcido é possível ver sua estrutura interna, usando de engrenagens extras -- redução -- para aumentar o torque às custas da velocidade. Fonte: aliexpress.com"]

Os servos podem usar diversas tecnologias de motores subjacentes, desde motores de passo a motores AC e DC e até
mesmo motores pneumáticos ou hidráulicos. O que o faz ser um servo é a presença de um _encoder rotatório_ ou
simplesmente __encoder__, o sensor de posição, direção e velocidade que fica nas costas do motor. Pode ser um
encoder __absoluto__, que sabe a posição do ângulo de rotação a qualquer momento, ou um encoder __relativo__,
que detecta rotação, velocidade e direção, mas perde a informação de posição a cada vez que o motor for
desligado. Várias tecnologias diferentes podem ser usadas nos sensores, como magnética e ótica.

Além do encoder, o servo usa ainda um __circuito controlador__, eletrônica que interpreta os sinais do encoder
e reage de acordo, acertando posição, velocidade e torque. Os servos baseados em motor de passo incluem nesta
eletrônica a função de __driver__. Este circuito, especialmente nos motores de mais alta potência como os
usados em CNCs, é consideravelmente maior que um driver de impressora 3D doméstica. Nos pequenos, porém, ele
é até incluído no corpo do servo.

[[fotoelementosdeumservo]]
image::fotoelementosdeumservo.png[fotoelementosdeumservo,width=545,height=499,align="center",title="Elementos de um servo pequeno. Perceba que apenas 3 fios entram no conjunto - um para neutro, outro para tensão de referência (Vcc) – esses dois energizam o conjunto - e o terceiro é o sinal: um simples PWM para dizer a posição desejada. O circuito de controle faz todo o tratamento do encoder incluindo corrigir o motor e não devolve ao microcontrolador que enviou o sinal nenhum dado. Fonte da foto em https://www.youtube.com/watch?v=v2jpnyKPH64"]

Por causa do encoder em sua construção, servos são mais longos que seus motores equivalentes.

[[servolongodoaliexpress]]
image::servolongodoaliexpress.png[servolongodoaliexpress,width=501,height=405,align="center",title="Exemplo de um servo motor de passo NEMA23 de torque 20 kgf.cm para CNC com o respectivo controlador/driver. Fonte: aliexpress.com"]

No caso mais comum, o posicionamento de um servo é feito enviando ao seu driver um sinal PWM. Atipicamente,
no entanto, a posição máxima não compreende a um duty cycle de 100%; nos pequenos servos como o SG90, um PWM
de 20ms de pulso ("taxa de repetição" de 50Hz) tem sua posição mínima (-90°) com pulso de 1ms (ou seja,
duty cycle de 5%) e posição máxima (+90°) com pulso de 2ms, com a posição central sendo alcançada com PWM de
1,5ms. Os servos pequenos mais comuns de mercado funcionam desse modo, incluindo a amplitude de 180° dos ângulos
alcançados -- não completam uma revolução. Servos com encoders de revolução completa (360°) ou até maiores
existem mas são bem mais raros, usados para aplicações industriais.

Voltando ao caso considerado, velocidade percorrida de um pulso de PWM para outro varia de acordo com a diferença
dos ângulos. Se o motor estiver posicionado em 0° e for mandado um pulso para 20°, ele o fará em determinada
velocidade. Se ao invés disso for mandado um pulso para 60°, ele o fará mais rápido. Quão mais rápido,
depende das características do motor e driver. Por outro lado, pode não haver diferença de velocidade entre
mandar um comando para 60° e um para 80°. Novamente, isso será particular ao motor em questão.

Para uma leitura complementar sobre servos em português, recomendamos o site da Citisystems:
https://www.citisystems.com.br/servo-motor/[_https://www.citisystems.com.br/servo-motor/_].

.Servos de rotação contínua
os servos pequenos são baratos e incluem vários elementos úteis no conjunto:
não só o encoder, mas também o circuito de controle, as engrenagens de redução e ainda costumam vir com diferentes
braços. Devido a essa facilidade de aquisição, e à necessidade de motores estritamente controláveis que possam
girar livremente (mais de 180°) em projetos de __hobbyistas__, existe um procedimento muito comum de _remoção_
de elementos desse tipo de motor para que ele funcione em rotação contínua. Tal procedimento costuma consistir
de 3 etapas:

* Remoção dos obstáculos físicos, como pinos de segurança ou obstruções na rotação, que impeçam as
engrenagens de girar além dos 180°;
* Remoção ou desativação do encoder;
* Substituição da conexão do encoder por um elemento que retorne sempre o mesmo sinal, equivalente a uma posição
da rotação do motor (geralmente a de 0°).

Muitos profissionais consideram que tal conjunto nem mesmo pode ser denominado "servo", visto que a principal
característica de um servo, o uso do encoder, é removida. Além disso, existem certos elementos que minam a
precisão de tal dispositivo: replicar o sinal equivalente à posição central torna-se um trabalho de tentativa
e erro, geralmente com resistores ou potenciômetros; e devido à já mencionada variação de velocidades para
atingir o grau desejado em diferentes servo motores, a relação entre o sinal enviado e velocidade atingida não
será linear. Existem ainda "servos de rotação contínua" de mercado que mitigam tais problemas e podem ser
preferidos por sua previsibilidade.

Uma leitura complementar em inglês sobre servos de rotação
contínua, incluindo uma receita para implementá-los, está em
https://www.pololu.com/blog/24/continuous-rotation-servos-and-multi-turn-servos[_https://www.pololu.com/blog/24/continuous-rotation-servos-and-multi-turn-servos_].

=== Servos na impressão 3D

[IMPORTANT]
.Observação sobre o suporte pelos firmwares
====
Alguns firmwares de impressora 3D, como o __Marlin__, têm suporte a
servos. Mas essa informação pode ser interpretada equivocadamente: o firmware não tem suporte a servos __no
lugar dos motores de passo__, isto é, o papel deles é outro, como por exemplo abaixar a sonda de autonivelamento.
====

A utilização de motores de passo nas impressoras 3D FFF é praticamente universal; pouco se ouve falar
em impressoras que os usem e os microcontroladores de mercado não são preparados pra lidar com eles -- os
conectores enviam passos através dos _drivers_ para motores bipolares, não pulsos de PWM representando ângulos
de posicionamento. Até mesmo os firmwares podem levar a uma leitura errada do suporte a eles: o Marlin firmware
por exemplo suporta servos, __mas não no lugar dos motores de passo__. O suporte dele é de servos para elementos
extras de controle, como o que levanta e abaixa o sensor de nivelamento de mesa.

__Servos também não são milagrosos__: se os motores de uma impressora 3D são subdimensionados para a carga
que recebem, mesmo o mais sofisticado controlador de servo não será capaz de corrigir. E servos que tratam de
posicionamento preciso em atuadores lineadores são vendidos em tamanhos pré-fabricados para aquele comprimento, com
"endstops" internos; além de excessivamente caros, limitam bastante as dimensões possíveis de uma impressora 3D.

E, claro, tudo isso são desafios superáveis. Uma impressora 3D bem dimensionada que normalmente perderia
passos somente em ocasiões raras pode muito bem se beneficiar de um motor que consiga perceber e corrigir tais
casos automaticamente "em tempo real", e permanecer nas coordenadas certas dos eixos durante uma impressão
que geralmente demora horas. Na verdade, o mercado _maker_ novamente mostra que a criatividade que lhe é tão
característica não decepcionou; existem não uma, mas _*duas*_ soluções para o problema; adicionalmente,
ambas as soluções são open source! E ambas as soluções, ao invés de vender servos prontos, modificam os
baratíssimos NEMA17 de mercado utilizados em impressoras 3D, permitindo a economia do mercado de massa.

* *ustepper* +
mistura um driver _stepstick_ para dirigir o motor a um encoder rotatório de 12 bits com um
microcontrolador AVR, sendo parafusado ou imantado nas costas de um motor de passo NEMA17 comum. Pode ser ligado
diretamente a uma RAMPS ou microcontrolador equivalente por três fios de controle no soquete para drivers da placa. +
O sítio web do ustepper é http://www.ustepper.com/[_http://www.ustepper.com_] e o vídeo de introdução pode ser
visto no youtube: https://www.youtube.com/watch?v=1ebjdsye-PE[_https://www.youtube.com/watch?v=1ebjdsye-PE_]. No
momento da publicação deste livro, o preço do dispositivo, sem frete, é de 48 euros sem motor e 58 euros com motor.
* *mechaduino* +
equivalente ao ustepper porém com controle de torque e velocidade e microcontrolador mais poderoso,
podendo por isso funcionar em modo de malha fechada "verdadeira" e até dispensar os endstops. A instalação é
semelhante ao ustepper mas ele exige um procedimento de calibração bem detalhado nas instruções que acompanham
o produto. +
O sítio web do mechaduino é http://www.tropical-labs.com/[_http://www.tropical-labs.com_]
e a instalação, calibração e uso dele com RAMPS pode ser visto
em https://www.youtube.com/watch?v=T-pY4OZzvaU[_https://www.youtube.com/watch?v=T-pY4OZzvaU_]. No momento da
publicação, o dispositivo custa, sem frete, 49 dólares e com motor, 65 dólares.

[[desmontracaoustepper]]
image::desmontracaoustepper.png[desmontracaoustepper,width=642,height=464,align="center",title="Mesmo depois de um empurrão desses, o ustepper consegue fazer com que o motor de passo recupere o lugar onde estava e continue a impressão normalmente. Vídeo em https://www.youtube.com/watch?v=oidiMjSqiBU"]

== Microcontrolador

Já foi falado que o projeto _reprap_ que deu início às impressoras 3D FFF modernas nasceu junto com o Arduino. Os
primeiros rascunhos de impressoras 3D do projeto reprap em 2006 mostram projetos envolvendo microcontroladores PIC
com placas de expansão para o controle dos motores, sensores e temperaturas, dirigidas por um computador de mesa
(Generation 1 Electronics, ou Gen1). Em seguida, já se vê o planejamento do uso de um Arduino Uno, a Gen2, ainda
com uma série de placas de expansão. A geração 3^1^, de fevereiro de 2009, aproveita a natureza open-source
do arduino e cria o projeto de uma placa única com o microcontrolador ATMEGA644P e as _saídas de potência_
necessárias; essa placa já representa o começo da interação com a Makerbot (é a placa que iria ser usada em
sua primeira impressora, a CupCake) mas sofre do problema de ser uma placa microcontroladora sofisticada, difícil
de colocar para vender na época em que foi concebida e mesmo difícil de montar por _hobbyistas_ em eletrônica por
envolver soldagens industriais. Em 2010 já aparecia a Gen4, e abreviando a história, em 2011 tivemos a última
iteração oficial desta linha de placas microcontroladoras: a Geração 7, feita com o intuito de facilitar ao
máximo ao hobbyista de eletrônica montar em casa ou na garagem, com PCB de um lado e conectores soldáveis a mão.

[[eletronicagen7pitoresca]]
image::eletronicagen7pitoresca.jpeg[eletronicagen7pitoresca,width=622,height=486,align="center",title="Eletrônica Gen7, com o pitoresco fundo escolhido para passar a idéia de poder ser montada nos lugares mais remotos. Fonte: http://reprap.org/wiki/Generation_7_Electronics"]

Um fato digno de nota é que a versão brasileira da Gen7 (Gen7BR2), com componentes mais fáceis de encontrar no
mercado brasileiro, feitas pelo grupo ReprapBR, constam no site oficial, e as primeiras versões das impressoras
3D de alguns fabricantes como a Sethi3D foram baseada nessa eletrônica, por ser uma placa "all-in-one",
tudo em uma, isto é, sem a acumulação de diversas placas de circuito interconectadas.

O que nos leva ao tópico seguinte: a Gen3 e suas sucessoras foram ótimas idéias tecnicamente -- concentrar toda a
eletrônica em uma única placa facilita a montagem, a manutenção e a modificação, mas para indivíduos e empresas
com maior know-how, ferramentas mais caras e sofisticadas e acesso a mercados de componentes eletrônicos. Para
interessados e hobbyistas, especialmente fora dos EUA, tal empreendimento era complexo e dispendioso, e é sempre bom
lembrar que os sites chineses de eletrônicos em 2010-2011 ainda não tinham pegado a tração que têm hoje. Essa
tração veio, inclusive, do outro projeto open-source de sucesso.

=== O Arduino Salvou a Impressão 3D Open-Source

Em outubro de 2010, o projeto Arduino lançou o __Arduino Mega__. Com o mesmo poder computacional do Arduino Uno,
mas mais memória e pinos (8 kiB de RAM ao invés de 2, 128 KiB de flash ao invés de 32, 54 pinos digitais ao
invés de 14 e 16 pinos de entrada analógica ao invés de 6), ele era _ideal_ para ser o cérebro de uma impressora
3D. Poder-se-ia pensar até em ser uma placa dedicada, que não dependesse da conexão ativa de um computador para
gerir a impressão e a pudesse conduzir desconectado dele.

O porém é que Arduino Mega resolve completamente o problema dos pinos e memória, mas continua sendo uma placa
microcontroladora de baixa potência. Em miúdos, isso quer dizer que os sinais em seu barramentos não excedem
40mA e ela não tem elementos de circuitos (FETs, relés, triacs, fusíveis e capacitores de alta potência)
que gerenciam as correntes típicas de uma impressora 3D -- que podem chegar a dezenas de ampères.

No entanto, a solução pra isso também é relativamente simples. Ao invés das várias placas de expansão
que se colocavam em um Arduino Uno ou um PIC (basicamente porque os pinos eram insuficientes e precisavam de
multiplexação para os diversos componentes de impressora 3D), uma única placa que pudesse controlar as correntes
para aquecimento de mesa e extrusor, correntes enviadas para os motores e ventoinhas e até organizar os pinos de
entrada para _endstops_ e sensores de temperaturas era suficiente.

E foi assim que nasceu, em 2011, a placa que, tendo se escorado no sucesso retumbante do Arduino Mega, até hoje
é a mais usada em impressoras open-source, e também em algumas em impressoras fechadas de mercado, a *RAMPS* --
sigla de **R**eprap **A**rduino **M**ega **P**ololu **S**hield. O nome especifica que é um "shield" (placa
adicional, encaixável nos pinos) para o _Arduino Mega_ especificamente e com componentes __Pololu__. Pololu é
a marca dos drivers de motores de passo acopláveis -- do tipo **A4988**.

[[kitrampsaliexpress]]
image::kitrampsaliexpress.jpeg[kitrampsaliexpress,width=549,height=539,align="center",title="Um típico 'kit RAMPS' da China, que já vem com um clone chinês do Arduino Mega, 5 drivers de alta potência 'DRV8825', a RAMPS versão 1.4 e até um LCD grande com controles e entrada para cartão SD, tudo por menos de 30 (trinta) dólares incluindo o frete. Hoje em dia as placas 'tudo-em-um' começam lentamente a se tornar viáveis, mas ainda custam pelo menos o dobro do preço de um kit desses. Fonte: aliexpress.com"]

A placa RAMPS e os _drivers_ são open-source, e a página da RAMPS 1.4 do projeto reprap se destaca por ser uma
das páginas mais bem documentadas de projeto de hardware open-source até hoje^2^, com não só todos os diagramas
e arquivos necessários em formato __Eagle__, mas também com instruções detalhadas e comentadas que serviriam
de guia pedagógico para um curso de introdução à microeletrônica.

Na página também se encontra em formato vetorial o desenho que é referência para todos os _hobbyistas_ que vão
montar a sua primeira impressora 3D. Ele mostra, espacialmente, todas as conexões dos componentes da impressora 3D à
RAMPS, e como a RAMPS se conecta à energia (e em duas conexões de 12 V, uma que leva até 11A para a mesa, e outra
que leva até 5A para todo o resto da impressora). Um detalhe importante é que como é a RAMPS que vai gerenciar
a alta potência do conjunto, é ela que se liga à fonte, não o Arduino Mega em que está conectada. Através de
um diodo no meio do slot de driver do eixo X, o diodo D1, a alimentação é repassado para o Arduino, de modo que
ele é ligado em conjunto com o resto da impressora. Se a tensão a ser usada pelo conjunto não
for 12V, ou se a corrente for sujeita a interferências, esse diodo deve ser removido e a conexão deixada em aberto.

[[diagramadasligacoesdaramps]]
image::diagramadasligacoesdaramps.png[diagramadasligacoesdaramps,width=586,height=836,align="center",title="Esquema de ligação dos fios da RAMPS 1.4 do site da reprap, traduzido para português. O 'SDRAMPS' na figura (um leitor de cartão SD) raramente é utilizado; normalmente se colocam nesses conectores e na fileira logo em frente um adaptador para ligação a um display LCD que já vem com leitor de SD embutido. Fonte da figura: reprap.org"]

=== O que um controlador de impressão 3D deve ter

Baseado no desenho esquemático das conexões da RAMPS, essa é uma informação que já podemos inferir. Basicamente,
os seguintes componentes são necessários (a lista não é exaustiva):

* **O microcontrolador ou microprocessador**. Este é o "cérebro" do controlador de impressão, onde roda o
código (__firmware__) que lê a entrada (o arquivo a imprimir), aciona os diversos dispositivos e permite o controle
interativo. No caso da RAMPS, é o _chip_ central do arduino em que ela está ligada que faz esse papel. Tal _chip_
é de 8 bits, mas existem dispositivos de 32 bits.
* **A entrada de potência**. É onde entra a energia que irá
para os elementos que serão energizados -- motores de passo, servo motores, cartuchos aquecedores. Geralmente
12V DC ou 24 V DC. A RAMPS tem duas entradas simultâneas para 12V, uma que aceita até 5A de corrente e uma que
aceita até 11A (essa vai para a mesa).
* **A entrada de energia dos componentes**. É onde entra a energia de
baixa potência que permite ao controlador ser ligado, assim como a energia de sinais digitais e dos elementos
passivos como termistores e endstops. Ela pode ser derivada da entrada de potência. No caso da RAMPS, ela tem
um regulador de tensão ligada à entrada de potência de 12V que liga o arduino conectado a ela. Em outros
__setups__, pode-se ter a entrada de energia ligada primeiro e energizando o microcontrolador; e este decidindo
se liga a entrada de potência ou não. Este modo proporciona economia e segurança: a fonte só é ligada quando
necessário. Quando se usa uma fonte de PC ATX para energizar a impressora, pode-se ligar um cabo da RAMPS até
uma entrada denominada "PSON" (Power Supply ON, ou "ligar fonte") para que o microcontrolador tenha o
poder de ligá-la ou desligá-la. Obviamente neste cenário o microcontrolador tem que ser energizado por uma
fonte de energia independente!
* **As saídas de energia dos componentes de aquecimento**. Cartuchos aquecedores
dos extrusores. Mesa e câmara aquecida, como são componentes que exigem potência muito maior, costumam estar
em trilhas separadas. São saídas reguladas por transistores (FETs). Na RAMPS, as saídas denominadas D9 e D10
são destinadas aos extrusores, e a D8 (de potência maior a transistor com dissipador maior), ligada à trilha
de 11A, para a mesa. Outros elementos de aquecimento possível são câmara de impressora e ventoinha aquecedora.
* *As saídas de energia das ventoinhas.* No caso a RAMPS a saída D9 pode ser usada para ventoinha ao invés
de um segundo extrusor, em outros controladores de impressão -- como a _RUMBA_ -- trilhas especiais de média
potência são reservadas para isso, permitindo a cada extrusor ter sua própria ventoinha controlada.
* **Saídas para os motores**. A RAMPS pode controlar até 5 motores independentes. Tipicamente os motores dos eixos X, Y e
Z mais dois extrusores, E0 e E1. A saída do eixo Z tem dois conectores para que se possam controlar dois motores
de forma idêntica, levando a contagem total a 6 motores. Outros microcontroladores podem ter mais saídas, como a
_Azteeg X3 Pro_ que tem 8 saídas de motores.
* *Pinos de entrada para sensores eletrônicos* como __endstops__,
__termistores__, _sensores de diâmetro de filamento_ e outros componentes.
* *Pinos de saída para dispositivos microcontroláveis extras* como servo motor de sonda Z, bloqueador de filamento e outros componentes.
* **Drivers de motores, ou slots para drivers**. Os motores de passos precisam de drivers e eles podem estar soldados na placa
controladora ou, como na RAMPS, encaixáveis em slots. Como são entradas para drivers configuráveis, têm também
uma fileira de três pares de pinos para configuração dos drivers através de __jumpers__.
* **Entrada USB ou algum outro meio de comunicação com computadores de mesa**. Embora algumas impressoras tenham outros meios
como rede sem fio ou ethernet, a USB continua sendo o jeito mais popular por ser um dispositivo robusto, barato
e compatível com qualquer computador moderno. Esta comunicação pode ser usada de vários modos: impressão em
tempo real, transmissão do arquivo para imprimir, atualização de firmware, controle da impressora ou mudaça
de configurações.
* **Dispositivo de armazenamento (opcional)**: já é comum que as impressoras 3D de hoje em
dia venham com um slot para cartão SD ou pendrive USB. São geralmente usados para armazenar o "gcode" criado
pelos fatiadores de impressão e no caso dos microcontroladores ARM também usados para armazenar configurações.
* **Tela**. Podendo ser de uma simples tela LCD de caracteres a uma _touchscreen_ colorida, geralmente é mais
que apenas para apresentar informações, também permitindo entrada de dados. É o caso da _touchscreen_ (que
permite a interação através do toque) e também dos LCDs comuns disponíveis para a RAMPS, que vêm com um
botão giratório pressionável para interações com menus, um pequeno alto-falante para "bipes" e até
mesmo uma entrada para cartão SD embutida. Dois modelos especialmente populares são o _Reprapdiscount Smart
Controller_ (display de caracteres com 20 colunas × 4 linhas) e o _Reprapdiscount Full Graphics Smart Controller_
(display gráfico monocromático). Como são open-source, têm várias derivações compatíveis. +
Vale notar
que a maioria dos microcontroladores de impressão 3D, até mesmo os ARM de 100-120 MHz, não têm capacidade
suficiente para controlar uma tela gráfica colorida de alta resolução, por falta de memória para mapeamento
dos pontos e velocidade para gerenciá-la a contento. Existem no mercado, no entanto, telas "inteligentes"
(com processador próprio) que se comunicam de forma simplificada com o microcontrolador, fazendo elas mesmas o
gerenciamento de memória, gráficos e animações. Assim, mesmo o microcontrolador mais simples pode ter saída
gráfica elegante e até controles por toque.

[[controladoresdelcd]]
image::controladoresdelcd.png[controladoresdelcd,width=642,height=375,align="center",title="Controladores de LCD comumente encontrados em repraps. À esquerda, o Smart Controller, que tem ainda um 'buzzer' para bipes, um botão giratório pressionável e um minibotão para reset. Perceba ainda que a ligação à RAMPS é feita através de um adaptador. À direita o 'Full Graphics' Smart Controller, maior e mais ‘quadrado’. Fonte: reprap.org"]

=== Um pouco mais sobre os drivers da RAMPS

Passamos sobre o funcionamento dos _drivers_ ao explicarmos motores de passo, mas é necessário também aprender a
lidar com eles na prática, inclusive torná-los prontos pra uso. Drivers que já são integrados na própria placa
microcontroladora são fáceis de configurar e usualmente o fato de serem configurados por software já faz com que
pelo menos parte da tarefa seja automática. Mas a RAMPS popularizou o padrão de drivers acopláveis e como isso
criou um mercado à parte, muitos outros microcontroladores de impressão 3D se preocupam em terem slots compatíveis.

Um dos primeiros drivers acopláveis foi o __Pololu stepper driver board__, modelo "A4983", rapidamente sucedido
pelo modelo "A4988" que adiciona proteção de corrente excessiva. Apesar de terem licença proprietária,
são um design simples de circuito e foram rapidamente sucedidas pela marca _Stepstick_ que produziu também um
modelo A4988 mas open-source, com o design em formato "Eagle".

Um driver terá certas características importantes que o definem. As mais importantes são:

* **Número de micropassos máximo**. Por exemplo, 16 micropassos no caso da A4988. O número de micropassos é
configurado pelo arranjo de três jumpers abaixo do encaixe do driver. Geralmente os três jumpers no estado
"conectado" equivalem ao número máximo de micropassos do driver, e outros arranjos a número menor de
micropassos.

[[jumpersdaramps]]
image::jumpersdaramps.png[jumpersdaramps,width=642,height=469,align="center",title="Slots de extrusor (E0 e E1) em uma RAMPS e seus pinos de jumpers. Nos pinos para E1 (círculo 1), os jumpers estão todos desconectados, significando que não haverá micropassos - 1:1. Nos pinos para E0 (círculo 2), todos os jumpers estão conectados, configurando o driver para divisão de micropassos 1:16 se for um modelo A4988. Foto do autor."]

* **Corrente máxima que suporta**. É importante que o driver seja "compatível" com o motor usado. Alguns
motores podem exigir alta corrente como 1,8A para funcionamento (aparece nas especificações como corrente
máxima), e usar um driver que gerencie bem menos que isso -- como o TMC2100 cujo máximo é 1,2A -- pode levar a
componentes queimados. Mesmo quando o driver aguenta, ficar perto do limite pode fazer com que esquente bastante;
um A4988 aguenta até 2,0A, mas esquentará demais se ficar muito tempo entregando corrente alta (e no mínimo
terá que usar dissipadores de alumínio). Geralmente os drivers variam de capacidade de 1,2A a 2,5A de entrega.
* **Fórmula da corrente em função da Tensão de Referência**. Para encontrar o "ponto ótimo" de operação
de um driver com o motor ligado a ele, é bastante recomendado um procedimento de "afinação" que evite que o
driver entregue corrente demais para o motor, sobrecarregando e esquentando todo o conjunto, ou entregue corrente
de menos, perdendo passos. O procedimento tem que ser feito com a eletrônica energizada e conectada e, idealmente,
a corrente deveria ser medida.  +
Medir uma corrente em um circuito é um procedimento difícil. Envolve interromper
o circuito por onde a corrente passa e inserir um elemento medidor de baixa resistência elétrica para que ela
seja forçada a passar por ele.  +
No entanto, no caso do driver, existe um procedimento mais fácil. Uma tensão
que lhe é característica, ou *Tensão de Referência* ("**V~ref~**" - reference voltage), pode ser medida
com facilidade, e a corrente que nos interessa calculada a partir de uma __fórmula__. Esta fórmula aparece no
_datasheet_ do driver, mas quando se compra drivers de lugares baratos como a China, ele pode não ser facilmente
encontrável, e mesmo a marca do driver não facilmente identificável. +
Neste caso, ainda é possível saber a
fórmula para a tensão de referência. Os drivers do mesmo tipo (A4988, DRV8825, etc.) usam a mesma fórmula, só
variando um componente que é o **Sense Resistor**, ou **R~S~**. É um resistor SMD que aparece em dobro na pequena
plaquinha do driver, mas como os designs variam (até para o mesmo tipo), sua localização é variável. O valor
do R~S~ é indicado no __datasheet__, mas já estamos assumindo que não o temos em mão: portanto, o primeiro passo
é saber localizar, no driver, os componentes de interesse. O primeiro ponto de interesse é saber onde ficam os
"terras" do driver. É indicado na própria placa, na parte de baixo:

[[fotoa4988edrv8825_1]]
image::fotoa4988edrv8825_1.png[fotoa4988edrv8825_1,width=642,height=332,align="center",title="Os terras dos drivers estão indicados em azul claro."]

Virando os drivers, podemos identificar o resto dos componentes nas placas:

[[fotodrv8825ea4988_1]]
image::fotodrv8825ea4988_1.png[fotodrv8825ea4988_1,width=601,height=616,align="center",title="Os drivers mais populares usados em RAMPS, o A4988 (em verde, mas encontrado também em vermelho) e o DRV8825 (em roxo). Os pontos de 'terra' são os que achamos na foto anterior. O potenciômetro é o disquinho de metal giratório, indicado em laranja. E o R~S~ são os 'sense resistor"'' com uma lupa, conseguimos ler tanto para o DRV8825 quanto o A4988 o valor 'R100' que indica 100mΩ, ou seja, 0,1Ω. **Nota**: perceba que para a mesma orientação, o potenciômetro do DRV8825 aparece na parte superior e o do A4988 na parte inferior."]

No caso do DRV8825, implementações dele que usam _R~S~_ diferente de 0,1Ω são virtualmente inexistentes, mas
para o A4988 os valores de 0,05Ω e 0,2Ω são comumentes encontrados.

Vamos então, consultar os respectivos datasheets e encontrar as fórmulas para saber a _V~ref~_ desejada em função
da corrente máxima.

.DRV8825
O datasheet do driver pode ser encontrado na página da Texas Instruments:
http://www.ti.com/lit/ds/symlink/drv8825.pdf[_http://www.ti.com/lit/ds/symlink/drv8825.pdf_]

A fórmula da corrente -- chamaremos de __I~max~__ -- em função da _V~ref~_ e de _R~S~_ é: +
latexmath:[I_{max}=\frac{V_{ref}}{5 \times R_s}] +
Como sabemos que R~S~ é sempre 0,1Ω, substituímos: +
latexmath:[I_{max}=\frac{V_{ref}}{5 \times 0,1}=\frac{V_{ref}}{0,5}=V_{ref} \times 2] +
ou, colocando _V~ref~_ em função de _I~max~_: +
latexmath:[V_{ref}=\frac{I_{max}}{2}] +
Em outras palavras: se o DRV8825 está ligado a um motor que aceita corrente máxima de 1,5A,
a tensão medida em V~ref~ deve ser: +
latexmath:[V_{ref}=\frac{1,5}{2}=0,75V]

.A4988
O datasheet do driver é encontrado na página da Allegro:
http://www.allegromicro.com/\~/media/Files/Datasheets/A4988-Datasheet.ashx[__http://__www.allegromicro.com/~/media/Files/Datasheets/A4988-Datasheet.ashx]. O que procuramos é: +
latexmath:[I_{max}=\frac{V_{ref}}{8 \times R_{S}}] +
O que equivale a latexmath:[V_{ref}=I_{max} \times 8 \times R_{S}]. +
No caso de usarmos um motor com corrente máxima de 1,2A e o nosso driver acima com R~S~ de 0,1Ω, a fórmula fica: +
latexmath:[V_{ref}=1,2 \times 8 \times 0,1 = 0,96V]

Como colaboração de _André Ruiz_ do grupo ReprapBR, temos a seguinte tabela para consulta rápida de DRV8825
e A4988:

[[tabeladriverspng]]
image::tabeladriverspng.png[width=1260,height=154,align="center"]

* Outros drivers: o A4988 e o DRV8825 são de longe os mais usados nas impressoras 3D atuais. Outros drivers existem
-- e com certeza mais aparecerão -- mas têm uso muito confinado. Por outro lado, isso facilita na fórmula de
__V~ref~__, visto que seu _R~S~_ não varia com a pouca disponibilidade. Uma tabelinha de alguns drivers de mercado
mais usados, e suas respectivas vantagens e desvantagens segue:

[cols=">1s,^1s,^3m,^1e,^5",options="header"]
|=================================================================================================================================================================================================================================================
|Driver		|Corr. máx.		|Fórmula		|Máx. Micropassos	|Uso
|A4988		|2,0A			|V~ref~ = I~max~ × 8 × R~S~	|16			|[small]##Driver mais popular e mais barato, facilmente encontrado nas lojas chinesas. Esquenta bastante quando perto da corrente máxima.##
|DRV8825	|2,5A			|V~ref~ = I~max~ / 2	|32			|[small]##Preço um pouco maior que A4988, mas consegue mais micropassos, roda um pouco mais frio e aguenta maior corrente.##
|LV8729		|2,0A			|V~ref~ = I~max~ / 2	|128			|[small]##Mais difícil de obter e mais caro que o DRV8825, tem como vantagens o silêncio e movimento extremamente suave, com 128 divisões de micropassos.##
|TMC2100	|1,2A			|V~ref~ = I~max~ / 1,9	|256			|[small]##A maior vantagem deste driver é a subdivisão extrema em 256 micropassos e o silêncio, mas a corrente máxima baixa limita bastante seu uso.##
|TMC2130	|2,0A			|V~ref~ = I~max~		|256			|[small]##Aceita picos breves de 2,5A. É altamente configurável e silenciosa.##
|RAPS128	|2,2A			|V~ref~ = I~max~ / 2	|128			|[small]##Criado junto à placa RADDS para Arduino de 32 bits, tem uso popular em placas ARM e se destaca por um potenciômetro extra para configuração manual do decaimento e também por vir com um dissipador gigante.##
|SD6128		|2,2A			|V~ref~ = I~max~ / 2	|128			|[small]##Semelhante à RAPS128 sem o potenciômetro extra.##
|=================================================================================================================================================================================================================================================

Vale notar que quando a divisão de micropassos é 128 ou superior, somente microcontroladores mais poderosos
que os usados em Arduinos de 8 bits conseguirão aproveitar tais vantagens. Uma curiosidade sobre os drivers é o
recurso frequentemente anunciado de ser "silencioso"; isso é algo que se obtém deixando as frequências de
trabalho fora do espectro audível (maior que 20 kHz, embora acima de 17 KHz já seja normalmente suficiente).

==== Ajustando manualmente a V~ref~ dos drivers

Uma vez que a RAMPS esteja montada, com os motores ligados, os drivers encaixados e o firmware carregado, deve-se
ligá-la e pelo LCD ou por algum print host, tentar fazer os motores girarem. Os motores não precisam estar ligados
nos eixos; pode ser até melhor testá-los sem estarem montados. Tome especial cuidado no encaixe de drivers A4988
e DRV8825, pois eles têm o potenciômetro em sentido contrário. Veja a foto abaixo para ter a referência.

Se já sabemos a _V~ref~_ que precisamos, devemos procurar chegar o mais próximo dela __girando o potenciômetro__. Deve
ser usada uma chave de fenda ou philips **de plástico ou cerâmica** para isso, pois uma que conduza pode gerar
faísas ou contatos inesperados. Para o sentido **horário**, a tensão medida __*aumenta*__; para o sentido
**anti-horário**, ela __*diminui*__. Girar demais o potenciômetro faz ele cair numa "zona morta" em que a
tensão medida flutua aleatoriamente, basta continuar girando até a zona em que ela volta a mudar linearmente.

Um multímetro será usado. É necessário colocar no ajuste de tensão direta mais próximo de 1V. A ponta de
prova positiva -- *vermelha* -- deve ser encostada no **parafuso do potenciômetro**. A ponta de prova negativa
-- *negra* -- deve ser encostada em *algum Terra (GND)* conforme visto em foto anterior. O melhor é escolher o
terra mais distante do potenciômetro, para evitar curtos acidentais. Alternativamente, a ponta de prova negativa
pode ser usada no *negativo da fonte* ou das *entradas da RAMPS* também.

[[ajustandovref1]]
image::ajustandovref1.png[ajustandovref1,width=642,height=398,align="center",title="Procedimento de ajuste de tensão dos drivers em uma RAMPS. Para simplicidade ela é mostrada desconectada e desligada, mas o procedimento deve ser feito a quente com os motores ligados. Usam-se multímetros com as pontas de prova nos lugares indicados e um instrumento de plástico ou cerâmica para girar o potenciômetro e ajustar a tensão. Os valores mostrados nos multímetros correspondem aos exemplos ilustrados anteriormente. Durante o procedimento de ajuste, é aconselhado não deixar a regulação alta por muito tempo pois há perigo de sobreaquecer e queimar os drivers."]

*A chave de fenda ou philips de plástico* ("ceramic screwdriver" nos sites de compra) pode ser difícil de
adquirir. Uma alternativa é imprimir em PLA uma substituta.

[[driveralignerpatola]]
image::driveralignerpatola.png[driveralignerpatola,width=642,height=475,align="center",title="Ferramenta plástica impressa para alinhamento do potenciômetro (trimpot) -- versões em fenda e em philips, com cabo fino ou cabo grosso para maior firmeza, disponibilizado pelo autor deste livro. Baixável em https://www.thingiverse.com/thing:1080946"]

==== Modo de decaimento: quando e como ajustar

**Modos de decaimento** de passos são os mesmos que vimos ao tratar de motores de passo: modo rápido (__fast
decay mode__), modo lento (__slow decay mode__) e modo misto (__mixed decay mode__).

Para contextualizar a dificuldade de mudá-los, é bom lembrar que o início do movimento reprap foi marcado
pela adesão de _hobbyistas_ e estudantes de eletrônica à tarefa de combinação e experimentos com motores
e dispositivos diversos de mercado, com até mesmo os drivers vindo desmontados, devendo terem os componentes
soldados na minúscula plaquinha de circuitos. Ao mesmo tempo, os revendedores e produtores interessados no mercado
se preocupavam em expandir o mercado exigindo cada vez menos conhecimento para se colocar uma impressora 3D em
funcionamento, exigindo menos experimentos e tentativas.

Componentes hiper-especializados como os drivers, portanto, deveriam ser vendidos de fábrica com ajustes
consideravelmente universais e perfeccionados para os componentes com os quais se conectam. A mudança desses
_defaults_ seria tão rara que não valeria a pena mantê-los configuráveis. E os hobbyistas interessados nisso
sempre poderiam comprar seus próprios componentes desmontados para soldar e decidir por outros defaults.

Os modos de decaimento dos drivers passaram por esse processo. A maioria dos drivers hoje em dia funciona por
default com um algoritmo de "auto-seleção", uma heurística que analisa sinais atuais e passados e reajusta
o modo de decaimento de acordo.

Mesmo assim, pode haver ocasiões em que seja preferível mudar o _default_ dos drivers para algo que funcione
mais de acordo com o que se deseja. Algumas situações possíveis -- que são as que fogem do usual -- são:

* Tensão da fonte diferente de 12V- com uma fonte de maior tensão, como 24V ou 35V, para a entrega da mesma
potência é necessário menos corrente no circuito. Isso pode fazer com que o decaimento precise de ajustes,
especialmente no que concerne à entrega de corrente. Um exemplo é com o driver DRV8825 em máxima divisão de
micropassos (1:32) e motor de baixa corrente; ele pode perder passos no modo default de auto-ajuste, e pode se
beneficiar de ser colocado em modo de decaimento rápido.
* Microcontrolador ARM -- tanto por trabalharem em
tensão nominal default de 3,3V quanto por comumente usarem drivers mais raros com maior divisão de micropassos,
tais microcontroladores podem precisar de ajustes finos para as potências, correntes, frequências e tensões
com que trabalham.
* Grande volume de impressão -- maior volume de impressão implica em motores percorrendo
distâncias contínuas maiores, com a aceleração sendo considerável. A suavidade do movimento, assim como a ação
de contraposição à inércia sofrem considerável influência do decaimento.
* Grande carga (como um extrusor
pesado) ou alta velocidade -- o decaimento poderá favorecer um caso ou outro, raramente os dois. Decaimento
inadequado em ambos os casos causa o efeito de __ringing__, ou "ziguezagues" nas linhas de impressão.

Dito isto, mudar esse __default__, na maioria dos drivers, exige mexer nas soldas do circuito, geralmente criar
uma ligação (direta ou com resistor) entre um pino de configuração e uma tensão de referência (Terra/GND ou
Vcc/5V). É fora do escopo entrar nas configurações de cada driver (e isto pode ser encontrado em seus respectivos
datasheets), mas é possível citar dois exemplos:

* A4988. O driver funciona por padrão em auto-seleção (misto ou lento). A mudança desta configuração
se obtém com o pino ROSC -- Region Orthogonal Signal Correction, normalmente colocado em Vcc. Com o pino
soldado diretamente com o Terra, o modo misto é usado quando há divisões de micropassos e o modo lento é
usado quanto há passos inteiros (1:1). Com o pino ligado a um resistor ao terra, auto-seleção com o tempo
desligado (off-time) variável de acordo com o resistor. Há uma variante do A4988 que tem o off-time regulável
por um segundo potenciômetro: http://reprap.org/wiki/G3D_driver[_http://reprap.org/wiki/G3D_driver_]. Um
dos posts referenciais sobre o assunto, do usuário __nophead__, trata desta configuração do A4988:
http://hydraraptor.blogspot.com.br/2012/04/stepstuck.html[_http://hydraraptor.blogspot.com.br/2012/04/stepstuck.html_]
* DRV8825. O driver tem um pino "DECAY" especialmente pra isso, geralmente em GND (terra) para modo
misto. Ligando-se o pino a Vcc, ele passa a atuar em modo de decaimento rápido.

[[gambiarrapinodecay]]
image::gambiarrapinodecay.jpeg[gambiarrapinodecay,width=509,height=417,align="center",title="Pino 'DECAY' de um driver DRV8825 ligado ao pino M2 para receber 5V e deixar selecionado o modo de decaimento rápido ('fast decay'). Fonte: http://www.morgan3dp.com/stepstuck-revisited-drv8825/"]

=== Visão retroativa é 20/20: os defeitos da RAMPS

Não há dúvidas que para sua época a RAMPS solucionou um bocado de problemas de forma genial, de custo a formas
de controle. No entanto, olhar para o passado de forma crítica sempre é mais fácil que, no presente, prever o
que pode dar errado no futuro. Hoje, os defeitos de projeto da RAMPS estão mais visíveis que nunca e ela parece
cada vez menos adequada para novos projetos de impressora 3D. Alguns desses defeitos são:

* *Os _termofusíveis amarelos_* -- para proteção contra superaquecimento, a RAMPS tem um termofusível menor
MFR500 para a via de 5A e outro termofusível maior MFR1100 para a via de 11A. Esses fusíveis, no entanto,
são tremendamente problemáticos: são grandes e frágeis, frequentemente atrapalhando a fiação e quebrando na
perninha de conexão; são propensos eles próprios a superaquecimento e até combustão, especialmente o MFR1100
que só aguenta até 16V; são difíceis de encontrar no mercado brasileiro. Muitos _hobbyistas_ compram RAMPS
prontas pelo preço e simplesmente removem esses termofusíveis, trocando por fusíveis comuns de corrente ou até
mesmo fazendo simplesmente a conexão direta. A versão 1.4.2 da RAMPS os troca por fusíveis de automóveis.
* *Incapacidade para 24V* -- a ausência de um componente que possa energizar o arduino em 24V, o projeto original
com capacitores eletrolíticos de 16V e o já citado termofusível MFR 1100 são grandes impeditivos para se usar
sem modificações a RAMPS em 24V, uma opção de fonte cada vez mais popular devido ao melhor aproveitamento
de potência. O problema dos capacitores tem sido resolvido com a maioria dos vendedores, mesmo os chineses de
baixo custo, já vendendo a placa com capacitores de 35V, mas ainda é preciso ter tal critério para escolher
o produto.
* *A orientação dos drivers* -- a RAMPS carece de conectores direcionados para conexão dos drivers
de motores de passos. É muito fácil conectá-los ao contrário, o que leva a que queimem. O problema é agravado
por os drivers mais populares, A4988 e DRV8825, terem o potenciômetro em lados diferentes da placa e parecerem
"invertidos".
* *A orientação dos conectores de endstop* -- um conector de endstop colocado ao contrário
pode fazer a placa queimar.
* *O conector de energia é subdimensionado* -- a RAMPS tem uma trilha de até 5A e
outra de até 11A; o conector MODU verde de 4 vias onde a energia delas é ligada, no entanto, é projetado para um
máximo de **10A**. Ainda que geralmente 11A esteja dentro da "margem de erro" do conector, não são raros os
casos em que este conector "derrete" por superaquecimento.
* *Pinos de conexão dos motores muito estreitos* -- existem variações de diferentes espessuras dos conectores de motores bipolares. Com o estreito espaçamento
e disposição dos conectores na placa, alguns conectores simplesmente não se encaixam se não forem lixados ou
cortados. Esse problema é especialmente contundente nas duas conexões em paralelo para os motores do eixo Z.
* *Conector superdimensionado para ventoinha* -- a RAMPS tem apenas um conector para ventoinha microcontrolável
e o usuário tem que escolher entre usar tal conector para o aquecedor de um segundo _hotend_ ou a ventoinha. Isso
quer dizer que extrusores duplos em RAMPS não terão ventilação controlada no bico. A potência necessária para
acionar uma ventoinha é menor que a necessária para esquentar um hotend; outras placas têm saídas de baixa
potência extras para ventoinhas.
* *Versão "congelada" na 1.4* -- embora não seja inteiramente verdade
(a versão mais nova "oficial" no momento da publicação deste livro é a 1.4.2, com pequenas melhorias),
a versão 1.4, de 2011, é a quase universalmente vendida a preços baixos.
* *Dependente do Arduino* -- ao
mesmo tempo uma vantagem -- por usar um componente facilmente encontrável -, é também uma desvantagem por
envolver montagens e por ter dois componentes diversos que podem acarretar problemas. Existem placas que juntam a
funcionalidade de um shield ao microcontrolador arduino, como a RUMBA e a Sethi3D CPU.
* *Subdimensionada para os tempos atuais* -- microcontrolador de 8 bits lento (16 MHz), saída para apenas dois extrusores, falta de ethernet
ou wifi e outros problemas semelhantes são decorrentes do baixo custo e da ṕoca em que foi concebida. Hoje já
temos controladores muito mais sofisticados, com telas coloridas e capacidade até de fatiar diretamente peças 3D.

[[problemasramps1]]
image::problemasramps1.png[problemasramps1,width=642,height=448,align="center",title="Alguns dos problemas descritos. *1* - conector de ventoinha ou extrusor (D9); *2* - termofusíveis; *3* - conectores simétricos, sem indicação de orientação; *4* - pinos de motores estreitos; *5* - pinos de endstops sem orientação clara e sem proteção contra inversão."]

=== Outros controladores de impressão: a ascensão dos ARM

Apesar de todos defeitos da RAMPS, sua popularidade continua alta e o preço de um conjunto completo com arduino,
LCD e drivers é quase imbatível comparado a outras eletrônicas. E pra sedimentar ainda mais essa dominação
de mercado, como foi uma das primeiras eletrônicas a surgir para repraps, a quase totalidade dos _firmwares_
open-source disponíveis, isto é, o software que controla a eletrônica, foi feita para ela. Este tipo de
software, conceitualmente simples a princípio, é no entanto extremamente crítico: ele controla eletronicamente
elementos de temperatura, mecânica, velocidade e torque de um dispositivo mecatrônico em um trabalho que dura
horas. Qualquer pequeno deslize no código pode ser responsável pela falha (e consequente perda financeira) de
todo este trabalho, sem contar os riscos reais de estragar fisicamente o equipamento ou até causar incêndios
e outros acidentes. A escolha de um _firmware_ maduro, estável e extensivamente testado não é, portanto, um
luxo, mas uma necessidade. Acrescente-se a isso que, apesar da baixa capacidade de processamento de um arduino,
tais firmwares ganharam recursos sofisticados e complexos que não são fáceis de reproduzir em controladores de
impressão mais avançados mesmo tendo o código-fonte (em grande parte por haver muito código de baixo nível).

A maioria dos controladores de impressão realmente viáveis como alternativa à RAMPS, portanto, são compatíveis
com os firmwares desenvolvidos pra ela, tendo pouco mais a oferecer que proteções eletrônicas, número maior
de saídas ou a comodidade de um controlador unitário. Nomes como __Melzi__, __Gen7__, __Azteeg X3__, __RaMBo__,
__RUMBA__, _Sanguinololu_ são placas "tudo-em-um" baseadas em arduino de 8 bits preparadas para receber os
mesmos firmwares do Arduino com RAMPS. Certamente que têm suas vantagens e seus fãs -- mas não representam um
salto tecnológico necessário para o "próximo nível" das impressoras 3D. Em especial, para impressoras 3D
estilo delta, o cálculo de transformação dos eixos nesses processadores de 8 bit é tão lento que efetivamente
limita a velocidade máxima que os motores podem ter.

A situação tem mudado mais recentemente, porém, com a crescente popularização dos microcontroladores baseados
na arquitetura ARM de 32 bits. Os ARMs são baratos, poderosos, eficientes e fáceis de encontrar no mercado,
mas sua eficiência vem em parte de funcionar em baixas voltagens, especialmente 3,3V. O Arduino Mega usa 5V como
tensão de referência, e muitos dos dispositivos que funcionam em 5V teriam que ser adaptados ou substituídos
para funcionar a contento em controladoras baseadas em ARM.

E isto já havia sido tentado desde 2013, começando com shield estilo RAMPS open-source RAMPS-FD para o Arduino Due,
um Arduino com microcontrolador ARM Cortex-M3 de 84 MHz, e mais tarde a open-source SMART RAMPS e a proprietária
RADDS. Nunca tiveram muita tração de mercado no entanto porque os designs tinham falhas e o firmware que as suporta
(repetier firmware) era relativamente bugado para ARM. A placa Duet com o mesmo microcontrolador, suportada pelo
_Firmware Reprap_ de Adrian Bowyer e pela respeitada _Think3DPrint3D_ chegou a ter alguma tração e tem opções
que realmente a diferenciam, como expansões e rede.

Muitos outras tentativas de mercado apareceram no período entre 2012 a 2014, com algumas sendo até baseada
em ARMs de maior potência, como os shields _BeBopR_ e __Replicape__, feitos para a placa open-source da Texas
__Beaglebone Black__, que roda Linux em um ARM poderoso com 512 MB de RAM.

A mudança, no entanto, veio mesmo com o firmware _Smoothie_ e a placa para o qual foi feita, a __Smoothieboard__,
que leva um processador ARM Cortex-M3 de 120 MHz. Ambos open-source, com a Smoothieboard tendo de fábrica
ethernet e cartão SD e o Smoothie (às vezes chamado de __Smoothieware__) tendo nascido no projeto reprap,
respeitando os padrões e recomendações de gcode deste. Sendo um firmware fácil de obter, de entender e de
configurar, ele garantiu o sucesso da eletrônica, e o que cristalizou o projeto viável mundialmente foram os
clones de baixo preço que surgiram. Nomes como **AZSMZ**, **MKS SBASE**, *Azteeg X5 Mini* e *Sunbeam 2.0* já
têm ganhado notoriedade pela compatibilidade com o Smoothieware e muitas impressoras -- especialmente deltas
-- sendo construídas em cima deles. Infelizmente, as chinesas (AZSMZ e MKS SBASE) têm sido bastante criticadas
porque apesar de baseadas em design open-source não liberaram os fontes de seus designs e se encontram, atualmente,
em uma situação de antagonismo com a comunidade e revendedores da Smoothieboard.

[[smoothieboardemkssbase]]
image::smoothieboardemkssbase.png[smoothieboardemkssbase,width=642,height=326,align="center",title="À esquerda, a Smoothieboard original, open source. À direita, a clone chinesa compatível e proprietária MKS Sbase v1.3. A smoothieboard usa drivers soldados à placa do tipo A5984, a MK Sbase usa DRV8825; ambos têm divisões de até 32 micropassos"]

[NOTE]
.Maiores referências sobre outros controladores, especialmente os baseados em ARM, podem ser encontradas nos seguintes endereços online:
====
* http://reprap.org/wiki/List_of_electronics[_http://reprap.org/wiki/List_of_electronics_]
-- a lista básica dos microcontroladores do projeto reprap e suas características.
* http://reprap.org/wiki/Comparison_of_Electronics[_http://reprap.org/wiki/Comparison_of_Electronics_]
-- uma tabela comparativa de tais controladores.
* Controlador open-source Duet:
http://www.reprap.org/wiki/Duet[_http://www.reprap.org/wiki/Duet_] e https://www.duet3d.com/[_https://www.duet3d.com/_]
* Smoothieboard e Smoothie: http://reprap.org/wiki/Smoothieboard[_http://reprap.org/wiki/Smoothieboard_]
e http://smoothieware.org/[_http://smoothieware.org/_]
* Comparação entre _Duet_ e __Smoothieboard__:
http://forum.seemecnc.com/viewtopic.php?f=111&t=9205[_http://forum.seemecnc.com/viewtopic.php?f=111&t=9205_]
* AZSMZ e MKS SBASE podem ser encontradas nos sites chineses para venda.
* Muitas dessas marcas têm também
placas baseadas em arduino de 8 bits, como a Azteeg X3 e MKS Gen. Verifique cuidadosamente para não comprar
gato por lebre.
* Muitas vezes é difícil mudar uma impressora totalmente conectada e funcional para um novo
controlador de impressão. Soluções de mercado para facilitar essa transição existem, como as réplicas da
RAMPS que funcionam com Arduino Due ao invés de Arduino Mega. No entanto, se a dificuldade de transição se
encontra não no firmware mas nas conexões físicas e drivers, uma boa maneira de fazer a transição pode
ser trocar o Arduino -- e colocar um microcontrolador que encaixe perfeitamente na RAMPS comum, reusando
as conexões. Essa é a idéia do controlador "Re-ARM" da Panucatt, que roda o _Smoothieware_ e oferece
pinos compatíveis com 5V, um microcontrolador de 32 bits de 100 MHz e várias opções de conectividade.
====

[[screenshotrearm]]
image::screenshotrearm.png[screenshotrearm,width=642,height=421,title="O &quot;Re-ARM&quot;, um microcontrolador que pode substituir o Arduino Mega do seu conjunto RAMPS + Arduino. Disponível em http://www.panucatt.com/Re_ARM_for_RAMPS_p/ra1768.htm"]

* Muita confusão vem do fato que um embarcado ARM popular de hobbyistas, o __Raspberry Pi__, é comumente visto
conectado ao hardware de impressoras. A confusão vem de supor que ele está servindo como o controlador de impressão
acionando motores, aquecedores, etc., quando na verdade ele está agindo como se fosse um computador comum, enviando o
trabalho de impressão pela USB ao controlador da impressora. Existem diversos softwares para o Linux do Raspberry Pi
(print hosts) que permitem isso, como o octoprint, o astroprint e o repetier server. O Raspberry Pi é um embarcado
potente mas com limitações eletrônicas que dificultam seu uso como controlador de impressão, como a falta de
um relógio de hardware, de entradas analógicas e de PWM de hardware. Ainda assim, existe um _firmware_ feito
especialmente para este embarcado que utiliza de diversos truques de software para contornar estas limitações, o
__Printipi__, disponível em https://github.com/Wallacoloo/printipi/[_https://github.com/Wallacoloo/printipi/_]. No
momento da publicação deste livro, o software ainda se encontra em estado experimental e está há mais de um
ano sem atualizações.

=== Firmware

Já conhecemos a eletrônica, mas o que roda nela? No Universo Maker, o *Arduino* já é velho conhecido, assim como
o seu ambiente de desenvolvimento que leva o mesmo nome: um IDE simples feito em Java inicialmente para a extensão
também em Java chamada "Processing", mas readaptada para funcionar com um dialeto de C++ que compila para o
código de máquina do chip microcontrolador que roda nos arduinos de 8 bits, o "Atmel AVR". A instalação
padrão do IDE Arduino vem com uma série de bibliotecas que encapsulam funções como ajustar sinais de pinos,
receber sinais, gerar frequências, enviar e receber dados simples, escrever em um LCD e outras tarefas. O IDE
também é adaptado para usar de forma transparente o compilador C++ e enviar de forma fácil o código compilado
para a placa Arduino. Esta, por sua vez, vem preparada com uma conexão USB que simula uma porta "serial"
(envio e recepção simples de dados), e é pré-gravada de fábrica com um firmware mínimo, chamado bootloader,
que fica escutando nesta porta serial simulada por envios de programas de usuários, e quando a porta não está
sendo usada deixa tais programas sendo executados.

Esse modo de funcionamento simples e direto, que elimina quase todos os obstáculos ao aprendizado e à "mão
na massa" para que mesmo o usuário mais leigo simplesmente ligue a placa na USB de seu computador, chame o IDE
Arduino e escreva o código que quer ver funcionar, sem nenhuma das complexidades tradicionalmente envolvidas em
programação de microcontroladores. Para fazer um led piscar, nada de usar um JTAG em pinos especiais, configurar
flags e fusos de um IDE pesado e cheio de menus, de ficar o dia inteiro lendo o manual da plaquinha. Ao invés
disso, basta apertar um botão:

[[screenshotarduino1]]
image::screenshotarduino1.png[screenshotarduino1,width=642,height=509,align="center",title="A IDE Arduino com um programa para piscar o LED embutido da plaquinha microcontroladora. Pressionando o botão da setinha (em amarelo), o programa é enviado pela USB e imediatamente começa a executar."]

Já dissemos que a história da reprap é entremeada com a do Arduino, e isso se estende ao IDE. IDE que foi e
continua sendo um alvo predileto de reclamação por profissionais que mexem com embarcados, dada sua simplicidade:
dizem não ter recursos avançados de edição, de não oferecer completação de código, de esconder detalhes
de implementação e, sobretudo, de não ser propícia para programas complexos de vários módulos e cabeçalhos,
capotando sob seus próprios defeitos após as primeiras centenas de linhas de código.

[[screenshotarduino2]]
image::screenshotarduino2.png[screenshotarduino2,width=642,height=475,align="center",title="O firmware Marlin no momento da publicação, com 231 arquivos e 88 mil linhas de código. Algo impossível de acontecer, segundo os detratores da IDE e do microcontrolador Arduino."]

Tais acusações não são totalmente desprovidas de mérito: a simplicidade do IDE Arduino realmente pesa contra a
escrita de código muito complexo. O fator faltante aqui foi considerar o peso do ecossistema open-source: muitas
mentes criativas trabalhando em paralelo conseguem tratar grandes complexidades. A popularidade do Arduino trouxe
o público, e dentre esse público muitos eram desenvolvedores.

No Início do projeto reprap, o software que rodava no Arduino ("firmware") nem mesmo tinha um nome muito definido:
era chamado de "Reprap Gcode Interpreter" ou "Reprap Firmware", e tratava-se de um executador online de
comandos de controle numérico recebidos pela USB do arduino para movimentações da impressora. Naturalmente, com a
diversificação característica de projetos open-source, ficar mexendo em uma dúzia de arquivos de código-fonte para
montar uma impressora levemente diferente começou a tornar-se aborrecido e limitante, e os projetos mais elaborados
começaram a surgir, sendo mais fáceis de configurar e também agregando mais recursos como o suporte a LCD.

Como na história do extrusor AJGW, o aparecimento e evolução desses softwares envolveu muitas instituições
e mentes brilhantes, cada uma dando suas colaborações. Pode-se dizer que a história começou no controlador
genérico de máquinas CNC __*grbl*__, cujo código foi disponibilizado a partir de 2009, com o desenvolvimento
comunitário acontecendo a partir de 2011. Em paralelo a isso, em 2010 uma equipe de 6 pessoas na Universidade de
Purdue desenvolveu o conjunto __*Hydra-MMM*__, consistendo de um firmware pra Arduino e um Print Host em java. No
mesmo ano, o reprapper _Tonokip_ adaptou o código do firmware do Hydra-MMM para se adequar melhor ao padrão reprap
e criou o __*tonokip firmware*__, que no ano seguinte deu origem ao _*Sprinter*_ de Kliment e logo em seguida
o código foi reutilizado pela empresa alemã Hot-World GmbH com a marca _Repetier_ (__*Repetier firmware*__),
que também é usada em um servidor de impressão (Repetier Server) e um print host (Repetier Host). Até hoje,
o _Repetier Firmware_ é um dos dois firmwares mais utilizados em controladores de impressão baseados em arduinos
de 8 bits, com uma versão funcional em Arduino Due (32 bits).

O outro firmware mais utilizado, o __*Marlin Firmare*__, surgiu de uma combinação do _grbl_ com o __Sprinter__,
tendo sido criado em agosto de 2011 com suporte financeiro da empresa Ultimaker. Tendo o desenvolvimento mais
distribuído que o Repetier, também tem mais forks (derivações), como o cada vez mais conhecido __*Marlin
Kimbra*__. Todos os softwares citados usam a licença de software livre GPL (GNU Public License) versão 3, da
Free Software Foundation, e ocorre troca de idéias e até de código entre eles.

Digno de menção ainda é o firmware original __*Teacup*__, ainda desenvolvido (desde 2010) mas bem menos utilizado
que os anteriores. É licenciado sob a GPL versão 2 e também tem uma versão para ARM.

O __*Smoothieware*__, firmware mais utilizado em ARM, foi criado em 2012 a partir também do _grbl_ e, como o Repetier,
é mantido por uma empresa com desenvolvedores contratados, mas aceitando contribuição comunitária. Licenciado
sob a versão 3 da GPL.

==== Configuração do firmware: o legado de desenvolvedores

O firmware vai carregar consigo a informação de toda a parte mecânica da máquina, que peças funcionam e como,
e quais recursos estão ativados. Por exemplo, é no firmware que se configura quantos extrusores a impressora tem,
se ela tem mesa aquecida, quais são as dimensões máximas, que sistema de eixos usa (delta, cartesiana, etc.),
se terá autonivelamento e com que tipo de sensor, quantas voltas de motor equivalem a quantos milímetros de
movimento, qual a velocidade máxima que ela aceita e muito mais. Por isso, o firmware tem que ser configurado.

Os procedimentos de configuração do _Repetier firmware_ e do _Marlin_ foram bastante simplificados se
comparados ao reprap firmware original: ao invés de editar uma dúzia de arquivos do código-fonte, eles
centralizam a configuração em um único arquivo de cabeçalho, que passa a funcionar como um arquivo-texto de
configuração, e com comentários dizendo o que significa cada uma das configurações. Este arquivo tem o nome de
**Configuration.h**. Por exemplo, no Marlin, para definir a linguagem mostrada nos LCDs, você tem uma seção assim:

[source,cpp]
----------
//
// LCD LANGUAGE
//
// Here you may choose the language used by Marlin on the LCD menus, the following
// list of languages are available:
// en, an, bg, ca, cn, cz, de, el, el-gr, es, eu, fi, fr, gl, hr, it,
// kana, kana_utf8, nl, pl, pt, pt_utf8, pt-br, pt-br_utf8, ru, tr, uk, test
//
// :\{ 'en':'English', 'an':'Aragonese', 'bg':'Bulgarian', 'ca':'Catalan', 'cn':'Chinese', 'cz':'Czech', 'de':'German', 'el':'Greek', 'el-gr':'Greek (Greece)', 'es':'Spanish', 'eu':'Basque-Euskera', 'fi':'Finnish', 'fr':'French', 'gl':'Galician', 'hr':'Croatian', 'it':'Italian', 'kana':'Japanese', 'kana_utf8':'Japanese (UTF8)', 'nl':'Dutch', 'pl':'Polish', 'pt':'Portuguese', 'pt-br':'Portuguese (Brazilian)', 'pt-br_utf8':'Portuguese (Brazilian UTF8)', 'pt_utf8':'Portuguese (UTF8)', 'ru':'Russian', 'tr':'Turkish', 'uk':'Ukrainian', 'test':'TEST' }
//
#define LCD_LANGUAGE en
----------

As linhas em cinza são "comentários" de código em inglês dizendo os valores possíveis para as configurações e
a linha colorida é a definição (#define) de um valor - a linguagem usada no LCD. Se quisermos mudar o valor de "en" (inglês) para pt-br (português brasileiro), basta mudar a linha para:

[source,cpp]
----------
#define LCD_LANGUAGE pt-br
----------

Até aí, não parece muito difícil. No entanto, algumas configurações serão bem difíceis de entender para
o usuário novato e o fato de serem em inglês também não ajuda; algumas descrições pedem que sejam vistas
referências em outros arquivos e, por fim, para mudar esses valores o usuário deve abrir o arquivo de projeto
do firmware no IDE Arduino e, depois de mudar o que precisa, compilar e subir para o microcontrolador ligado à USB.

[scrreenshotconfighmarlin1]
image::image146.png[image,width=642,height=490,align="center",title="A configuração do Marlin. Ela é feita editando dois arquivos: o `Configuration.h` para o básico e o `Configuration_adv.h` para ajustes mais avançados. O manual de configuração fica em http://marlinfw.org/docs/configuration/configuration.html"]

O _Repetier Firmware_ funciona de forma semelhante ao Marlin: ele usa um único arquivo `Configuration.h` que o usuário
deve editar para configurar a sua impressora. No entanto, a Hot-World GmbH procurou atingir um público mais leigo
e tem, na página oficial do firmware, um configurador web que permite que ao invés de editar o cabeçalho, o
usuário configure toda a placa usando o navegador, e no fim baixe o IDE Arduino inteiro com o projeto incluído
e configurado. Ele ainda tem que conectar a placa da USB, mandar compilar e subir o firmware para a placa, mas de
forma bem menos propensa a erros.

[screenshotrepetierconfigweb1]
image::image147.png[image,width=642,height=569,align="center",title="A interface web para configurar a versão 0.92 do Repetier Firmware, disponível em https://www.repetier.com/firmware/v092/. Note que cada campo tem seleções e ajuda sobre o significado da configuração."]

Outros firmwares tratam a questão da dificuldade de mexer com estes ajustes de máquina com estratégias diversas. O
__Teacup__, por exemplo, vem com um programa configurador gráfico em python; o _Smoothieware_ permite que a
configuração seja toda feita colocando um arquivo-texto de nome `config` no cartão SD do microcontrolador com
os ajustes.

==== A EEPROM

Um dos recursos disponíveis nos controladores baseados em arduino e que também se pode ativar ou desativar pela
configuração do firmware é a __*EEPROM*__. Este é um tipo de memória não-volátil (isto é, não é perdida
com o desligamento) que funciona como se fosse um minúsculo disco rígido, e guarda as configurações mais
importantes do firmware. Quando o firmware é executado pela primeira vez com a configuração para EEPROM ligada,
formata a área se não tiver sido usada anteriormente e popula com os valores com que foi configurado. Quando é
executado outras vezes, automaticamente obtém os valores da EEPROM, ao invés de usar os internos. Se por um lado
isso ajuda a não ter que recompilar o firmware a cada vez que se muda a configuração, confunde os usuários
por os valores de uma compilação nova não estarem sendo usados.

Os _defaults_ mudam de acordo com o firmware. No Marlin, a configuração default tem a EEPROM desativada, e ela
é ativada mudando a linha

[source,cpp]
----------
//#define EEPROM_SETTINGS
----------
para
[source,cpp]
----------
#define EEPROM_SETTINGS
----------

ou, em outras palavras, tirar o "//" do começo da linha. A isso se chama _descomentar_ uma linha de código,
isto é, deixá-la ativa. No IDE arduino, as cores da linha mudam entre comentada e descomentada.

No Repetier firmware, o default é EEPROM ativada. Para desativá-la, deve-se mudar a linha

[source,cpp]
----------
#define EEPROM_MODE 2
----------
para
[source,cpp]
----------
#define EEPROM_MODE 0
----------

Quando se quiser habilitá-la de novo, pode-se mudar o EEPROM_MODE para um número diferente de zero; colocando-se
um número não usado anteriormente, o firmware na primeira execução re-popula a EEPROM com os valores internos.

== Alimentação

A impressora 3D, como todos os dispositivos eletrônicos microcontrolados, precisa ser alimentada com uma fonte
de tensão constante para o seu funcionamento. As tomadas domésticas oferecem tensão alternada (127V AC ou 220V
AC); é preciso o uso de um dispositivo que converta a tensão alternada em constante e esta é a função da
__*fonte de tensão*__. A fonte se caracteriza ainda pela corrente máxima que pode entregar de forma segura. O
cenário mais comum é a impressora 3D usar uma fonte de tensão de *12V* com corrente máxima de **30A**. Isso
também caracteriza a _potência_ máxima entregue pela fonte de tensão, que é obtida multiplicando-se a tensão
constante pela corrente máxima: 12V × 30A = **360W**.

A fonte de tensão que mais se vê sendo usada em impressoras é aquela reconhecível por sua forma de paralelepípedo
de metal e chamada de "fonte industrial", sendo uma fonte chaveada que tem três parafusos de conexão para
a tomada AC (fase, neutro e terra -- ou, em inglês, *L* (line), *N* (neutral) e *G* (ground)), e dois conjuntos
de parafusos de saída, um para o terra e outro para a fase (a tensão positiva, como 12V). Geralmente a fonte tem
ainda um parafuso de ajuste de tensão (**V ADJ**), ventoinha interna com aberturas para refrigeração e seletor
lateral 127V/220V de entrada.

[[diagramafontetensao1]]
image::diagramafontetensao1.png[diagramafontetensao1,width=642,height=409,align="center",title="Uma fonte de tensão industrial de mercado e o tipo de ligações que geralmente apresenta. A fonte ilustrada tem duas saídas de tensão positiva (vermelhas) e duas de tensão negativa (negras), mas é comum fontes com três ou até quatro de cada tipo. A conexão à impressora 3D geralmente é direta no controlador - na RAMPS, por exemplo, ligaríamos os quatro cabos nas vias de 5A e 11A pelo conector MODU verde. As cores mostradas nos fios de terra, neutro e fase da figura correspondem às cores mais usadas em fios de tomadas brasileiras."]

O nome de fonte "industrial" se deve à sua utilização como componente genérico de equipamentos da indústria
(compare com as fontes de tensão como as de laptop, que também são fontes chaveadas mas "fechadas" e com
cabo e conectores montados) e por apresentarem certas proteções importantes, como a carcaça metálica contra
eletricidade estática, refrigeração e circuitos contra surtos e inversões.^1^

A fonte industrial não é a única usada em impressoras 3D. Devido à sua disponibilidade no mercado a preços
baixos e ao frequente descarte de tais fontes como "sucata", fontes de PC também são chaveadas e disponibilizam
12V DC na saída. No entanto, o modo como funcionam é diferente: a fonte industrial disponibiliza 2 a 4 trilhas
para alta corrente em 12V e a 2 a 4 trilhas com neutro (0V); a fonte de PC disponibiliza vários conectores para
a placa-mãe e os periféricos do computador, com cada conector tendo vários fios finos (de baixa corrente) em
diferentes tensões, inclusive negativas: -12V, -5V, 0V, 3,3V, 5V e 12V. É necessário portanto adaptar a fonte
de PC, abrindo-lhe a carcaça e juntando todos os fios de 12V em um ou dois cabos de alta corrente para a RAMPS
e o mesmo com os fios de neutro; e cortar e isolar todos os fios com outras tensões.^2^

Fontes de PC podem ter ainda uma facilidade que geralmente falta às fontes industriais. PCs mais antigos usavam fontes
estilo *AT* ("Advanced Technology), os atuais usam fontes estilo *ATX* ("Advanced Technology eXtended"), que
entre outros recursos têm um pino de entrada de nome "PS_ON" ou "PSON" (Power Supply ON). Este pino quando
colocado em zero volts permite energizar as saídas de potência da fonte, e quando deixado em aberto ou em tensão
positiva impede que elas sejam energizadas. Na prática, ele serve como se fosse um interruptor ligado/desligado
para a fonte, de modo que um trabalho de impressão pode ligar a impressora antes de iniciar e desligá-la no final,
tendo grande economia de energia. E de bônus, a fonte ainda disponibiliza uma trilha de sinal de 5VSb (+5V Standby,
ou +5V de repouso) que pode ser usada para energizar um raspberry pi mesmo com o resto desligado.^3^

[[fonteindustrialeatx]]
image::fonteindustrialeatx.png[fonteindustrialeatx,width=642,height=360,align="center",title="Uma fonte industrial de 12V e 30A (1) e uma fonte ATX de PC (2), as opções mais frequentes para prover a energia para impressoras 3D."]

[NOTE]
.Notas:
====
. Novamente, o professor Newton C. Braga reitera seu papel como uma das maiores
autoridades brasileiras sobre eletrônica com seu curto porém abrangente artigo sobre fontes industriais:
http://www.newtoncbraga.com.br/index.php/automacao-industrial/6354-art1140[_http://www.newtoncbraga.com.br/index.php/automacao-industrial/6354-art1140_]
e ainda o artigo sobre como funcionam fontes chaveadas:
http://www.newtoncbraga.com.br/index.php/como-funciona/8397-como-funcionam-as-fontes-chaveadas-art1448[_http://www.newtoncbraga.com.br/index.php/como-funciona/8397-como-funcionam-as-fontes-chaveadas-art1448_]
.  A parte de modificação de fonte de PC é perigosa para amadores em eletrônica. Muitos tutoriais
mostram a modificação feita de qualquer modo e sem as proteções necessárias ou até usando cabos finos
e expondo o dispositivo a superaquecimento. Além disso, a não ser que se tenham realmente fontes de PC
sobrando sem uso ou se necessite da facilidade do PS_ON, economicamente não compensa: uma fonte industrial
de 12V já é mais barata que uma fonte de PC equivalente. Outra observação é que como somente parte
de toda a potência da fonte é colocada nas trilhas de 12V, é necessário escolher uma fonte de maior
potência -- por exemplo, para substituir a fonte industrial de 360W é recomendado usar uma fonte de
PC de pelo menos 600W de pico ou 500W contínua e eficiência de pelo menos 80 Plus Bronze. Dito isto, um
tutorial que mostra de forma correta como fazer essa modificação pode ser visto no youtube, em inglês:
https://www.youtube.com/watch?v=3X7pJOU4RiA[_https://www.youtube.com/watch?v=3X7pJOU4RiA_]
. O __Octoprint__, um print host controlável pela web que roda bem até em raspberry pis, tem nas
instruções de seu wiki o procedimento para tornar a energia da impressora controlável pelo software:
https://github.com/foosel/OctoPrint/wiki/Control-your-printer's-ATX-PSU-through-a-RAMPS-board-using-OctoPrint[_https://github.com/foosel/OctoPrint/wiki/Control-your-printer%27s-ATX-PSU-through-a-RAMPS-board-using-OctoPrint_]
. Um artigo escrito em inglês pelo brasileiro Ítalo Soares faz considerações sobre o
consumo de energia das fontes chaveadas e tem recomendações para fontes industriais e de PC:
https://3dprinterchat.com/2017/03/3d-printer-power-supply/[_https://3dprinterchat.com/2017/03/3d-printer-power-supply/_]
====

=== Fitas de Led

O que pode parecer meramente um capricho ou ornamento à primeira vista, as cada vez mais populares _fitas de led_
colocadas nas carcaças das impressoras 3D podem ser importantes, e até essenciais, não só para iluminar a
peça sendo impressa e permitir melhor inspeção visual do trabalho, como para reagir a condições de trabalho e
indicar pela cor ou padrão uma mudança de status, uma entrada em faixas perigosas de temperatura, ou um início
e final de uma série de etapas da impressão.

O problema? As fitas de led são o periférico mais despadronizado de todo o universo reprap. Existem vários tipos
de fita -- elas podem ser monocromáticas ou RGB, de intensidade regulável (__dimmable__/"dimerizável")
ou discretas (só acendem e apagam), de alta e baixa potência, e cada uma dessas tem controle e idiossincrasias
diferentes. Além disso, mesmo as de baixa potência extrapolam a carga de sinal do microcontrolador^1^ (uma fita LED
5050 requer 7,36 W/m), precisando de alimentação separada como com a mesa e extrusores -- e os microcontroladores
de mercado não oferecem saídas específicas para elas. Finalmente, se faz o controle com gcodes que acionam
pinos do microcontrolador diretamente^2^, não podendo se usar do status interno dos sensores da impressora 3D para
configurar os padrões e cores dos leds por não ter testes de condição (__if__-__then__-__else__); em outras
palavras, um uso limitado.

Ditas essas reservas, a receita apresentada aqui será de um dos casos mais genéricos e mais úteis, que é
a utilização de uma fita RGB de intensidade regulável 5050 com 12V de alimentação. Essa fita tem 4 pinos:
três pinos R, G e B que receberão uma tensão variável de 0 a 12V para a intensidade de vermelho, verde e azul
e um de Vcc (tensão de referência -- 12V). Lembrando que esses pinos terão que receber potência, então um
circuito adicional será necessário.

[[fitasdeled1]]
image::fitasdeled1.jpeg[fitasdeled1,width=642,height=388,align="center",title="Esquerda: uma das inúmeras soluções para iluminação com LEDs de uma impressora 3D - uma prusa i3, no caso. Direita: uma das fitas de LED que se encontram no mercado. Fonte: http://www.instructables.com/id/How-to-light-up-your-3D-Printer/"]

O próximo passo é escolher os pinos da RAMPS (ou do seu controlador) que controlarão cada uma das
cores. Escolheremos pinos "analógicos" do Arduino (lembrando que não são analógicos "de verdade" mas
PWM). Uma das fileiras pouco utilizadas do Arduino é a dos __servos__: podemos escolher o três pinos D4, D5 e
D6 em seguida para ser R, G e B, conforme o usuário _LVMJohnson_ do Instructables fez.

[[esqeletricofitasdeled1]]
image::esqeletricofitasdeled1.png[esqeletricofitasdeled1,width=642,height=556,align="center",title="Esquema elétrico dos pinos da RAMPS, com transistores NPN para amplificar o sinal do microcontrolador para baixa potência. Fosse um led de maior potência, usaríamos outros componentes como MOSFETs, relés ou até placas de controle dedicadas. Os 12V da figura devem ser conectados à fonte. Fonte do esquema e do tutorial em inglês: http://www.instructables.com/id/3D-Printer-RGB-LED-Feedback/"]

Somente estas ligações já seriam suficientes para ter os LEDs controláveis por g-code: o comando M42 envia um
PWM de intensidade no parâmetro S para o pino no parâmetro P:

[source,gcode]
----------
M42 P4 S128 ; liga o pino vermelho (4) com intensidade 50% (128 -- de 0 a 255)
M42 P5 S255 ; liga o pino verde (5) com intensidade 100%
----------

E podemos criar g-codes de início e finalização com mudanças de cores em cada etapa: aquecimento do extrusor,
aquecimento da mesa, priming, troca de extrusor, final da impressão. Uma dica útil é antes de mudar a cor,
usar o comando M400 que serve para terminar qualquer movimento que a impressora esteja fazendo, antes de mudar a
cor. Exemplo de um G-Code inicial, baseado no tutorial de Tom Sanladerer^3^:

[source,gcode]
----------
M42 P4 S255 ; pino vermelho em máxima intensidade
M42 P5 S255 ; pino verde em máxima intensidade; a luz resultará amarela.
M42 P6 S0 ; pino azul desligado
G28 W ; faz o procedimento de _homing_ sem autonivelamento
M400 ; espera o _homing_ acabar.
M42 P5 S0 ; desliga o led verde; a luz ficará vermelha.
M190 S120 ; ajusta a temperatura da mesa para 120 e espera chegar nesse valor.
M42 P6 S255 ; liga o led azul; púrpura indica que a mesa terminou o aquecimento.
M109 S240 ; ajusta a temperatura do _hotend_ em 240 e espera chegar nesse valor.
M42 P5 S255 ; liga o led verde; luz branca indica que a impressão iniciará.
----------

No Smoothieware, as fitas de led podem também serem controladas com pinos arbitrários da placa. Por exemplo,
os pinos PWM de designação P1.23, P1.24 e P1.26 estão geralmente disponíveis^4^, então podemos utilizá-los
para os componentes R, G e B. O módulo __**Switch**__ do smoothie, que permite definir comandos G-Code arbitrários
para pinos específicos, será usado para isso. Por exemplo, para definir o vermelho, podemos colocar isso no
arquivo de configuração:

[source,conf]
----------
switch.red.enable # o nome ("red") depois do comando _switch_
                  # é criado no momento, não pré-definido.
switch.red.output_pin 1.23 # Pino P1.23 para led vermelho
switch.red.output_type pwm # poderia ser hwpwm (pwm de hardware)
                           # também -- mais apropriado para servos
switch.red.startup_value 127 # 0 a 255
switch.red.input_on_command M151 # comando inexistente na especificação
                                 # reprap, pontos vamos usar para controlar
                                 # esse led
----------

Depois de definido isso na configuração, o seguinte G-Code poderá ser usado para ajustar a intensidade de vermelho:

[source,gcode]
M151 S255 ; ajusta para a intensidade máxima

[NOTE]
.Notas:
====
. Isso não é totalmente verdade; algumas placas tudo-em-um, como a __Azteeg X3__, oferecem saídas de baixa
potência que podem ser usadas para controlar e energizar LEDs, mas normalmente usadas para leds de status de displays.
. O Marlin permite definir, no Configuration.h, os pinos usados para R, G e B, para que ao invés de se usar
o comando M42 para acionamento direto, se use o comando específico para cor RGB do padrão reprap, o M150. Basta
descomentar e mudar as linhas do Configuration.h. Onde se encontra:
+
[source,cpp]
----------
// Support for an RGB LED using 3 separate pins with optional PWM
//#define RGB_LED
#if ENABLED(RGB_LED)
  #define RGB_LED_R_PIN 34
  #define RGB_LED_G_PIN 43
  #define RGB_LED_B_PIN 35
#endif
----------
+
Descomente-se o #define e se confiure os pinos. No nosso caso, pinos 4, 5 e 6:
+
[source,cpp]
----------
// Support for an RGB LED using 3 separate pins with optional PWM
#define RGB_LED
#if ENABLED(RGB_LED)
  #define RGB_LED_R_PIN 4
  #define RGB_LED_G_PIN 5
  #define RGB_LED_B_PIN 6
#endif
----------
+
E aí a cor do led se acertaria desse modo:
+
[source,gcode]
----------
M150 R255 U255 B0 ; R é o led vermelho, U é o verde e B é o azul
----------
+
. Cada um dos tutoriais aqui listados faz a iluminação de forma diferente. Pode ser
interessante ver todos caso deseje escolher bem. O tutorial do Tom pode ser visto em
https://www.youtube.com/watch?v=fb3hrjEiE3s[_https://www.youtube.com/watch?v=fb3hrjEiE3s_]
. Lista de pinos PWM da smoothieboard: http://smoothieware.org/pwm-capable[_http://smoothieware.org/pwm-capable_]
. Mais detalhes na documentação do módulo _switch_ do smoothieware, um jeito extremamente
poderoso de mudar o comportamento do firmware sem ter que mexer em seu código-fonte:
http://smoothieware.org/switch[_http://smoothieware.org/switch_]
====

=== A insaciável mesa aquecida

A RAMPS tem um trilho para 5A e um trilho para 11A exclusivo para a saída D8, usada pela mesa aquecida, e
apesar de não ser o único controlador de impressão, esse é um padrão frequente das eletrônicas. E embora
geralmente os 12V e até 5A sejam suficientes para gerir toda a parte eletrônica da impressora incluindo motores
e os cartuchos aquecedores dos extrusores, muito frequentemente a trilha de 11A não aquece a mesa suficientemente
para plásticos de maior temperatura como o ABS, realizando a operação de forma lenta (mais de 10 minutos para
chegar à temperatura-alvo) ou simplesmente estagnando em uma temperatura menor que o ideal de **120°C**. Os
fatores que causam isso dependem também do material da mesa, da resistência e capacidade de dissipação e
principalmente do tamanho -- uma mesa de PCB ou alumínio que ultrapasse o tamanho de 214x214mm de uma MK2B já
oferecerá dificuldades e o requerimento de potência aumenta exponencialmente com a seção lateral.

Se a mesa não aquece bem e o equipamento está todo em ordem, existem algumas providências que podem ser tomadas,
listadas aqui em ordem de facilidade. Essas são eletrônicas e podem ser usadas em conjuntos com outras estratégias,
como colocar uma placa de cortiça adesível por baixo da mesa para impedir perda de calor.

. *Mexer no potenciômetro de ajuste de tensão da fonte industrial* +
O parafuso de ajuste de tensão das
fontes industriais de 12V é um grande quebra-galho nesses momentos. As fontes de mercado costumam vir reguladas
com uma tensão que quando medida por um multímetro mostra-se próxima de 12,4V; girando o parafuso para a
direita e medindo com um multímetro, essa tensão aumenta. Uma tensão de até cerca de *15V* é segura para
os componentes da RAMPS e da maioria dos controladores de impressão. Aumentar a tensão causa uma maior entrega
de potência à mesa e muitas vezes esse pequeno incremento é suficiente para resolver o aquecimento baixo.
. *Trocar a fonte para uma de maior potência* +
Essa solução pode ser mais segura para quem não deseja correr
o risco de aumentar a tensão de trabalho de sua controladora de impressão. Perdas ou variações de qualidade
no processo de fabricação da fonte podem fazer com que ela não consiga entregar toda a potência necessária,
o que se sente mais intensamente na trilha de maior potência da mesa.
. *Usar fonte de 24V* +
Essa solução é indicada __apenas para controladoras e elementos que explicitamente funcionam com a tensão de 24V__; a RAMPS
precisa de várias adaptações e mesmo assim não raramente superaquece com 24V. A mesa idealmente deve suportar
24V; aplicar essa tensão em uma mesa de 12V típica como a MK2 (com resistência entre 0,8 a 1,2 Ω) faz passar
corrente excessiva nas trilhas, queimando o conjunto. As mesas MK2B vêm com contatos diferentes para serem usadas
em 12V ou 24V: os contatos para 24V fazem a resistência ficar entre 3 e 3,4Ω, permitindo que uma corrente ainda
dentro das especificações passe pela mesa.
+
[[mesamk2bpontossoldagem]]
image::mesamk2bpontossoldagem.png[mesamk2bpontossoldagem,width=618,height=317,align="center",title="Contatos e pontos de soldagem de uma mesa aquecida MK2B. Na configuração de 12V, que tem resistência por volta de 1Ω, o ponto "1" recebe o positivo e pontos 2 e 3 estão unidados no negativo. Na configuração para 24V, que tem resistência próxima a 3Ω, o ponto 1 fica isolado, a tensão positiva é soldada no ponto 2 e a negativa no ponto 3. Fonte: http://reprap.org/wiki/PCB_Heatbed"]
+
. *Usar um SSR na mesa* +
Essa é uma solução que pode ser considerada "radical" por expor o operador a certos
riscos de acidente, especialmente por trabalhar com correntes muito altas. Não é recomendada, portanto, para
iniciantes em eletrônica ou instalações sem proteções elétricas, com cabos expostos ou itens inflamáveis. No
entanto, especialmente para o uso de mesas aquecidas de tamanhos grandes ou câmaras aquecidas, que exigem grande
potência de trabalho, são praticamente a solução universal. +
Antes, vale uma explicação sobre as fontes
chaveadas. Como é sabido pelos entusiastas de PC, uma fonte chaveada de 1000W custa bem mais que o dobro de uma
de 500W. Isso ocorre tanto pelos custos dos componentes de potência quanto pela maior raridade no mercado de
massa. Como as demandas energéticas de uma impressora 3D crescem de acordo com o quadrado ou cubo das dimensões,
usar uma fonte DC para o componente mais exigente pode ser economicamente inviável. +
A solução passa por
permitir que a tensão AC possa ser aplicada diretamente na mesa (ou câmara). Ou nem tão diretamente: ela precisa
ser microcontrolada, pois simplesmente "ligar uma resistência na tomada" a faz aquecer sem controle. O mesmo
termistor que já leria a temperatura da mesa ligada em fonte DC, portanto, continuará nela, para poder ter a medida
de controle. +
E se a mesma saída do microcontrolador que normalmente é usada para aquecer a mesa diretamente
pudesse controlar a corrente da tomada? Com a saída de 12V ligada, a corrente passa no máximo. Com ela desligada,
não passa nada. +
Existe um tipo de dispositivo eletrônico que faz exatamente esta tarefa: o relé, em inglês
"relay". Mas não um relé como os da energia de sua casa, que são mecânicos, fazem o som de clique quando
desarmados e reagem com relativa lentidão: é preciso um tipo de relé especial, o _*relé de estado sólido*_
ou _*SSR*_ (Solid-State Relay). O relé é um interruptor controlado eletronicamente. Ele tem duas entradas e duas
saídas. Quando as entradas estão no mesmo potencial ou em aberto (desligada), ele _abre o circuito_ e impede que
passe corrente na saída. Quando as entradas recebem uma diferença de potencial positiva (ligadas), ele _fecha
o circuito_ e coloca as saídas em contato.
+
[[ssroperacaobasica]]
image::ssroperacaobasica.png[ssroperacaobasica,width=618,height=398,align="center",title="A operação básica do SSR, que funciona como um interruptor controlado: com a tensão nos pinos de entrada em 0V ou aberto, corrente não passa entre os pinos de saída; com uma diferença de potencial - digamos, 12V - entre os pinos de entrada, o circuito fecha e corrente consegue passar."]
+
Existem SSRs DC e AC, mas a denominação diz respeito aos pinos de saída; a entrada sempre será uma diferença
de potencial constante. Como a saída que nos interessa ligar a desligar é a energia da tomada -- 127V AC ou
220V AC -- o SSR a ser usado em nosso caso é o SSR AC, como ilustrado.
+
image::image154.png[image,width=642,height=409,align="center",title="Fazendo a mudança do cenário comum em que a RAMPS alimenta diretamente a mesa para o cenário em que a mesa é alimentada pela tomada através de um SSR controlado pela RAMPS."]
+
**Um SSR bem ajustado melhora muito o tempo de aquecimento**, mas representa também um **enorme risco**. Pra
começar, ele exige alimentação independente pela rede elétrica e por ele passa alta corrente, que é o que
faz a mesa esquentar mais rápido mas pode causar incêndios, explosões e eletrocuções. O SSR, quando falha, ao
invés de ficar _em aberto_ (sem passar corrente), fecha o circuito, alimentando continuamente a resistência sem
controle. As mais seguras instalações com SSR são as impressoras 3D que já vêm com ele de fábrica, alojado
em casulo com proteções elétricas necessárias e carcaça de aço ou algum outro material que se contraponha
a eletricidade estática, além de uma mesa dimensionada e estudada para tal operação.
+
Dito isto bem claramente, __é possível__, embora não recomendável, usar uma mesa de 12 ou 24V comum deste
modo. Grosso modo, o que o microcontrolador faria seria ligar e desligar continuamente a alimentação para manter
a mesa em volta de certa temperatura. Passou da temperatura, ele desliga. Ficou abaixo dela, ele liga. Mas com
uma corrente tão alta, isso não funciona muito bem; o _overshoot_ e __undershoot__, ou seja, a "inércia" de
o componente continuar aquecendo ou esfriando faz a temperatura variar enormemente em volta da temperatura-alvo,
o que traz grande instabilidade para o processo de impressão.
+
[[graficobangbang]]
image::graficobangbang.png[graficobangbang,width=642,height=578,align="center",title="Como é a estratégia de estabilização de temperatura, no modo mais básico, chamado de &quot;bang-bang&quot;. O aquecimento é ligado, e quando a temperatura passa da desejada (100°C na ilustração), desligado. A temperatura sobe mais um pouco e decresce, até que fica abaixo da desejada, e o sinal é novamente ligado (corrente &quot;I&quot;, em 100%). O overshoot é o quanto a temperatura ultrapassa a desejada, o undershoot o quanto ela fica abaixo. É desejável deixar ambos o menor possível, para que a curva se assemelhe a uma reta."]
+
Outros problemas se acumulam nessa abordagem, como os efeitos indutivos do campo eletromagnético gerado, então
não é uma boa idéia. Uma abordagem mais fina é preferida e vamos explicar como funciona.

=== Alimentação no firmware -- PWM e PID

Tanto a mesa quanto qualquer outro elemento aquecedor da impressora 3D, nos firmwares, irá funcionar com modulação
de pulso por largura ou PWM, que já vimos como funciona. Então teremos na verdade a opção de não só ligar
e desligar o elemento, mas de lhe atribuir uma "intensidade" que é na verdade o _duty cycle_ do pulso. No
gráfico anterior, colocávamos 100% de intensidade e por isso o elemento aquecedor rapidamente ultrapassava a
temperatura desejada, **ainda mais por colocarmos muita potência de uma vez**. Em uma situação como uma mesa
preparada para baixas tensões (12V, 24V) recebendo altas tensões (127V, 220V), os _overshoots_ especialmente
serão muito maiores e terão grande risco de literalmente queimar as trilhas condutoras.

Um meio de mitigar isto é __limitando o PWM__, configurando um _duty cycle_ máximo que ele pode obter. Assim,
na prática controlamos a potência que a mesa (ou outro elemento) recebe.

No Repetier firmware, isso é obtido com os defines __PID_MAX__, um para cada elemento aquecedor. No entanto,
para funcionar, o **modo PID** precisa estar ligado. São esses ajustes:

[source,cpp]
----------
/** Type of heat manager for this extruder.
- 0 = Simply switch on/off if temperature is reached. Works always.
- 1 = PID Temperature control. Is better but needs good PID values. Defaults are a good start for most extruder.
Overridden if EEPROM activated.
*/
#define HEATED_BED_HEAT_MANAGER 1 // desabilita bang-bang, habilita PID
#define EXT0_HEAT_MANAGER 1
#define EXT1_HEAT_MANAGER 1
// maximum time the heater can be switched on. Max = 255. Overridden if EEPROM activated.
#define HEATED_BED_PID_MAX 255
#define EXT0_PID_MAX 255
#define EXT1_PID_MAX 255
----------

Bastando mudar o valor máximo **255**, equivalente a 100% do duty cycle, para um valor intermediário. Por exemplo,
se mesmo conhecendo os perigos resolvermos usar uma mesa de 12V ligada na rede de 127V AC por um SSR, poderíamos
limitar em 25%:

[source,cpp]
#define HEATED_BED_PID_MAX 64

E regravar o firmware com esses valores. Ou, ainda, mudá-los na EEPROM se ela estiver ativada, lembrando que os
valores dela sobrepujam os valores de fábrica.

No Marlin, o ajuste equivalente é dividido em dois, um para o modo __bang-bang__, outro para o modo
__PID__. Exemplificando com o mesmo valor de 64 para a mesa que colocamos no repetier:

*Se você vai usar bang-bang:*

[source,cpp]
----------
//#define PIDTEMP // comentado, desabilita PID e habilita bang-bang para os extrusores
#define BANG_MAX 255 // vale para os extrusores
//#define PIDTEMPBED // comentado, desabilita PID e habilita bang-bang para a mesa
#define MAX_BED_POWER 64
----------

*Se você vai usar PID:*

[source,cpp]
----------
#define PIDTEMP
#define PID_MAX 255
#define PIDTEMPBED
#define MAX_BED_POWER 64
----------

*E, afinal de contas, que diabos é PID?* Imagine o seguinte: já que controlamos a "intensidade" por pulso,
e se chegando perto da temperatura-alvo fôssemos colocando um pulso cada vez menor, de modo que a curva não
crescesse tão rápido e se estabilizasse mais rapidamente na temperatura-alvo? E ainda, não desligamos totalmente
quando ela ultrapassar, simplesmente mandamos pulsos mais fracos. Seria um jeito de amortizar os _overshoots_
e _undershoots_ e nos mantermos perto de uma temperatura estável.

Esse raciocínio de ir "suavizando" os pulsos prevendo a resposta da curva de temperatura de modo a
conseguir o menor "erro" possível é o que deu origem ao algoritmo chamado de **PID**, sigla que descreve
as três operações que usa, cada uma contribuindo e sendo somada às outras: **P**roporcional, **I**ntegral e
**D**erivada. Um "controlador PID" continuamente calcula um valor de erro __**e**__ que é a diferença entre
uma medida-alvo (a temperatura desejada) e um valor medido (a temperatura atual) e a partir delas aplica uma
correção baseada no histórico recente desta curva, levando em conta, com pesos específicos, a proporcional,
a integral e a derivada deste erro.

Em fórmula, o conceito de PID, onde u(t) é o sinal de saída, é expresso como:

latexmath:[u(t)=K_pe(t)+K_i\int _0^te(\tau )\mathit{d\tau }+K_d\frac{\mathit{de}(t)}{\mathit{dt}}]

com *K~p~* sendo o ganho proporcional, *K~i~* o ganho integral e *K~d~* o ganho da derivada -- essas sendo as três
**constantes de proporção**. __**e**__ é o erro, __**t**__ o tempo e __**τ**__ o tempo de integração considerado. Se para
o leitor a simbologia matemática pareceu complicar desnecessariamente, o PID é uma "__mágica matemática__"
que nos permite achar uma sequência de sinais que, se mandarmos para o nosso controlador, consegue um resultado bem
mais "macio" que o bang-bang. Tudo o que precisaremos serão os números **K~p~**, *K~i~* e **K~d~** (lembre-se
do P, I, D). Podemos reescrever a fórmula de modo mais descritivo:

__SINAL = K~p~ × (proporcional) + K~i~ × (integral) + K~d~ × (derivada)__

As fórmulas de (proporcional), (integral) e (derivada) de acordo com o tempo são calculadas automaticamente pra
nós (Ufa! Ainda bem que existem computadores!), mas ainda precisamos saber como achar esses três números.

[[sinalpidmagico]]
image::sinalpidmagico.png[sinalpidmagico,width=642,height=490,align="center",title="O sinal PID é uma curva mágica que vai permitir que a nossa temperatura chegue à temperatura-alvo da forma mais suave possível, e fique sempre bem próxima a ela."]

Na "vida real", o algoritmo PID é uma solução otimizada aplicável em diversos tipos de situação,
especialmente as que envolvem equilíbrio contínuo, e regulando grandezas como fluxo, temperatura, pressão,
nível e deslocamento. Os números K~p~, K~i~ e K~d~ são empíricos, isto é, obtidos por experimentação,
e muito dependentes das características dos elementos aquecedores, da potência aplicada e outros fatores.

=== PID TUNING

Os firmwares de mercado já vêm com valores default para K~p~, K~i~ e K~d~ que funcionam razoavelmente, mas não
são ótimos. O ideal é que possamos descobrir os valores mais apropriados para o nosso hardware. Felizmente,
quase todos têm também o mecanismo de **PID Tuning**, ou **Afinação do PID**, que é justamente o que o nome
diz: um procedimento automatizado que,, começando com os valores configurados das três constantes, faz vários
ciclos de aquecimento e resfriamento e vai reconfigurando os valores para gerarem curvas mais suaves. Depois de
um default de 8 ciclos de aquecimento e resfriamento, ele devolve os valores sugeridos para Kp, Ki e Kd, que podem
ser então gravados na EEPROM, colocados no firmware ou no arquivo de configuração.

O comando do autotune, **M303**, leva três parâmetros:

* O elemento aquecedor. Se não for dado, supõe ser o primeiro extrusor, E0. O segundo extrusor é denominado E1
e a mesa E-1. No Smoothie, a mesa é E1.
* A temperatura-alvo para ele calcular as constantes. Não precisa ser
uma temperatura tão alta quanto as de trabalho, mas é bom que seja próxima. Bons números são 100 graus para
a mesa aquecida e 180 graus para o extrusor. É dada pelo parâmetro S, como em S100.
* Quantas iterações no
máximo até acabar o procedimento. O default é 8, parâmetro C8.

[[pidtuningrepetier]]
image::pidtuningrepetier.png[pidtuningrepetier,width=642,height=599,align="center",title="Exemplo da execução da afinação de PID usando `M303 E-1 S100 C8`, para afinar uma mesa aquecida ligada a SSR. A cada iteração, o firmware vai mostrando as constantes estimadas (abaixo)."]

O final do procedimento de auto-afinação de PID vai devolver algo como:

[source]
----------
08:35:57.416 : Ku: 84.99 Tu: 10.75
08:35:57.418 : Classic PID
08:35:57.418 : Kp: 51.00
08:35:57.418 : Ki: 9.49
08:35:57.422 : Kd: 68.51
08:35:57.431 : PID Autotune finished! Put the last Kp, Ki and Kd constants from above into Configuration.h
----------

Veja que o firmware só mostra os números. Cabe ao operador realizar o resto da configuração, seja acertando na
EEPROM, mudando no firmware (Configuration.h) ou editando o arquivo de configuração (caso do Smoothieware). No
caso do Marlin e Repetier, as constantes podem ser gravadas na EEPROM ainda pelo terminal de operação. Para a
mesa aquecida:

[source,gcode]
----------
M304 P51.00 I9.49 D68.51 ; ajusta P, I e D para a mesa na memória transiente
M500 ; salva na EEPROM
----------

Se pedimos o PID do extrusor, o comando a ser usado é o M301, especificando o número do extrusor iniciando de
"1" com o parâmetro H:

[source,gcode]
M301 H1 P51.00 I9.49 D68.51 ; ajusta P, I e D para a extrusor 1

No caso do Smoothieware, após a auto-afinação os valores são automaticamente configurados na memória para o
elemento aquecedor em questão, logo basta salvar no arquivo de configuração com *M500* (lembrando que ARM não
tem EEPROM, então não se grava nela).

Note que apesar de especialmente importante para mesas com SSR pelos perigos de superaquecimento envolvidos, a
auto-afinação de PID é altamente recomendada para todos os casos. Além de resolver flutuações de temperatura como
_overshoots_ e __undershoots__, minimiza demoras de reação e torna a qualidade de impressão mais consistente. Para
fazer o procedimento de auto-afinação, é recomendado estar na situação mais parecida com o cenário de
trabalho possível, com todos os componentes aquecedores frios no início. Também é recomendável reexecutar o
procedimento a cada vez que as condições mudarem, como a mudança da impressora para um ambiente climaticamente
distinto ou a troca de um componente. Se o procedimento é executado constantemente e a impressora 3D tem LCD,
é recomendável editar o firmware e descomentar `#define PID_AUTOTUNE_MENU` no Marlin para a opção aparecer no menu.

Por último, a auto-afinação pode por vezes falhar, tanto por _timeout_ (tempo esgotado, a temperatura não
muda dentro do intervalo de tempo esperado) quanto por _overshoot_ (a temperatura sai dos índices razoáveis de
flutuação). Nesse caso, editar o `Configuration.h` ou arquivo de configuração do firmware pode ser conveniente
para aumentar a tolerância temporariamente para o processo completar. No Marlin, por exemplo, a variável
`PID_FUNCTIONAL_RANGE`, por default em 10 graus, pode ser aumentada para o processo completar mesmo com overshoots
grandes (o que costuma acontecer ao se usar SSR).

=== Prevenindo acidentes: a proteção contra descontrole térmico

O perigo de superaquecimento sempre existe nas impressoras 3D, então é útil pensar em todos os cenários que
podem acontecer para tentar evitá-los ao máximo. É o termistor que nos dá a temperatura para sabermos se ainda
estamos na faixa segura, e quando ele falha eletronicamente um tipo de sinal específico como "circuito aberto"
ou "circuito fechado" é fácil de detectar; o firmware interpreta isso como abaixo da *temperatura mínima*
ou acima da *temperatura máxima* e interrompe a impressão e *desliga todo o conjunto* para evitar acidentes
(melhor um trabalho perdido que uma impressora arruinada).

Mas existe uma situação que também tem boa chance de ocorrer e que representa especial perigo com fontes
potentes ou alimentação externa como o SSR: o *descontrole térmico* -- em inglês, _thermal runaway_ --
que é quando o componente de mensuração de temperatura **mede uma temperatura "falsa", ainda dentro do
intervalo de tolerância**. É o caso quando um termistor se *solta do casulo* da mesa ou do hotend, por exemplo:
ele medirá a temperatura ambiente ao invés da alta temperatura do componente por não estar mais em contato,
então o microcontrolador enviará instruções para *aumentar a potência do aquecimento* continuamente. O hotend
ou mesa receberão sempre o máximo de potência até a hora em que a temperatura fica tão alta que o componente ou
as peças conectadas simplesmente entram em combustão ou derretem. Isso pode resultar em incêndios ou explosões
e, de fato, aconteceu tal acidente no laboratório deste autor, com pesadas perdas financeiras.

Mas felizmente existe um método para detectar esse tipo de ocorrência, que é o __*thermal runaway protection*__. O
mais comum é auferir o tempo que a resposta de aquecimento leva. Por __default__, o Marlin usa o tempo de _20
segundos_ de resposta para o extrusor e _60 segundos_ de resposta para a mesa, isto é, se a temperatura medida no
hotend não subir em 20 segundos depois do comando de aquecimento, ou se a temperatura medida na mesa não subir em
60 segundos depois do comando de aquecimento, o firmware considera que está acontecendo o descontrole térmico,
pára a impressão e desliga todas as saídas de potência. O Smoothieware tem um ajuste mais conservador, _120
segundos_ para a resposta de qualquer elemento aquecedor. O Repetier, no momento da publicação deste livro,
ainda não tem o recurso.

O recurso para hotends já vem ativado no Marlin, mas não para a mesa aquecida. Para deixar os dois ativados,
basta descomentar os dois ajustes no `Configuration.h`:

[source,cpp]
----------
/**
* Thermal Protection protects your printer from damage and fire if a
* thermistor falls out or temperature sensors fail in any way.
*
* The issue: If a thermistor falls out or a temperature sensor fails,
* Marlin can no longer sense the actual temperature. Since a disconnected
* thermistor reads as a low temperature, the firmware will keep the heater on.
*
* If you get "Thermal Runaway" or "Heating failed" errors the
* details can be tuned in Configuration_adv.h
*/
#define THERMAL_PROTECTION_HOTENDS // Enable thermal protection for all extruders
#define THERMAL_PROTECTION_BED // Enable thermal protection for the heated bed
----------

Os ajustes de tempo de espera, faixa de temperatura e histerese tanto para mesa quanto hotend são considerados
avançados e ficam no arquivo `Configuration_adv.h`. São bons defaults, não se aconselha mudá-los a não ser que
estejam acontecendo falsos positivos -- e se for o caso, vale a pena dar uma revisada na eletrônica.

No smoothie, basta colocar um valor de tempo de espera diferente zero no ajuste
temperature_control.__module_name__.runaway_heating_range, onde _module_name_ é o nome do módulo do aquecedor,
como _hotend_ ou __bed__.

[NOTE]
.Para saber mais sobre PID, PWM e aquecimento:
====
* Para saber sobre a teoria de PID, o site brasileiro _embarcados_
apresenta uma série de artigos interessantes e profundos, a começar por esse:
https://www.embarcados.com.br/controle-pid-em-sistemas-embarcados/[_https://www.embarcados.com.br/controle-pid-em-sistemas-embarcados/_]
* A referência do site _reprap_ sobre afinação de PID é a mais conhecida:
http://reprap.org/wiki/PID_Tuning[_http://reprap.org/wiki/PID_Tuning_]
* O
wiki do Repetier Firmware explica em profundidade os ajustes de controle de temperatura:
https://github.com/repetier/Repetier-Firmware/wiki/Temperature-control[_https://github.com/repetier/Repetier-Firmware/wiki/Temperature-control_]
* O manual do Smoothieware também tem uma explicação ricamente ilustrada
sobre o assunto, incluindo como lida com o descontrole térmico e como calibrá-lo:
http://smoothieware.org/temperaturecontrol[_http://smoothieware.org/temperaturecontrol_]
* Se realmente não for
desejável ou possível usar PWM/PID, como no caso de uso de um relé mecânico na mesa, existe nos firmwares um
ajuste de _histerese_ para o modo bang-bang que adiciona um atraso que pode tornar a curva mais suave.
* O blog
da _Prusa Research_ tem dicas de o que fazer para evitar descontrole térmico por causas eletrônicas e mecânicas:
http://help.prusa3d.com/mk2-electronics/thermal-runaway-and-temperature-drops[_http://help.prusa3d.com/mk2-electronics/thermal-runaway-and-temperature-drops_].
====

== Extensões e derivações da tecnologia FFF

A este ponto o leitor já deve ter percebido que graças aos firmwares, eletrônicas e projetos disponibilizados
pelo projeto reprap e seus voluntários, a tecnologia de impressão 3D é bem adaptável. Devido a seus componentes
substituíveis, aos firmwares flexíveis, profundamente configuráveis e lotados de recursos e aos protocolos
praticamente universais utilizados, trocar ou fazer sua versão de qualquer parte da e uma impressora 3D é uma
tarefa fácil até mesmo pra amadores. Na verdade, até parte do próprio processo de configuração da impressora
pode envolver isso, como na calibração de uma delta em que muitas vezes se usa uma caneta ou lápis no extrusor
antes de inserir o hotend, já que fica mais fácil achar desníveis microscópicos pela força dos traços no papel.

[[calibrarostockcaneta]]
image::calibrarostockcaneta.png[calibrarostockcaneta,width=642,height=451,align="center",title="Processo de calibração de uma delta (Rostock) usando uma caneta para achar o problema. https://www.youtube.com/watch?v=zElA76ncTfc"]

Esse ecossistema open-source e "lego", que encoraja a criatividade e expressão, gera as mais variadas formas
de reprap. Outros exemplos criativos são a delta de 5 metros de altura da SeeMeCNC -- que é uma reprap enorme
usando a placa _RaMBo_ - e a impressora portátil "pendurável" de volume infinito, a HangPrinter.

[[deltagiganteehangprinter]]
image::deltagiganteehangprinter.png[deltagiganteehangprinter,width=642,height=409,align="center",title="Processo de calibração de uma delta (Rostock) usando uma caneta para achar o problema. https://www.youtube.com/watch?v=zElA76ncTfc"]

Tais curiosidades são demonstrativas do poder de mentes criativas e nem são realmente excepcionais -- acompanhar
notícias relacionadas a impressão 3D passa a nítida noção que a cada dia existe uma excentricidade nova ou um
jeito de usar a tecnologia que ninguém havia explorado antes. Não é pretensão desta obra, e nem conseguiríamos,
fazer um bom resumo de todo o potencial deste ecossistema. Ainda assim, há um tipo de modificação de impressoras
FFF que enseja variados tipos de impressora e que pode ser explorada mesmo gastando muito pouco: a troca do extrusor
de tração de plástico por um _extrusor de pasta_ - "paste extruder" em inglês. _Pasta_ é exatamente isto:
qualquer massa semi-sólida, geralmente formada pela mistura de ingredientes sólidos com um líquido. Um dos
primeiros extrusores de pasta _universais_ usados em maior escala foi criado em 2012 pelo reprapper _RichRap_
(Richard Horne) e chamado de "Universal Paste Extruder".

[[universalpasteextruder]]
image::universalpasteextruder.png[universalpasteextruder,width=642,height=319,align="center",title="O extrusor de pasta universal de RichRap. Ele é demonstrado imprimindo com água com açúcar, chocolate e cerâmica em sua página: https://www.thingiverse.com/thing:20733. A montagem é fácil e o extrusor é compatível com a guia do carro X de prusa e graber. O extrusor funciona com o motor governando um atuador linear que vai pressionando o êmbolo de uma seringa comum de 10ml."]

A idéia é boa, mas a primeira pergunta que vem à mente do leitor atento é o baixo volume da seringa -- apenas
10ml; se a "impressão" levar mais que isso, é preciso parar todo o conjunto, desmontar e reabastecer a seringa,
e montar novamente, tornando o processo bastante manual e propenso a falhas. Uma solução cara seria usar uma
mangueira peristáltica no extrusor. Existem outros problemas ainda, como pastas que solidificam tornando a extrusão
mais difícil ou parando; pastas que _não_ solidificam resultando em peças que colapsam na mesa de impressão;
limpeza do conjunto quando usar com comida; entupimento quando se usam pastas grossas (como cerâmica); falta de
aquecimento, limitando os materiais que se pode utilizar. E por aí vai... Uma alternativa ao extrusor do RichRap
que consegue trabalhar com aquecimento e controle de pressão -- mas tem montagem mais difícil - é o __Baricuda Extruder__,
o extrusor dos pesquisadores da universidade da Pensilvânia que permitiu criar vasos sanguíneos com
trilhas tridimensionais de açúcar: https://www.thingiverse.com/thing:26343[_https://www.thingiverse.com/thing:26343_]

Mas, ainda assim, a idéia é promissora, e não faltam iniciativas comerciais que as exploram de uma forma ou
outra. Um exemplo é a impressora multi-extrusores Tytan 3D, que tem uma versão de extrusor de pasta em bowden
com tanque para até 10l de cerâmica.

[[tyttan3dceramica]]
image::tyttan3dceramica.png[tyttan3dceramica,width=642,height=373,align="center",title="Impressora Tyttan 3D com o extrusor de cerâmica. Fonte: http://www.3ders.org/articles/20150630-poland-tytan-3d-unveils-the-gaia-multitool-maxx-3d-printer-with-10-interchangeable-heads.html"]

Outro exemplo notável, este mais prático para o hobbyista, é a empresa italiana Open Electronics, que comercializa
um extrusor aquecido com seringa de 60ml que pode ser montado em qualquer reprap:

[[extrusor3dchoco]]
image::extrusor3dchoco.jpeg[extrusor3dchoco,width=642,height=389,align="center",title="O 3DChoco, extrusor open-source aquecido (chega até 60°) para pastas como chocolate quente e outras pastas de baixa temperatura. https://store.open-electronics.org/3DCHOCO"]

Do mesmo modo que encontramos empreendimentos comerciais que usam essa criatividade para contribuir com o
ecossistema aberto, entanto, também existem os parasitas que desejam achar nela um ponto de vantagem para
fechamento, delimitação e controle de mercado, principalmente através do mecanismo de patentes -- aprendizes
de Stratasys, por assim dizer. Um exemplo notável é a impressora __MarkForged Mark Two__, que imprime em nylon
entremeado com uma linha de fibra de carbono^1^. Outro modo frequente é tentar seduzir o usuário menos técnico
com uma "facilidade" que envolve sequestro do controle, com um exemplo famoso sendo a linha de impressoras FFF
_Cube_ da 3D Systems que usa cartuchos de filamento plástico proprietário, que permite a troca de modo fácil e
automático e até com previsão de término do material. Felizmente foi uma estratégia que falhou pateticamente,
tanto por saudável concorrência do mercado de outros fabricantes de impressoras 3D quanto pelo surgimento de
dispositivos, como o brasileiro __Cube3DFree__^2^, que permitiam evadir o chip detector e usar filamentos comuns
de mercado. Isso é um lembrete que o risco de perdas de liberdade, controle e progresso tecnológico está sempre
presente, e por isso é essencial sempre buscar conscientizar __maker__s, usuários e consumidores de tecnologia.

Essa liberdade de criação não deixou de ser aproveitada por outros ramos do conhecimento científico, em especial
os ramos da biologia e medicina. O extrusor open-source _Baricuda_ mencionado, usado em aplicações biomédicas,
é um exemplo incipiente do surgimento um campo ainda experimental mas em rápido progresso: as __bioimpressoras__.

[NOTE]
.Notas:
====
. https://www.youtube.com/watch?v=ClLW4Ti5kQ4[_https://www.youtube.com/watch?v=ClLW4Ti5kQ4_] tem a avaliação
de Thomas Sanladerer da impressora 3D da MarkForged. Sem dúvida, essa impressora 3D seria muito útil para ajudar
no problema de impressão de próteses de membros inferiores, por exemplo, razão pela qual o GPMA do Instituto
Tecnológico da Aeronáutica brasileiro a adquiriu. No entanto, sua patente impede que alternativas surjam e o
preço fique acessível, e a tecnologia fica novamente aprisionado por 20 anos antes que possa ser utilizada pelas
massas e se beneficiar da _frictionless innovation_ e da criatividade de muitas mentes pensantes. A situação
é tão grave que aos 12min30s do vídeo, Tom, uma pessoa contida e normalmente estritamente técnica, reclama da
impossibilidade de melhorar e popularizar a impressora devido às patentes sobre sua tecnologia e dá um educativo
sermão contra as patentes e outros bloqueios em geral.
. https://www.cube3dfree.com/[_https://www.cube3dfree.com/_]. Parabéns aos empreendedores que trabalham para
melhorar a vida das pessoas!
====

=== A BioImpressão 3D

A impressora 3D FFF nada mais é que um braço robótico que movimenta um cursor em coordenadas arbitrárias de
um volume tridimensional, este cursor tendo o extrusor que conhecemos, seja o extrusor de plástico, a seringa
de pasta ou qualquer outro dispositivo. Já vimos a mecânica e a eletrônica dessa parte e sabemos que não é
exatamente _simples_ -- mas também está longe de ser tecnologia de ponta: todo o material pra construí-la está
prontamente disponível no site reprap, a teoria que a sustenta é convencional e lecionada em universidades nos
cursos de mecatrônica, engenharia elétrica, computação, física e outros.

Uma das extensões e aplicações mais promissoras da idéia de impressão 3D, no entanto, tem muito maior relação
com o realmente novo e inexplorado. É a assim batizada __bioimpressão 3D__, ou simplesmente __bioimpressão__:
a idéia de utilizar __material vivo__, na forma de tecidos biológicos ou culturas de células, para criar ou
alterar órgãos, sistemas e estruturas tridimensionais.

[[umabioimpressora]]
image::umabioimpressora.png[umabioimpressora,width=602,height=551,align="center",title="Uma bioimpressora 3D. Fonte: https://en.wikipedia.org/wiki/3D_bioprinting"]

E é __aí__, no **extrusor**, que reside a maior dificuldade. Em como conter, tracionar, conservar e encapsular esse
material biológico, incluindo células e biomoléculas. Não é qualquer matéria-prima: não se pode simplesmente
espirrar um jato de células em cima de uma mesa como se faz com o plástico derretido e esperar que dê certo. Mesmo
envoltas por um gel de sustentação, não formarão estrutura, colapsando sobre seu peso; mesmo formando estrutura,
não terão condições fisiológicas que as permitam sobreviver, nem os vasos e as estruturas intracelulares que
possibilitem tais condições; e mesmo tendo vasos e capilares para as trocas gasosas, alimentação e excreção
e uma matriz extracelular de sustentação e ligação, não terão os complexos e diversos gradientes químicos
e mensageiros moleculares que lhes dão as sinalizações que lhes permitem definir a posição que ocupam e
portanto como devem se desenvolver; e até a orientação que terão, como no caso de fibras musculares, faz
diferença. E além disso, muitos fatores ambientais têm que ser estritamente controlados como esterilização,
biocompatibilidade dos componentes, vedação, pressão, temperatura, umidade, gases dissolvidos, etc., com sensores
para medir e componentes ativos como aquecedores e desumidificadores para tornar os índices adequados. Não só
no extrusor: a "mesa" ou recipiente em que a forma é lentamente traçada também. As preocupações não
param por aí: material vivo está em constante "movimento", com metabolismo e deslocamentos físicos sendo
parte de seu funcionamento. Uma bioimpressão que usasse de camadas superpostas como as FFF, demorando horas pra
completar, teria que conter o movimento, ou lidar com ele de alguma forma, para a viabilidade da peça final. As
complexidades disso são grandes e envolvem também o modo pelos quais as células se movem na direção de outras
com aderência similar para criar estruturas estáveis; este resultado deve ser simulado para assegurar que o
procedimento computadorizado se adequará ao desejado.

Ainda existe o problema de criar modelos biológicos adequados -- seja por meio de escaneamento, biópsia, tomografia
computadorizada, ressonância magnética, modelagem ou uma combinação de métodos. Então, a partir disso e
com estimativas dos materiais, separar os tipos de células a serem utilizados e preparar o agregado com o gel ou
biomateriais, para disponibilizar para o extrusor. Essa etapa é a __pré-bioimpressão__. A _pós-bioimpressão_
trata do processo de manter a forma biológica viva, em desenvolvimento e com integridade, possivelmente com
estimulações químicas e mecânicas.

Claro, raramente será necessário resolver todos esse problemas de uma vez -- o extrusor _baricuda_ tendo apenas
aquecimento e trabalhando com água e açúcar constrói um arcabouço biodegradável que é naturalmente utilizado
pelos processos celulares da cultura com que é envolto para a formação e desenvolvimento de vasos e capilares,
e só isso já representa um salto de possibilidades em relação ao que se tinha antes.

==== Biotinta

O material que se usa em uma bioimpressora 3D tem o nome em inglês de **BioInk**, ou *Biotinta* em português. Não
somente por analogia com a tinta utilizada em impressoras 2D de escritório, mas pode-se dizer que o nome "pegou"
também por seu histórico: as microscópicas gotas de tinta de impressoras a jato de tinta são aproximadamente
do tamanho de células -- em especial, de células humanas (perto de 10 µm). E o método de entrega de tinta de
impressoras como as __Canon__, "Thermal DoD" (gotícula sob demanda térmica) cria uma corrente que aquece
uma unidade, gerando uma bolha que propele a "tinta" de células no substrato. Este método, iniciado pelo
cientista Makoto Nakamura^1^, foi tão efetivo que hoje já existem tutoriais de internet ensinando a transformar
sua impressora de jato de tinta em bioimpressora.^2^

Uma estratégia básica de lidar com biotintas é ter dois materiais: um de estruturação e proteção e o outro
com as células vivas. Um extrusor especial despeja as gotículas celulares por um bico enquanto extrusa o material
protetor (geralmente um hidrogel compósito, como alginato misturado com gelatina) em volta.

[[biotintagraf1]]
image::biotintagraf1.png[biotintagraf1,width=606,height=463,align="center"title="Exemplo de um tipo de extrusor usado em bioimpressão. As células são dispensadas por **Thermal DoD** enquanto o hidrogel de sustentação é extrusado em volta."]

No estágio atual da bioimpressão 3D, temos iniciativas open-source como a bioimpressora 3D __**Renegade**__ da
empresa Ourobotics, assim como alguns projetos menores de equipamentos semelhantes de cunho biológico^3^. No
campo mais industrial, a empresa *Organovo* tem feito bastante incursões na bioimpressão 3D com tecnologias de
tecidos e impressão de órgãos, como rins e fígado, além da impressão de tumores sob demanda, para testes
farmacológicos ágeis. É difícil limitar as possíveis aplicações da bioimpressão 3D. Christopher Barnatt
mostra em seu vídeo possibilidades verossímeis que assustam^4^, como a utilização em cirurgias plásticas:
bioimpressoras acopladas ao rosto rapidamente evaporariam pele antiga para imprimir pele nova no formato desejado,
como um rosto baixado da internet, ou o escaneamento 3D do rosto da mesma pessoa quando mais jovem. Outras
bioimpressoras poderiam ter extrusores cirúrgicos que penetram o corpo e poderiam imprimir órgãos __in situ__,
fazendo as conexões nervosas e sanguíneas durante o próprio processo de impressão. É muito fácil ser perder
na imaginação, e para o leitor curioso, separamos alguns links que certamente serão úteis, incluindo um curso
completo de bioimpressão com diploma (em inglês) pela net^5^.

[NOTE]
.Notas:
====
. O professor Makoto Nakamura é conhecido por ter dado a "ignição" em toda a idéia de
bioimpressão, com vários artigos científicos publicados sobre o assunto. Para facilitar o acesso, o texto
completo de um de seus artigos de alto impacto que melhor resumem as técnicas está disponível neste endereço,
http://ijb.whioce.com/index.php/int-j-bioprinting/article/view/01007[_http://ijb.whioce.com/index.php/int-j-bioprinting/article/view/01007_].
O artigo também é valioso por ter em suas referências vários outros artigos seminais para a compreensão do
problema, incluindo outros do próprio Nakamura. Em padrão APA de citação: Nakamura, M., Mir, T. A., Arai, K.,
Ito, S., Yoshida, T., Iwanaga, S., ... & Nikaido, T. (2015). Bioprinting with pre-cultured cellular constructs
towards tissue engineering of hierarchical tissues. __International Journal of Bioprinting__, __1__(1).
. http://www.instructables.com/id/DIY-BioPrinter/[_http://www.instructables.com/id/DIY-BioPrinter/_]
. Notícia com explicações e links da Renegade:
http://www.3ders.org/articles/20160204-ourobotics-releases-completely-open-source-renegade-3d-bioprinter.html[_http://www.3ders.org/articles/20160204-ourobotics-releases-completely-open-source-renegade-3d-bioprinter.html_].
Além dela, um projeto com bastante abertura e API para comunicação com um _robô de pipetagem_ que pode ser
transformado em bioimpressora é o opentrons, https://opentrons.com/[_https://opentrons.com/_] com código no
github em https://github.com/OpenTrons[_https://github.com/OpenTrons_]. Na parte de monitoramento e manutenção de
variáveis biológicas, o Farmbot é outro exemplo open-source: https://farmbot.io/[_https://farmbot.io/_]. Não são
bioimpressoras 3D completas mas são projetos de cunho biológico que têm os elementos necessários para formarem.
. http://explainingthefuture.com/video_bioprinting.html[_http://explainingthefuture.com/video_bioprinting.html_]
e https://3dprint.com/93097/bioprinting-3d/[_https://3dprint.com/93097/bioprinting-3d/_]
. o curso de bioimpressão fala também sobre materiais biológicos e biocompatíveis em impressoras 3D
comuns, é gratuito se o aluno fizer no tempo reservado e não precisar de diploma. E é barato se quiser não
só o diploma, mas que fique acessível a qualquer momento. É dado pelo famoso site educacional __FutureLearn__:
https://www.futurelearn.com/courses/bioprinting/[_https://www.futurelearn.com/courses/bioprinting/_]..
====
